@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using WileyWidget.Models
@using WileyWidget.Services.Abstractions
@using static WileyWidget.Models.ChatMessage
@using Syncfusion.Blazor
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using CommunityToolkit.Mvvm.Input
@implements IDisposable
@inject IChatBridgeService ChatBridge
@inject IJSRuntime JS
@inject IUserContext UserContext

<div class="jarvis-container">
    <div class="chat-messages" role="log" aria-live="polite" aria-label="Chat messages">
        @foreach (var msg in _messages)
        {
            <div class="message @(msg.IsUser ? "message-user" : "message-assistant")">
                <div class="message-avatar">
                    <div class="avatar @(msg.IsUser ? "avatar-user" : "avatar-assistant")">
                        @(msg.IsUser ? GetUserInitials() : "JA")
                    </div>
                </div>
                <div class="message-bubble">
                    <div class="message-content">@msg.Content</div>
                    @if (msg.Timestamp > DateTime.MinValue)
                    {
                        <div class="message-timestamp">@msg.Timestamp.ToString("hh:mm tt")</div>
                    }
                </div>
            </div>
        }
        @if (_isThinking)
        {
            <div class="message message-assistant">
                <div class="message-avatar">
                    <div class="avatar avatar-assistant">JA</div>
                </div>
                <div class="message-bubble typing-indicator">
                    <span></span><span></span><span></span>
                </div>
            </div>
        }
    </div>

    <div class="chat-footer">
        <SfTextArea @bind-Value="_userInput"
                    Placeholder="Ask JARVIS anything..."
                    Rows="3"
                    aria-label="Message input"
                    @onkeyup="HandleKeyUp"
                    class="message-input"></SfTextArea>
        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="error-message" role="alert" aria-live="assertive">
                <i class="error-icon">⚠️</i> @_errorMessage
            </div>
        }
        <div class="button-group">
            <SfButton @onclick="SendMessageAsync"
                      Disabled="@(string.IsNullOrWhiteSpace(_userInput) || _isThinking || _isSending)"
                      IconCss="e-icons e-send"
                      CssClass="send-button"
                      Title="Send message (Shift+Enter for newline)">
                <span class="button-icon">▶</span> Send
            </SfButton>
        </div>
    </div>
</div>

<style>
    .jarvis-container {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: 100%;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        color: #333333;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: linear-gradient(to bottom, #ffffff, #f8f9fa);
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: linear-gradient(to bottom, #007bff, #0056b3);
        border-radius: 10px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: linear-gradient(to bottom, #0056b3, #003d82);
    }

    .message {
        display: flex;
        gap: 12px;
        margin-bottom: 8px;
        animation: slideIn 0.3s ease-out;
    }

    @@keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-user {
        justify-content: flex-end;
    }

    .message-user .message-avatar {
        order: 2;
    }

    .message-user .message-bubble {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-bottom-right-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3);
    }

    .message-assistant {
        justify-content: flex-start;
    }

    .message-assistant .message-bubble {
        background: linear-gradient(135deg, #e9ecef 0%, #f8f9fa 100%);
        color: #333;
        border-bottom-left-radius: 4px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 16px;
        word-wrap: break-word;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }

    .message:hover .message-bubble {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }

    .message-content {
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        margin-bottom: 4px;
    }

    .message-timestamp {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 4px;
    }

    .message-avatar {
        flex-shrink: 0;
    }

    .avatar {
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 14px;
        color: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
    }

    .avatar-user {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    }

    .avatar-assistant {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }

    .typing-indicator {
        display: flex !important;
        gap: 4px;
        align-items: center;
        padding: 12px 16px;
    }

    .typing-indicator span {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #999;
        animation: typeBounce 1.4s infinite;
    }

    .typing-indicator span:nth-child(2) {
        animation-delay: 0.2s;
    }

    .typing-indicator span:nth-child(3) {
        animation-delay: 0.4s;
    }

    @@keyframes typeBounce {
        0%, 60%, 100% {
            transform: translateY(0);
            opacity: 0.7;
        }
        30% {
            transform: translateY(-10px);
            opacity: 1;
        }
    }

    .chat-footer {
        display: flex;
        flex-direction: column;
        padding: 12px;
        gap: 12px;
        background: white;
        border-top: 1px solid #dee2e6;
        box-shadow: 0 -1px 3px rgba(0, 0, 0, 0.05);
    }

    .message-input {
        border-radius: 20px !important;
        border: 2px solid #e0e0e0 !important;
        padding: 12px 20px !important;
        font-size: 14px !important;
        transition: all 0.3s ease !important;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
        resize: none !important;
    }

    .message-input:focus {
        border-color: #007bff !important;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1) !important;
        outline: none !important;
    }

    .message-input::placeholder {
        color: #999;
    }

    .error-message {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px 12px;
        background: linear-gradient(135deg, #fff3cd 0%, #ffe6e6 100%);
        border: 1px solid #ffc107;
        border-radius: 8px;
        color: #856404;
        font-size: 13px;
        animation: slideDownError 0.3s ease-out;
    }

    .error-icon {
        font-size: 16px;
        flex-shrink: 0;
    }

    @@keyframes slideDownError {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .button-group {
        display: flex;
        gap: 8px;
        align-items: center;
    }

    .send-button {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        border: none !important;
        border-radius: 20px !important;
        padding: 10px 24px !important;
        font-weight: 600 !important;
        color: white !important;
        cursor: pointer !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3) !important;
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
    }

    .send-button:hover:not(:disabled) {
        background: linear-gradient(135deg, #0056b3 0%, #003d82 100%) !important;
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.4) !important;
        transform: translateY(-2px) !important;
    }

    .send-button:active:not(:disabled) {
        transform: translateY(0) !important;
        box-shadow: 0 1px 2px rgba(0, 123, 255, 0.3) !important;
    }

    .send-button:disabled {
        opacity: 0.6 !important;
        cursor: not-allowed !important;
    }

    .button-icon {
        font-size: 16px;
    }

    @@media (max-width: 768px) {
        .message-bubble {
            max-width: 90%;
        }

        .message-input {
            max-height: 80px !important;
        }

        .send-button {
            padding: 8px 16px !important;
            font-size: 13px !important;
        }
    }

    @@media (prefers-color-scheme: dark) {
        .jarvis-container {
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d2d 100%);
        }

        .chat-messages {
            background: linear-gradient(to bottom, #262626, #1f1f1f);
        }

        .message-input {
            background: #333 !important;
            color: white !important;
            border-color: #555 !important;
        }

        .message-input::placeholder {
            color: #777;
        }

        .message-assistant .message-bubble {
            background: linear-gradient(135deg, #333 0%, #2d2d2d 100%);
            color: #e0e0e0;
        }

        .chat-footer {
            background: #262626;
            border-top-color: #444;
        }
    }
</style>

@code {
    private List<ChatMessage> _messages = new();
    private string _userInput = string.Empty;
    private string _errorMessage = string.Empty;
    private bool _isThinking;
    private bool _isSending;
    private string? _streamingMessageId;
    private string? _conversationId;
    private CancellationTokenSource? _cts;
    private DateTime _lastRenderTime = DateTime.MinValue;
    private readonly TimeSpan _renderThrottle = TimeSpan.FromMilliseconds(50);

    protected override async Task OnInitializedAsync()
    {
        ChatBridge.OnMessageReceived += HandleMessageReceived;
        ChatBridge.ResponseChunkReceived += HandleResponseChunkReceived;
        ChatBridge.ExternalPromptRequested += HandleExternalPromptRequested;
        _conversationId = Guid.NewGuid().ToString();

        await base.OnInitializedAsync();
    }

    private async Task SendMessageAsync()
    {
        if (string.IsNullOrWhiteSpace(_userInput) || _isThinking || _isSending)
            return;

        // Validation
        if (_userInput.Length > 2000)
        {
            _errorMessage = "Message is too long. Maximum 2000 characters.";
            StateHasChanged();
            return;
        }

        var sanitizedInput = _userInput.Trim();
        if (string.IsNullOrEmpty(sanitizedInput))
            return;

        _isSending = true;
        _errorMessage = "";

        // Add user message
        var userMsg = new ChatMessage
        {
            Id = Guid.NewGuid().ToString(),
            Content = sanitizedInput,
            IsUser = true,
            Timestamp = DateTime.Now
        };
        _messages.Add(userMsg);

        var prompt = sanitizedInput;
        _userInput = "";
        _isThinking = true;
        _streamingMessageId = null;

        ThrottledStateHasChanged();
        await ScrollToBottom();

        _cts = new CancellationTokenSource();
        _cts.CancelAfter(TimeSpan.FromMinutes(5));

        try
        {
            await ChatBridge.SubmitPromptAsync(prompt, _conversationId);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error sending message: {ex.Message}";
            _isThinking = false;
            ThrottledStateHasChanged();
        }
        finally
        {
            _isSending = false;
            _cts?.Dispose();
            _cts = null;
        }
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessageAsync();
        }
    }

    private void HandleMessageReceived(object? sender, ChatMessage msg)
    {
        _ = InvokeAsync(async () =>
        {
            if (msg == null)
                return;

            var assistantMsg = new ChatMessage
            {
                Id = msg.Id ?? Guid.NewGuid().ToString(),
                Content = msg.Content,
                IsUser = false,
                Timestamp = DateTime.Now
            };
            _messages.Add(assistantMsg);

            _isThinking = false;
            _streamingMessageId = null;
            ThrottledStateHasChanged();
            await ScrollToBottom();
        });
    }

    private void HandleResponseChunkReceived(object? sender, ChatResponseChunkEventArgs e)
    {
        _ = InvokeAsync(async () =>
        {
            if (string.IsNullOrEmpty(_streamingMessageId))
            {
                _streamingMessageId = Guid.NewGuid().ToString();
                var placeholderMsg = new ChatMessage
                {
                    Id = _streamingMessageId,
                    Content = e.Chunk,
                    IsUser = false,
                    Timestamp = DateTime.Now
                };
                _messages.Add(placeholderMsg);
            }
            else
            {
                var existingMsg = _messages.FirstOrDefault(m => m.Id == _streamingMessageId);
                if (existingMsg != null)
                {
                    existingMsg.Content += e.Chunk;
                }
            }

            ThrottledStateHasChanged();
            await ScrollToBottom();
        });
    }

    private void HandleExternalPromptRequested(object? sender, ChatExternalPromptEventArgs e)
    {
        _ = InvokeAsync(async () =>
        {
            if (string.IsNullOrEmpty(e.Prompt) || _isSending)
                return;

            _userInput = e.Prompt;
            await SendMessageAsync();
        });
    }

    private void ThrottledStateHasChanged()
    {
        var now = DateTime.UtcNow;
        if ((now - _lastRenderTime) > _renderThrottle)
        {
            _lastRenderTime = now;
            StateHasChanged();
        }
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", "window.scrollTo(0, document.body.scrollHeight)");
        }
        catch
        {
            // Silently handle if scroll unavailable
        }
    }

    private string GetUserInitials()
    {
        var displayName = UserContext?.DisplayName ?? "You";
        if (string.IsNullOrEmpty(displayName))
            return "U";

        var parts = displayName.Split(' ');
        return parts.Length > 1
            ? $"{parts[0][0]}{parts[^1][0]}".ToUpper()
            : $"{parts[0][0]}".ToUpper();
    }

    public void Dispose()
    {
        ChatBridge.OnMessageReceived -= HandleMessageReceived;
        ChatBridge.ResponseChunkReceived -= HandleResponseChunkReceived;
        ChatBridge.ExternalPromptRequested -= HandleExternalPromptRequested;

        _cts?.Cancel();
        _cts?.Dispose();
    }
}
