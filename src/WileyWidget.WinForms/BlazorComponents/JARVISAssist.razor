@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using WileyWidget.Models
@using WileyWidget.Services.Abstractions
@using static WileyWidget.Models.ChatMessage
@implements IDisposable
@inject IChatBridgeService ChatBridge
@inject IJSRuntime JS

<div class="jarvis-container">
    <div class="messages" @ref="_messageContainer">
        @foreach (var msg in _messages)
        {
            <div class="message @(msg.IsUser ? "user" : "assistant")">
                <div class="message-content">
                    @msg.Content
                </div>
            </div>
        }
        @if (_isThinking)
        {
            <div class="message assistant thinking">
                <div class="typing-indicator">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        }
    </div>

    <div class="input-area">
        <textarea @bind="_userInput"
                  @onkeyup="HandleKeyUp"
                  placeholder="Ask JARVIS anything..."
                  disabled="@_isThinking"></textarea>
        <button @onclick="SendMessage" disabled="@(string.IsNullOrWhiteSpace(_userInput) || _isThinking)">
            Send
        </button>
    </div>
</div>

<style>
    .jarvis-container {
        display: flex;
        flex-direction: column;
        height: 100vh;
        background: #1e1e1e;
        color: #d4d4d4;
        font-family: 'Segoe UI', sans-serif;
    }

    .messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }

    .message {
        margin-bottom: 15px;
        max-width: 80%;
        padding: 12px;
        border-radius: 8px;
        line-height: 1.5;
    }

    .message.user {
        align-self: flex-end;
        background: #007acc;
        color: white;
        margin-left: auto;
    }

    .message.assistant {
        align-self: flex-start;
        background: #333;
        border: 1px solid #444;
    }

    .message.thinking {
        background: transparent;
        border: none;
    }

    .typing-indicator span {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #007acc;
        border-radius: 50%;
        margin-right: 5px;
        animation: blink 1.4s infinite both;
    }

    .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
    .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

    @@keyframes blink {
        0%, 80%, 100% { opacity: 0; }
        40% { opacity: 1; }
    }

    .input-area {
        padding: 20px;
        background: #252526;
        display: flex;
        gap: 10px;
    }

    textarea {
        flex: 1;
        background: #3c3c3c;
        border: 1px solid #333;
        color: white;
        padding: 10px;
        border-radius: 4px;
        resize: none;
        height: 60px;
    }

    button {
        background: #007acc;
        color: white;
        border: none;
        padding: 0 20px;
        border-radius: 4px;
        cursor: pointer;
    }

    button:disabled {
        background: #444;
        cursor: not-allowed;
    }
</style>

@code {
    private string _userInput = "";
    private bool _isThinking = false;
    private List<ChatMessage> _messages = new();
    private ElementReference _messageContainer;
    private string _conversationId = Guid.NewGuid().ToString();

    protected override void OnInitialized()
    {
        ChatBridge.OnMessageReceived += HandleMessageReceived;
        _messages.Add(new ChatMessage { Content = "Hello, I am JARVIS. How can I assist you today?", IsUser = false });
    }

    private void HandleMessageReceived(object? sender, ChatMessage msg)
    {
        InvokeAsync(() => {
            if (!_messages.Any(m => m.Id == msg.Id))
            {
                _messages.Add(msg);
                _isThinking = false;
                StateHasChanged();
                ScrollToBottom();
            }
            else
            {
                var existing = _messages.First(m => m.Id == msg.Id);
                existing.Content = msg.Content;
                StateHasChanged();
                ScrollToBottom();
            }
        });
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(_userInput)) return;

        var userMsg = new ChatMessage { Content = _userInput, IsUser = true, Id = Guid.NewGuid().ToString() };
        _messages.Add(userMsg);
        var prompt = _userInput;
        _userInput = "";
        _isThinking = true;

        StateHasChanged();
        ScrollToBottom();

        await ChatBridge.SubmitPromptAsync(prompt, _conversationId);
    }

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey)
        {
            await SendMessage();
        }
    }

    private void ScrollToBottom()
    {
        JS.InvokeVoidAsync("scrollToBottom", _messageContainer);
    }

    public void Dispose()
    {
        ChatBridge.OnMessageReceived -= HandleMessageReceived;
    }
}
