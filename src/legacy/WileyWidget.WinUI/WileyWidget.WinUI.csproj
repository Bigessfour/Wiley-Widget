<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net9.0-windows10.0.22621.0</TargetFramework>
    <TargetPlatformMinVersion>10.0.17763.0</TargetPlatformMinVersion>
    <!-- WindowsAppSDK 1.6 requires SupportedOSPlatformVersion for proper SDK alignment -->
    <SupportedOSPlatformVersion>10.0.22621.0</SupportedOSPlatformVersion>
    <!-- RegFree COM initialization for unpackaged WinUI 3 apps -->
    <WindowsAppSDKUndockedRegFreeWinRTInitialize>true</WindowsAppSDKUndockedRegFreeWinRTInitialize>
    <XamlDebuggingInformation>Full</XamlDebuggingInformation>
    <!-- Updated to match Windows SDK 22621 required by Windows App SDK 1.6 -->
    <WindowsSdkPackageVersion>10.0.22621.38</WindowsSdkPackageVersion>
    <WindowsSdkVersion>10.0.22621.0</WindowsSdkVersion>
    <!-- CRITICAL: UseWinUI must be true BEFORE WindowsAppSDK targets import -->
    <UseWinUI>true</UseWinUI>
    <!-- DISABLED: EnableXamlSourceGenerator conflicts with PublishAot in .NET 9 unpackaged (falls back to legacy XamlCompiler) -->
    <EnableXamlSourceGenerator>false</EnableXamlSourceGenerator>
    <!-- ============================================================
         CRITICAL WinUI 3 UNPACKAGED CONFIGURATION
         These properties MUST be set before targets import
         ============================================================ -->
    <!-- Self-contained deployment to include all WindowsAppSDK runtime assets -->
    <WindowsAppSDKSelfContained>true</WindowsAppSDKSelfContained>
    <!-- DeploymentManager is ONLY for packaged apps - disable for unpackaged -->
    <WindowsAppSDKDeploymentManagerInitialize>false</WindowsAppSDKDeploymentManagerInitialize>
    <!-- Bootstrap auto-initializer handles unpackaged app initialization -->
    <WindowsAppSDKBootstrapInitialize>true</WindowsAppSDKBootstrapInitialize>
    <WindowsPackageType>None</WindowsPackageType>
    <!-- Unpackaged apps don't use AppX -->
    <AppxPackage>false</AppxPackage>
    <WindowsAppContainer>false</WindowsAppContainer>
    <!-- ============================================================
         ENHANCED XAML PROJECTION SETTINGS FOR UNPACKAGED APPS
         These improve XAML compilation and native projection resolution
         ============================================================ -->
    <!-- Enable projection generation without full MSIX packaging -->
    <EnablePreviewMsixTooling>true</EnablePreviewMsixTooling>
    <!-- Generate temporary certificate for development signing -->
    <GenerateTemporaryStoreCertificate>true</GenerateTemporaryStoreCertificate>
    <!-- Force XBF generation for better diagnostics and error messages -->
    <DisableXbfGeneration>false</DisableXbfGeneration>
    <!-- Enhanced XAML compiler logging for troubleshooting -->
    <XamlCompilerArgs>/verbose /nologo</XamlCompilerArgs>
    <!-- ============================================================
         XAML COMPILATION SETTINGS FOR UNPACKAGED WINUI 3
         These enable proper XAML compilation without MSIX packaging
         ============================================================ -->
    <!-- Enable XAML metadata generation for unpackaged apps -->
    <XamlGenerateCompilerDeclarations>true</XamlGenerateCompilerDeclarations>
    <!-- Generate library layout and XAML type metadata required for unpackaged apps -->
    <GenerateLibraryLayout>true</GenerateLibraryLayout>
    <GenerateXamlMetadata>true</GenerateXamlMetadata>
    <GenerateXamlSourceInfo>true</GenerateXamlSourceInfo>
    <!-- Ensure XAML compiler uses correct targets from WindowsAppSDK -->
    <XamlSavedStateFileName>"$(IntermediateOutputPath)$(MSBuildProjectName).xamlstate"</XamlSavedStateFileName>
    <!-- Enable detailed XAML diagnostics and verbose logging -->
    <XamlCodeGenerationControlFlags>EnableXBindDiagnostics;Verbose</XamlCodeGenerationControlFlags>
    <!-- SO best practice: Ensure proper path handling for spaces in directory names -->
    <UseCommonOutputDirectory>false</UseCommonOutputDirectory>
    <!-- Workaround for known WindowsAppSDK 1.6.x/1.7.x telemetry assembly issue -->
    <DisableRemovePayloadDuplicatesTask>true</DisableRemovePayloadDuplicatesTask>
    <RootNamespace>WileyWidget.WinUI</RootNamespace>
    <ApplicationManifest>app.manifest</ApplicationManifest>
    <Platforms>x64</Platforms>
    <RuntimeIdentifiers>win-x64</RuntimeIdentifiers>

    <UseWPF>false</UseWPF>
    <!-- Non-packaged build configuration (no MSIX) -->
    <EnableMsixTooling>false</EnableMsixTooling>
    <!-- Prevent MSBuild targets from adding MSIX/Appx capabilities to this project -->
    <DisableMsixProjectCapabilityAddedByProject>true</DisableMsixProjectCapabilityAddedByProject>
    <!-- Allow XAML metadata generation even without PRI -->
    <GenerateAppInstallerFile>false</GenerateAppInstallerFile>
    <AppxAutoIncrementPackageRevision>false</AppxAutoIncrementPackageRevision>
    <GenerateTestArtifacts>false</GenerateTestArtifacts>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <LangVersion>latest</LangVersion>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <ProduceReferenceAssembly>true</ProduceReferenceAssembly>
    <!-- Manual AssemblyInfo.cs used for custom attributes -->
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <NoWarn>NU1902;NU1903</NoWarn>

    <!-- Industry best practice: Enable XAML validator to check obj\xaml-validator.log for errors -->
    <RunXamlValidator>true</RunXamlValidator>
  </PropertyGroup>

  <!-- Ensure the XAML generator doesn't insert Debugger.Break regardless of configuration -->
  <PropertyGroup>
    <DefineConstants>$(DefineConstants);DISABLE_XAML_GENERATED_BREAK_ON_UNHANDLED_EXCEPTION</DefineConstants>
  </PropertyGroup>

  <!-- Debug-specific XAML diagnostics -->
  <PropertyGroup Condition="'$(Configuration)'=='Debug'">
    <!-- Enable richer XAML debug info so diagnostics can create input.json/output.json and full trace -->
    <XamlDebuggingInformation>Full</XamlDebuggingInformation>
    <EnableXamlGeneratorDebugging>true</EnableXamlGeneratorDebugging>
    <!-- For unpackaged runs we still want generated metadata available -->
    <GenerateXamlMetadata>true</GenerateXamlMetadata>
    <!-- New in WinAppSDK / XAML tooling 1.8.x â€” increases compiler verbosity to Diagnostic -->
    <XamlCompilerVerbosity>Diagnostic</XamlCompilerVerbosity>

    <!-- ENHANCED: Force XamlCompiler error output capture (GitHub issue #10027 workaround) -->
    <XamlSaveGeneratedSources>true</XamlSaveGeneratedSources>
    <XamlGeneratedOutputPath>$(IntermediateOutputPath)XamlGenerated\</XamlGeneratedOutputPath>
    <XamlLogVerbosity>Diagnostic</XamlLogVerbosity>
    <XamlCodeGenerationControlFlags>EnableXBindDiagnostics;Verbose</XamlCodeGenerationControlFlags>
    <XamlCompilerStandardErrorImportance>High</XamlCompilerStandardErrorImportance>
    <XamlCompilerStandardOutputImportance>High</XamlCompilerStandardOutputImportance>
  </PropertyGroup>

  <!-- XAML Files: Let SDK auto-handle Application and Page includes -->
  <ItemGroup>
    <!-- Include Package.appxmanifest for metadata but don't build it (WindowsPackageType=None) -->
    <None Include="Package.appxmanifest">
      <CopyToOutputDirectory>Never</CopyToOutputDirectory>
    </None>
  </ItemGroup>

  <ItemGroup>
    <Content Include="Assets\**\*">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <!-- ====================================================================
         Windows App SDK and WinUI
         ====================================================================

         Package versions are managed centrally in Directory.Packages.props
         at the solution root. DO NOT add Version attributes here.

         âš ï¸ CRITICAL: Microsoft.WindowsAppSDK is LOCKED at 1.8.3 in CPM
         Versions 1.6.x/1.7.x have fatal telemetry bugs. DO NOT DOWNGRADE.
         ==================================================================== -->
    <PackageReference Include="Microsoft.Windows.SDK.BuildTools" />
    <PackageReference Include="Microsoft.Windows.CsWinRT" />
    <PackageReference Include="Microsoft.Web.WebView2" />
    <PackageReference Include="Microsoft.WindowsAppSDK" />
    <PackageReference Include="Microsoft.Windows.SDK.BuildTools.MSIX" />

    <!-- CommunityToolkit for MVVM and UI -->
    <PackageReference Include="CommunityToolkit.Mvvm" />
    <PackageReference Include="CommunityToolkit.WinUI.UI.Controls" />

    <!-- LiveCharts2 for charting (open-source, MIT license) -->
    <PackageReference Include="LiveChartsCore.SkiaSharpView.WinUI" />
    <!-- SkiaSharp native assets for proper XAML compilation and native projection resolution -->
    <PackageReference Include="SkiaSharp.NativeAssets.Win32" />
    <PackageReference Include="SkiaSharp.NativeAssets.WinUI" />

    <!-- Data Access -->
    <PackageReference Include="Microsoft.EntityFrameworkCore" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" />
    <PackageReference Include="Microsoft.Data.SqlClient" />

    <!-- Configuration and Hosting -->
    <PackageReference Include="Microsoft.Extensions.Configuration.EnvironmentVariables" />
    <PackageReference Include="Microsoft.Extensions.Configuration.UserSecrets" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" />
    <PackageReference Include="Microsoft.Extensions.Caching.Memory" />
    <PackageReference Include="Microsoft.Extensions.Hosting" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" />
    <PackageReference Include="Microsoft.Extensions.Http" />
    <PackageReference Include="Microsoft.Extensions.Logging" />
    <PackageReference Include="Microsoft.Extensions.Logging.Console" />
    <PackageReference Include="Microsoft.Extensions.Options" />

    <!-- Diagnostics and Health Checks -->
    <PackageReference Include="Microsoft.Extensions.Diagnostics.HealthChecks" />
    <PackageReference Include="Microsoft.Extensions.Diagnostics.HealthChecks.ResourceUtilization" />
    <PackageReference Include="Microsoft.Extensions.Diagnostics.HealthChecks.Common" />

    <!-- Logging -->
    <PackageReference Include="Serilog" />
    <PackageReference Include="Serilog.Extensions.Logging" />
    <PackageReference Include="Serilog.Enrichers.Environment" />
    <PackageReference Include="Serilog.Enrichers.Process" />
    <PackageReference Include="Serilog.Enrichers.Thread" />
    <PackageReference Include="Serilog.Settings.Configuration" />
    <PackageReference Include="Serilog.Sinks.Async" />
    <PackageReference Include="Serilog.Sinks.File" />

    <!-- Resilience -->
    <PackageReference Include="Polly" />
    <PackageReference Include="Polly.Extensions.Http" />
    <PackageReference Include="Microsoft.Extensions.Http.Resilience" />

    <!-- Validation -->
    <PackageReference Include="FluentValidation" />

    <!-- Environment Variables -->
    <PackageReference Include="DotNetEnv" />

    <!-- QuickBooks SDK -->
    <PackageReference Include="IppOAuth2PlatformSdk" />
    <PackageReference Include="IppDotNetSdkForQuickBooksApiV3" />

    <Manifest Include="$(ApplicationManifest)" />
  </ItemGroup>

  <!-- Shared Project References -->
  <ItemGroup>
    <ProjectReference Include="..\WileyWidget.Models\WileyWidget.Models.csproj" />
    <ProjectReference Include="..\WileyWidget.Services\WileyWidget.Services.csproj" />
    <ProjectReference Include="..\WileyWidget.Services.Abstractions\WileyWidget.Services.Abstractions.csproj" />
    <ProjectReference Include="..\WileyWidget.Business\WileyWidget.Business.csproj" />
    <ProjectReference Include="..\WileyWidget.Data\WileyWidget.Data.csproj" />
    <ProjectReference Include="..\WileyWidget.Abstractions\WileyWidget.Abstractions.csproj" />
    <!-- Removed reference to WileyWidget.Services.Uno to avoid duplicate SettingsService type conflict -->
  </ItemGroup>

  <!-- Unpackaged Mode Support (for debugging without packaging) -->
  <PropertyGroup Condition="'$(DisableMsixProjectCapabilityAddedByProject)'!='true' and '$(EnableMsixTooling)'=='true'">
    <AppxPackage>true</AppxPackage>
    <AppxPackageSigningEnabled>false</AppxPackageSigningEnabled>
  </PropertyGroup>

  <!-- dotnet-watch exclusions: avoid noisy restarts caused by log/bin/obj changes -->
  <ItemGroup>
    <Watch Remove="logs\**" />
    <Watch Remove="bin\**" />
    <Watch Remove="obj\**" />
    <Watch Remove=".vs\**" />
    <Watch Remove="**\*.user" />
    <Watch Remove="**\*.suo" />
  </ItemGroup>

  <!-- XAML tooling: provide a stable JSON output path for external validators
       Many custom tools (xaml-strict-validator, analyzer scripts) expect
       a JSON payload describing resolved XAML types. This property gives
       those tasks a deterministic location to write/read `xaml.json`. -->
  <PropertyGroup>
    <XamlJsonOutputPath>$(OutDir)xaml.json</XamlJsonOutputPath>
    <XamlGenerateCompilerErrorForResourceReference>True</XamlGenerateCompilerErrorForResourceReference>
  </PropertyGroup>

  <!-- Enable XAML validation to catch errors early (per industry best practice) -->
  <PropertyGroup>
    <RunXamlValidator>true</RunXamlValidator>
  </PropertyGroup>

  <!-- Optional: run the repository's strict XAML validator. Disabled by default; set
       RunXamlValidator=true to enable during local investigation. Validator runs after
       `CompileXaml` so it can inspect finalized XAML sources. Output is written to
       $(OutDir)xaml-validator.log and $(OutDir)xaml.json. -->
  <Target Name="RunXamlValidator" AfterTargets="MarkupCompilePass2;Build" Condition="'$(RunXamlValidator)' == 'true'">
    <Message Importance="High" Text="Running xaml-strict-validator.py (RunXamlValidator=true)" />
    <Exec
      Command="python &quot;$(MSBuildProjectDirectory)\..\..\scripts\tools\xaml-strict-validator.py&quot; &quot;$(MSBuildProjectDirectory)\**\*.xaml&quot; --fix &gt; &quot;$(OutDir)xaml-validator.log&quot; 2&gt;&amp;1"
      ContinueOnError="true" />
    <Copy SourceFiles="$(OutDir)xaml-validator.log" DestinationFolder="$(OutDir)" ContinueOnError="true" />
  </Target>

  <!-- Exclude legacy/duplicate XAML files that live outside the src/ folder
       Some legacy XAML files under the repository `Views\` folder are
       accidentally picked up by SDK wildcard scanning and cause duplicate
       partial-class / namespace collisions with the in-src copies. Remove
       them from compilation so only the `src/` copies are used. -->
  <ItemGroup>
    <Compile Remove="..\..\Views\**\*.xaml" />
  </ItemGroup>

  <!-- Provide a backward-compatible MSBuild entry point used by repo scripts/tools. -->
  <Target Name="CompileXaml" DependsOnTargets="MarkupCompilePass1;XamlPreCompile;MarkupCompilePass2">
    <Message Importance="High" Text="CompileXaml: delegated to MarkupCompilePass1/XamlPreCompile/MarkupCompilePass2" />
  </Target>

  <!-- ============================================================
       CUSTOM XAML COMPILER WRAPPER WITH ERROR CAPTURE
       Workaround for GitHub issue microsoft/microsoft-ui-xaml#10027
       XamlCompiler.exe only writes errors on success, crashes silently on failure
       ============================================================ -->
  <Target Name="XamlCompilerPreDiagnostics"
    BeforeTargets="MarkupCompilePass1;MarkupCompilePass2"
    Condition="'$(Configuration)' == 'Debug'">

    <Message Importance="High" Text="ðŸ”§ [XamlCompilerPreDiagnostics] Preparing diagnostic wrapper" />

    <!-- Create diagnostic log directory -->
    <PropertyGroup>
      <XamlDiagnosticDir>$(MSBuildProjectDirectory)\..\..\xaml-logs\</XamlDiagnosticDir>
      <XamlDiagnosticLog>
        $(XamlDiagnosticDir)xaml-compiler-$(MSBuildProjectName)-$([System.DateTime]::Now.ToString('yyyyMMdd-HHmmss')).log</XamlDiagnosticLog>
    </PropertyGroup>

    <MakeDir Directories="$(XamlDiagnosticDir)" />

    <!-- Log compilation parameters -->
    <WriteLinesToFile
      File="$(XamlDiagnosticLog)"
      Lines="=== XAML Compilation Started: $([System.DateTime]::Now) ==="
      Overwrite="true" />
    <WriteLinesToFile
      File="$(XamlDiagnosticLog)"
      Lines="Configuration: $(Configuration);Platform: $(Platform);TargetFramework: $(TargetFramework);IntermediateOutputPath: $(IntermediateOutputPath)"
      Overwrite="false" />

    <Message Importance="High" Text="ðŸ“ Diagnostic log: $(XamlDiagnosticLog)" />
  </Target>

  <!-- Capture XamlCompiler failures and run diagnostics -->
  <Target Name="XamlCompilerPostDiagnostics"
    AfterTargets="MarkupCompilePass1;MarkupCompilePass2"
    Condition="'$(Configuration)' == 'Debug'">

    <PropertyGroup>
      <XamlInputJson>$(IntermediateOutputPath)input.json</XamlInputJson>
      <XamlOutputJson>$(IntermediateOutputPath)output.json</XamlOutputJson>
      <XamlCompilerSuccess>true</XamlCompilerSuccess>
      <XamlCompilerSuccess Condition="!Exists('$(XamlOutputJson)')">false</XamlCompilerSuccess>
    </PropertyGroup>

    <Message Importance="High" Text="âœ… [XamlCompilerPostDiagnostics] XAML compilation succeeded"
      Condition="'$(XamlCompilerSuccess)' == 'true'" />
    <Warning Text="âŒ [XamlCompilerPostDiagnostics] XAML compilation may have failed - output.json not found"
      Condition="'$(XamlCompilerSuccess)' == 'false'" />

    <!-- Log result -->
    <WriteLinesToFile
      File="$(XamlDiagnosticLog)"
      Lines="Result: $(XamlCompilerSuccess) at $([System.DateTime]::Now)"
      Overwrite="false"
      Condition="Exists('$(XamlDiagnosticLog)')" />
    <WriteLinesToFile
      File="$(XamlDiagnosticLog)"
      Lines="Input JSON: $(XamlInputJson) [Exists: $([System.IO.File]::Exists('$(XamlInputJson)'))]"
      Overwrite="false"
      Condition="Exists('$(XamlDiagnosticLog)')" />
    <WriteLinesToFile
      File="$(XamlDiagnosticLog)"
      Lines="Output JSON: $(XamlOutputJson) [Exists: $([System.IO.File]::Exists('$(XamlOutputJson)'))]"
      Overwrite="false"
      Condition="Exists('$(XamlDiagnosticLog)')" />

    <!-- Run diagnostic script on failure -->
    <Exec
      Command="pwsh -NoProfile -ExecutionPolicy Bypass -Command &quot;if (Test-Path '$(MSBuildProjectDirectory)\..\..\scripts\tools\run-xamlcompiler.ps1') { &amp; '$(MSBuildProjectDirectory)\..\..\scripts\tools\run-xamlcompiler.ps1' -InputPath '$(XamlInputJson)' -OutputPath '$(XamlOutputJson)' -Verbose }&quot;"
      ContinueOnError="true"
      IgnoreExitCode="true"
      Condition="'$(XamlCompilerSuccess)' == 'false' AND Exists('$(XamlInputJson)')" />
  </Target>

</Project>