<UserControl x:Class="WileyWidget.AIAssistView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:local="clr-namespace:WileyWidget"
             xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
             xmlns:syncskin="clr-namespace:Syncfusion.SfSkinManager;assembly=Syncfusion.SfSkinManager.WPF"
             xmlns:notification="clr-namespace:Syncfusion.Windows.Controls.Notification;assembly=Syncfusion.SfBusyIndicator.WPF"
             xmlns:chat="clr-namespace:Syncfusion.UI.Xaml.Chat;assembly=Syncfusion.SfChat.WPF"
             mc:Ignorable="d"
             Margin="10" Padding="5"
             Loaded="AIAssistView_Loaded"
             syncskin:SfSkinManager.Theme="FluentDark">
    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" /> <!-- Input row -->
            <RowDefinition Height="*" /> <!-- Chat row -->
            <RowDefinition Height="Auto" /> <!-- Toolbar row -->
        </Grid.RowDefinitions>

        <!-- SfBusyIndicator overlay -->
        <notification:SfBusyIndicator Grid.RowSpan="3" 
                                   IsBusy="{Binding IsProcessing}"
                                   Header="Processing AI request..."
                                   AnimationType="Gear" />

        <!-- User Input Area (Top) -->
        <Border Grid.Row="0" Background="#F8F9FA" BorderBrush="#E9ECEF" BorderThickness="1"
                Padding="10" Margin="0,0,0,5">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <syncfusion:SfTextBoxExt x:Name="MessageInput"
                                       Text="{Binding QueryText, UpdateSourceTrigger=PropertyChanged}"
                                       Watermark="Ask about budgets..."
                                       ToolTip="Enter query for AI analysis (e.g., 'What if we increase rates?')"
                                       VerticalAlignment="Center"
                                       Margin="0,0,10,0"
                                       KeyDown="OnMessageInputKeyDown" />

                <StackPanel Grid.Column="1" Orientation="Horizontal">
                    <syncfusion:ButtonAdv Label="Send"
                                        Command="{Binding SendMessageCommand}"
                                        ToolTip="Send query to AI (supports GASB queries)"
                                        Background="#1976D2"
                                        Foreground="White"
                                        Margin="0,0,5,0" />
                    <syncfusion:ButtonAdv Label="Generate"
                                        Command="{Binding GenerateCommand}"
                                        ToolTip="Generate calculation response"
                                        Background="#4CAF50"
                                        Foreground="White" />
                </StackPanel>
            </Grid>
        </Border>

        <!-- Response Output Area (Middle) -->
        <Border Grid.Row="1" Background="White" BorderBrush="#E9ECEF" BorderThickness="1"
                Padding="10" Margin="0,5,0,5">
            <TextBox x:Name="ResponseOutput"
                    Text="{Binding Response, Mode=OneWay}"
                    IsReadOnly="True"
                    TextWrapping="Wrap"
                    VerticalScrollBarVisibility="Auto"
                    HorizontalScrollBarVisibility="Auto"
                    AcceptsReturn="True"
                    ToolTip="AI-generated response and calculations"
                    FontFamily="Consolas"
                    FontSize="12" />
        </Border>

        <!-- Bottom Toolbar -->
        <Border Grid.Row="2" Background="#F0F0F0" BorderBrush="#CCCCCC" BorderThickness="1,1,1,0"
                Padding="10" Margin="0,5,0,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Mode Buttons -->
                <StackPanel Grid.Column="0" Orientation="Horizontal" Margin="0,0,10,0">
                    <syncfusion:ButtonAdv Label="ðŸ¤– General"
                                        Command="{Binding SetConversationModeCommand}"
                                        CommandParameter="General"
                                        ToolTip="Switch to General AI mode"
                                        Margin="0,0,5,0" />
                    <syncfusion:ButtonAdv Label=" What-If"
                                        Command="{Binding SetConversationModeCommand}"
                                        CommandParameter="WhatIf"
                                        ToolTip="Switch to What-If scenario mode"
                                        Margin="0,0,5,0" />
                    <syncfusion:ButtonAdv Label="ðŸŽ¯ Advisory"
                                        Command="{Binding SetConversationModeCommand}"
                                        CommandParameter="Advisory"
                                        ToolTip="Switch to Proactive Advisor mode" />
                </StackPanel>

                <!-- History List -->
                <ListBox Grid.Column="1"
                         ItemsSource="{Binding ConversationHistory}"
                         SelectedItem="{Binding SelectedHistoryItem, Mode=TwoWay}"
                         ToolTip="Select from past conversations"
                         Margin="10,0"
                         Background="White"
                         BorderBrush="#CCCCCC"
                         BorderThickness="1" />

                <!-- Additional Actions -->
                <StackPanel Grid.Column="2" Orientation="Horizontal">
                    <syncfusion:ButtonAdv Label="Clear" 
                                        Command="{Binding ClearChatCommand}"
                                        ToolTip="Clear chat history"
                                        Margin="0,0,5,0" />
                    <syncfusion:ButtonAdv Label="Export"
                                        Command="{Binding ExportChatCommand}"
                                        ToolTip="Export chat history" />
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>