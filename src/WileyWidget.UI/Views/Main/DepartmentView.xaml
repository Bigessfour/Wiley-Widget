<UserControl
    x:Class="WileyWidget.Views.Main.DepartmentView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:WileyWidget.Converters"
    xmlns:views="clr-namespace:WileyWidget.Views;assembly=WileyWidget.UI"
    xmlns:converters="clr-namespace:WileyWidget.Converters"
    xmlns:behaviors="clr-namespace:WileyWidget.UI.Behaviors"
    xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
    xmlns:notification="http://schemas.syncfusion.com/wpf"
    xmlns:syncfusionskin="clr-namespace:Syncfusion.SfSkinManager;assembly=Syncfusion.SfSkinManager.WPF"
    xmlns:prism="http://prismlibrary.com/"
    prism:ViewModelLocator.AutoWireViewModel="True"
    mc:Ignorable="d">
  <UserControl.Resources>
    <!-- Status Indicator Template -->
    <DataTemplate x:Key="StatusTemplate">
      <StackPanel Orientation="Horizontal">
        <Ellipse
            Width="8"
            Height="8"
            Fill="{Binding IsLoading, Converter={StaticResource BoolToVis}, ConverterParameter=Green:Gray}"
            Margin="0,0,4,0" />
        <TextBlock Text="{Binding StatusMessage}" />
      </StackPanel>
    </DataTemplate>
  </UserControl.Resources>

  <!-- Removed legacy Acrylic panel - SfSkinManager handles all theming automatically -->
  <Grid
      behaviors:FocusOnLoadBehavior.IsEnabled="True"
      behaviors:FocusOnLoadBehavior.TargetName="DepartmentFocusAnchor">
    <Border
        x:Name="DepartmentFocusAnchor"
        Focusable="True"
        Width="0"
        Height="0"
        Opacity="0" />
    <DockPanel>
      <!-- Ribbon Toolbar -->
      <syncfusion:Ribbon
          DockPanel.Dock="Top"
          x:Name="DepartmentRibbon">
        <syncfusion:RibbonTab Caption="Departments">
          <syncfusion:RibbonBar Header="Actions">
            <syncfusion:RibbonButton
                Label="Load All"
                SizeForm="Large"
                Command="{Binding LoadDepartmentsCommand}"
                ToolTip="Load all department records from database" />
            <syncfusion:RibbonButton
                Label="Add New"
                SizeForm="Large"
                Command="{Binding AddDepartmentCommand}"
                ToolTip="Create a new department record" />
            <syncfusion:RibbonButton
                Label="Save"
                Command="{Binding SaveDepartmentCommand}"
                ToolTip="Save changes to the selected department" />
            <syncfusion:RibbonButton
                Label="Delete"
                Command="{Binding DeleteDepartmentCommand}"
                ToolTip="Delete the selected department (requires confirmation)" />
            <syncfusion:RibbonButton
                Label="Refresh"
                SizeForm="Small"
                Command="{Binding RefreshCommand}"
                ToolTip="Refresh department data" />
          </syncfusion:RibbonBar>
          <syncfusion:RibbonBar Header="Export">
            <syncfusion:RibbonButton
                Label="Export to Excel"
                SizeForm="Small"
                Command="{Binding ExportToExcelCommand}"
                ToolTip="Export department data to Excel format" />
            <syncfusion:RibbonButton
                Label="Export to CSV"
                SizeForm="Small"
                Command="{Binding ExportToCsvCommand}"
                ToolTip="Export department data to CSV format" />
            <syncfusion:RibbonButton
                Label="Copy to Clipboard"
                SizeForm="Small"
                Command="{Binding CopyToClipboardCommand}"
                ToolTip="Copy department data to clipboard" />
          </syncfusion:RibbonBar>
        </syncfusion:RibbonTab>
      </syncfusion:Ribbon>

      <!-- Status Bar -->
      <Border
          DockPanel.Dock="Bottom"
          Background="#F5F5F5"
          BorderBrush="#E0E0E0"
          BorderThickness="0,1,0,0"
          Padding="8">
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" />
            <ColumnDefinition Width="Auto" />
          </Grid.ColumnDefinitions>

          <!-- Status Message -->
          <TextBlock
              Grid.Column="0"
              Text="{Binding StatusMessage}"
              Foreground="{Binding ErrorMessage, Converter={StaticResource NullToVis}, ConverterParameter=Red:Green}"
              FontWeight="SemiBold"
              VerticalAlignment="Center" />

          <!-- Loading Indicator -->
          <StackPanel
              Grid.Column="1"
              Orientation="Horizontal"
              Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}">
            <syncfusion:SfBusyIndicator
                AnimationType="Gear"
                Width="20"
                Height="20"
                Margin="0,0,8,0" />
            <TextBlock
                Text="Loading..."
                VerticalAlignment="Center"
                FontStyle="Italic" />
          </StackPanel>
        </Grid>
      </Border>

      <!-- Main Content Area -->
      <Grid>
        <Grid.ColumnDefinitions>
          <ColumnDefinition Width="*" />
          <ColumnDefinition Width="400" />
        </Grid.ColumnDefinitions>

        <!-- Department List -->
        <DockPanel Grid.Column="0">
          <TextBlock
              DockPanel.Dock="Top"
              Text="Municipal Departments"
              FontSize="16"
              FontWeight="Bold"
              Margin="8"
              ToolTip="List of all municipal departments" />

          <!-- Search and Filter Bar -->
          <Border
              DockPanel.Dock="Top"
              Background="#F5F5F5"
              BorderBrush="#E0E0E0"
              BorderThickness="0,0,0,1"
              Padding="8">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*" />
                <ColumnDefinition Width="Auto" />
              </Grid.ColumnDefinitions>

              <!-- Search Box -->
              <syncfusion:SfTextBoxExt
                  Grid.Column="0"
                  x:Name="SearchTextBox"
                  Watermark="Search departments by name or code..."
                  Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}"
                  Margin="0,0,8,0"
                  ToolTip="Enter search terms to filter department list&#x0a;Press Enter to search, use Clear button to reset">
                <syncfusion:SfTextBoxExt.WatermarkTemplate>
                  <DataTemplate>
                    <StackPanel Orientation="Horizontal">
                      <Path
                          Data="M 15.5,14 L 20.5,19 M 9,3 A 6,6 0 1 1 9,15 A 6,6 0 1 1 9,3"
                          Stroke="Gray"
                          StrokeThickness="1.5"
                          Width="16"
                          Height="16"
                          Margin="4,0,6,0"
                          Stretch="Uniform" />
                      <TextBlock
                          Text="Search departments by name or code..."
                          Foreground="Gray"
                          VerticalAlignment="Center" />
                    </StackPanel>
                  </DataTemplate>
                </syncfusion:SfTextBoxExt.WatermarkTemplate>
              </syncfusion:SfTextBoxExt>

              <!-- Clear Search Button -->
              <syncfusion:RibbonButton
                  Grid.Column="1"
                  Label="Clear"
                  SizeForm="Small"
                  Command="{Binding ClearSearchCommand}"
                  ToolTip="Clear search filter" />
            </Grid>
          </Border>

          <!-- Department Data Grid -->
          <syncfusion:SfDataGrid
              x:Name="DepartmentGrid"
              ItemsSource="{Binding FilteredDepartmentList}"
              SelectedItem="{Binding SelectedDepartment, Mode=TwoWay}"
              AutoGenerateColumns="False"
              AllowSorting="True"
              AllowFiltering="True"
              AllowGrouping="True"
              AllowResizingColumns="True"
              ColumnSizer="Auto"
              GridValidationMode="InView"
              NavigationMode="Cell"
              SelectionMode="Single"
              VirtualizingPanel.ScrollUnit="Pixel"
              VirtualizingPanel.VirtualizationMode="Recycling"
              VirtualizingPanel.CacheLength="5,5"
              VirtualizingPanel.CacheLengthUnit="Page"
              ToolTipService.ToolTip="Department data grid - Select rows for editing">

            <!-- Context Menu -->
            <syncfusion:SfDataGrid.ContextMenu>
              <ContextMenu>
                <MenuItem
                    Header="Add New Department"
                    Command="{Binding AddDepartmentCommand}" />
                <MenuItem
                    Header="Save Selected"
                    Command="{Binding SaveDepartmentCommand}" />
                <MenuItem
                    Header="Delete Selected"
                    Command="{Binding DeleteDepartmentCommand}" />
                <Separator />
                <MenuItem
                    Header="Refresh Data"
                    Command="{Binding RefreshCommand}" />
              </ContextMenu>
            </syncfusion:SfDataGrid.ContextMenu>

            <!-- Data Grid Columns -->
            <syncfusion:SfDataGrid.Columns>
              <syncfusion:GridTextColumn
                  HeaderText="ID"
                  MappingName="Id"
                  Width="60"
                  IsReadOnly="True"
                  ToolTipService.ToolTip="Unique department identifier" />
              <syncfusion:GridTextColumn
                  HeaderText="Name"
                  MappingName="Name"
                  Width="200"
                  ToolTipService.ToolTip="Department name" />
              <syncfusion:GridTextColumn
                  HeaderText="Code"
                  MappingName="DepartmentCode"
                  Width="100"
                  ToolTipService.ToolTip="Department code (e.g., DPW)" />
              <syncfusion:GridTextColumn
                  HeaderText="Parent ID"
                  MappingName="ParentId"
                  Width="80"
                  IsReadOnly="True"
                  ToolTipService.ToolTip="Parent department ID for hierarchy" />
            </syncfusion:SfDataGrid.Columns>
          </syncfusion:SfDataGrid>
        </DockPanel>

        <!-- Department Details Panel -->
        <Border
            Grid.Column="1"
            Background="#FAFAFA"
            BorderBrush="#E0E0E0"
            BorderThickness="1,0,0,0">
          <DockPanel>
            <TextBlock
                DockPanel.Dock="Top"
                Text="Department Details"
                FontSize="14"
                FontWeight="Bold"
                Margin="8"
                ToolTip="Edit selected department details" />

            <ScrollViewer DockPanel.Dock="Top">
              <StackPanel
                  Margin="8"
                  Orientation="Vertical">
                <!-- ID (Read-only) -->
                <TextBlock
                    Text="ID:"
                    FontWeight="SemiBold"
                    Margin="0,0,0,4" />
                <TextBox
                    Text="{Binding SelectedDepartment.Id, Mode=OneWay}"
                    IsReadOnly="True"
                    Margin="0,0,0,12"
                    Background="#F0F0F0" />

                <!-- Name -->
                <TextBlock
                    Text="Name:"
                    FontWeight="SemiBold"
                    Margin="0,0,0,4" />
                <TextBox
                    Text="{Binding SelectedDepartment.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    Margin="0,0,0,12"
                    ToolTip="Department name (required)" />
                <TextBlock
                    Text="{Binding [Name]}"
                    Foreground="Red"
                    FontSize="10"
                    Visibility="{Binding [Name], Converter={StaticResource NullToVis}}"
                    Margin="0,0,0,8" />

                <!-- Department Code -->
                <TextBlock
                    Text="Department Code:"
                    FontWeight="SemiBold"
                    Margin="0,0,0,4" />
                <TextBox
                    Text="{Binding SelectedDepartment.DepartmentCode, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                    Margin="0,0,0,12"
                    ToolTip="Department code (optional, max 20 characters)" />
                <TextBlock
                    Text="{Binding [DepartmentCode]}"
                    Foreground="Red"
                    FontSize="10"
                    Visibility="{Binding [DepartmentCode], Converter={StaticResource NullToVis}}"
                    Margin="0,0,0,8" />

                <!-- Parent ID (Read-only for now) -->
                <TextBlock
                    Text="Parent Department ID:"
                    FontWeight="SemiBold"
                    Margin="0,0,0,4" />
                <TextBox
                    Text="{Binding SelectedDepartment.ParentId, Mode=OneWay, TargetNullValue='None'}"
                    IsReadOnly="True"
                    Margin="0,0,0,12"
                    Background="#F0F0F0"
                    ToolTip="Parent department ID (for hierarchical departments)" />

                <!-- Error Message -->
                <TextBlock
                    Text="{Binding ErrorMessage}"
                    Foreground="Red"
                    FontWeight="SemiBold"
                    TextWrapping="Wrap"
                    Visibility="{Binding ErrorMessage, Converter={StaticResource NullToVis}}"
                    Margin="0,8,0,0" />
              </StackPanel>
            </ScrollViewer>
          </DockPanel>
        </Border>
      </Grid>
    </DockPanel>
  </Grid>
</UserControl>
