<UserControl
    x:Class="WileyWidget.Views.Panels.SettingsPanelView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="clr-namespace:WileyWidget"
    xmlns:converters="clr-namespace:WileyWidget.Converters"
    xmlns:behaviors="clr-namespace:WileyWidget.UI.Behaviors"
    xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
    xmlns:syncfusionskin="clr-namespace:Syncfusion.SfSkinManager;assembly=Syncfusion.SfSkinManager.WPF"
    xmlns:notification="clr-namespace:Syncfusion.Windows.Controls.Notification;assembly=Syncfusion.SfBusyIndicator.WPF"
    mc:Ignorable="d"
    d:DesignHeight="600"
    d:DesignWidth="800"
    xmlns:prism="http://prismlibrary.com/"
    prism:ViewModelLocator.AutoWireViewModel="True">
  <UserControl.Resources>
    <converters:BooleanToVisibilityConverter x:Key="BoolToVis" />
    <!-- Collapses validation label when empty -->
    <Style
        x:Key="ValidationTextStyle"
        TargetType="TextBlock">
      <Setter
          Property="Foreground"
          Value="#FFDA4453" />
      <Setter
          Property="Margin"
          Value="0,2,0,8" />
      <Setter
          Property="FontSize"
          Value="12" />
      <Style.Triggers>
        <Trigger
            Property="Text"
            Value="">
          <Setter
              Property="Visibility"
              Value="Collapsed" />
        </Trigger>
      </Style.Triggers>
    </Style>
  </UserControl.Resources>

  <!-- Removed legacy Acrylic panel - SfSkinManager handles all theming automatically -->
  <DockPanel
      behaviors:MouseFocusBehavior.EnableOnClick="True"
      behaviors:MouseFocusBehavior.EnableOnFirstMove="True">
    <!-- Ribbon Toolbar -->
    <syncfusion:Ribbon
        DockPanel.Dock="Top"
        x:Name="SettingsRibbon">
      <syncfusion:RibbonTab Caption="Settings">
        <syncfusion:RibbonBar Header="Actions">
          <syncfusion:RibbonButton
              Label="Save"
              SizeForm="Large"
              Command="{Binding SaveSettingsCommand}" />
          <syncfusion:RibbonButton
              Label="Reset"
              Command="{Binding ResetSettingsCommand}" />
          <syncfusion:RibbonButton
              Label="Test Connection"
              Command="{Binding TestConnectionCommand}" />
        </syncfusion:RibbonBar>
      </syncfusion:RibbonTab>
    </syncfusion:Ribbon>

    <!-- Main Content Area (Syncfusion TabControlExt for a richer tab experience) -->
    <!-- Reference: https://help.syncfusion.com/wpf/tabcontrol/overview -->
    <syncfusion:TabControlExt
        Margin="8"
        EnableLabelEdit="False"
        CloseButtonType="Hide">
      <!-- General Settings -->
      <syncfusion:TabItemExt Header="General">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="8">
            <GroupBox
                Header="Application Settings"
                Margin="0,0,0,8">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="200" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Label
                    Grid.Row="0"
                    Grid.Column="0"
                    Content="Theme:"
                    VerticalAlignment="Center" />
                <ComboBox
                    Grid.Row="0"
                    Grid.Column="1"
                    ItemsSource="{Binding AvailableThemes}"
                    SelectedItem="{Binding SelectedTheme, Mode=TwoWay}"
                    Margin="0,0,0,8"
                    ToolTipService.ToolTip="Select FluentDark or FluentLight theme" />

                <Label
                    Grid.Row="1"
                    Grid.Column="0"
                    Content="Window Width:"
                    VerticalAlignment="Center" />
                <StackPanel
                    Grid.Row="1"
                    Grid.Column="1">
                  <syncfusion:IntegerTextBox
                      Value="{Binding WindowWidth, Mode=TwoWay}"
                      Margin="0,0,0,0"
                      ToolTipService.ToolTip="Default window width (800-3840)" />
                  <TextBlock
                      Text="{Binding WindowWidthValidation}"
                      Style="{DynamicResource ValidationTextStyle}" />
                </StackPanel>

                <Label
                    Grid.Row="2"
                    Grid.Column="0"
                    Content="Window Height:"
                    VerticalAlignment="Center" />
                <StackPanel
                    Grid.Row="2"
                    Grid.Column="1">
                  <syncfusion:IntegerTextBox
                      Value="{Binding WindowHeight, Mode=TwoWay}"
                      ToolTipService.ToolTip="Default window height (600-2160)" />
                  <TextBlock
                      Text="{Binding WindowHeightValidation}"
                      Style="{DynamicResource ValidationTextStyle}" />
                </StackPanel>

                <CheckBox
                    Grid.Row="3"
                    Grid.ColumnSpan="2"
                    Content="Maximize window on startup"
                    IsChecked="{Binding MaximizeOnStartup, Mode=TwoWay}"
                    Margin="0,8,0,0" />

                <CheckBox
                    Grid.Row="4"
                    Grid.ColumnSpan="2"
                    Content="Show splash screen"
                    IsChecked="{Binding ShowSplashScreen, Mode=TwoWay}"
                    Margin="0,8,0,0" />
              </Grid>
            </GroupBox>

            <GroupBox
                Header="Data Settings"
                Margin="0,0,0,8">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="200" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Label
                    Grid.Row="0"
                    Grid.Column="0"
                    Content="Database Connection:"
                    VerticalAlignment="Center" />
                <TextBox
                    Grid.Row="0"
                    Grid.Column="1"
                    Text="{Binding DatabaseConnectionString, Mode=TwoWay}"
                    IsReadOnly="True"
                    Background="#222"
                    Foreground="#ddd"
                    Margin="0,0,0,8" />

                <Label
                    Grid.Row="1"
                    Grid.Column="0"
                    Content="Database Status:"
                    VerticalAlignment="Center" />
                <TextBlock
                    Grid.Row="1"
                    Grid.Column="1"
                    Text="{Binding DatabaseStatus}"
                    Foreground="{Binding DatabaseStatusColor}" />
              </Grid>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </syncfusion:TabItemExt>

      <!-- QuickBooks Integration -->
      <syncfusion:TabItemExt Header="QuickBooks Integration">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="8">
            <GroupBox
                Header="OAuth2 Configuration"
                Margin="0,0,0,8">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="200" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Label
                    Grid.Row="0"
                    Grid.Column="0"
                    Content="Client ID:" />
                <TextBox
                    Grid.Row="0"
                    Grid.Column="1"
                    Text="{Binding QuickBooksClientId, Mode=TwoWay}"
                    Margin="0,0,0,8"
                    ToolTipService.ToolTip="Sandbox: Intuit → My Apps → (Your App) → Keys &amp; OAuth → Client ID. See docs/integrations/quickbooks-oauth-setup.md" />

                <Label
                    Grid.Row="1"
                    Grid.Column="0"
                    Content="Client Secret:" />
                <TextBox
                    Grid.Row="1"
                    Grid.Column="1"
                    Text="{Binding QuickBooksClientSecret, Mode=TwoWay}"
                    Margin="0,0,0,8"
                    ToolTipService.ToolTip="Sandbox secret from Keys &amp; OAuth; stored via Secret Vault. Do not share." />

                <Label
                    Grid.Row="2"
                    Grid.Column="0"
                    Content="Redirect URI:" />
                <TextBox
                    Grid.Row="2"
                    Grid.Column="1"
                    Text="{Binding QuickBooksRedirectUri, Mode=TwoWay}"
                    Margin="0,0,0,8"
                    ToolTipService.ToolTip="Use EXACTLY http://localhost:8080/callback and add it under Intuit → Keys &amp; OAuth → Redirect URIs" />

                <Label
                    Grid.Row="3"
                    Grid.Column="0"
                    Content="Environment:" />
                <ComboBox
                    Grid.Row="3"
                    Grid.Column="1"
                    ItemsSource="{Binding QuickBooksEnvironments}"
                    SelectedItem="{Binding SelectedQuickBooksEnvironment, Mode=TwoWay}"
                    ToolTipService.ToolTip="Select Sandbox for development. Use Production only with approved credentials." />
              </Grid>
            </GroupBox>

            <GroupBox
                Header="Connection Status"
                Margin="0,0,0,8">
              <StackPanel>
                <TextBlock
                    Text="{Binding QuickBooksConnectionStatus}"
                    Foreground="{Binding QuickBooksStatusColor}"
                    Margin="0,0,0,8" />

                <StackPanel Orientation="Horizontal">
                  <Button
                      Content="Test QuickBooks Connection"
                      Command="{Binding TestQuickBooksConnectionCommand}"
                      HorizontalAlignment="Left"
                      Margin="0,0,8,0" />

                  <Button
                      Content="Connect to QuickBooks"
                      Command="{Binding ConnectQuickBooksCommand}"
                      HorizontalAlignment="Left" />
                </StackPanel>
                <TextBlock
                    Text="We are integrating with Sandbox first. Quick reference: docs/integrations/quickbooks-oauth-setup.md"
                    Foreground="#aaa"
                    FontStyle="Italic"
                    Margin="0,8,0,0" />
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </syncfusion:TabItemExt>

      <!-- Syncfusion License -->
      <syncfusion:TabItemExt Header="Syncfusion License">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="8">
            <GroupBox
                Header="License Information"
                Margin="0,0,0,8">
              <StackPanel>
                <Label Content="License Key:" />
                <TextBox
                    Text="{Binding SyncfusionLicenseKey, Mode=TwoWay}"
                    Margin="0,0,0,8"
                    TextWrapping="Wrap"
                    Height="60"
                    AcceptsReturn="True" />

                <Label Content="License Status:" />
                <TextBlock
                    Text="{Binding SyncfusionLicenseStatus}"
                    Foreground="{Binding SyncfusionLicenseStatusColor}"
                    Margin="0,0,0,8" />

                <Button
                    Content="Validate License"
                    Command="{Binding ValidateLicenseCommand}"
                    HorizontalAlignment="Left"
                    Margin="0,0,0,8" />

                <TextBlock
                    Text="Note: License key is stored securely in environment variables."
                    FontStyle="Italic"
                    Foreground="Gray" />
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </syncfusion:TabItemExt>

      <!-- AI (XAI) Settings -->
      <syncfusion:TabItemExt Header="AI (XAI)">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="8">
            <GroupBox
                Header="Connection"
                Margin="0,0,0,8">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="200" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Label
                    Grid.Row="0"
                    Grid.Column="0"
                    Content="API Key:" />
                <TextBox
                    Grid.Row="0"
                    Grid.Column="1"
                    Text="{Binding XaiApiKey, Mode=TwoWay}"
                    Margin="0,0,0,8" />
                <Label
                    Grid.Row="1"
                    Grid.Column="0"
                    Content="Base URL:" />
                <TextBox
                    Grid.Row="1"
                    Grid.Column="1"
                    Text="{Binding XaiBaseUrl, Mode=TwoWay}"
                    Margin="0,0,0,8" />
                <Label
                    Grid.Row="2"
                    Grid.Column="0"
                    Content="Model:" />
                <ComboBox
                    Grid.Row="2"
                    Grid.Column="1"
                    ItemsSource="{Binding AvailableModels}"
                    SelectedItem="{Binding XaiModel, Mode=TwoWay}"
                    Margin="0,0,0,8" />
                <Label
                    Grid.Row="3"
                    Grid.Column="0"
                    Content="Timeout (sec):" />
                <StackPanel
                    Grid.Row="3"
                    Grid.Column="1">
                  <syncfusion:IntegerTextBox Value="{Binding XaiTimeoutSeconds, Mode=TwoWay}" />
                  <TextBlock
                      Text="{Binding XaiTimeoutValidation}"
                      Style="{DynamicResource ValidationTextStyle}" />
                </StackPanel>
              </Grid>
            </GroupBox>

            <GroupBox
                Header="Generation Options"
                Margin="0,0,0,8">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="200" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <Label
                    Grid.Row="0"
                    Grid.Column="0"
                    Content="Response Style:" />
                <ComboBox
                    Grid.Row="0"
                    Grid.Column="1"
                    ItemsSource="{Binding AvailableResponseStyles}"
                    SelectedItem="{Binding ResponseStyle, Mode=TwoWay}"
                    Margin="0,0,0,8" />

                <Label
                    Grid.Row="1"
                    Grid.Column="0"
                    Content="Personality:" />
                <ComboBox
                    Grid.Row="1"
                    Grid.Column="1"
                    ItemsSource="{Binding AvailablePersonalities}"
                    SelectedItem="{Binding Personality, Mode=TwoWay}"
                    Margin="0,0,0,8" />

                <Label
                    Grid.Row="2"
                    Grid.Column="0"
                    Content="Context Window:" />
                <StackPanel
                    Grid.Row="2"
                    Grid.Column="1">
                  <syncfusion:IntegerTextBox Value="{Binding ContextWindowSize, Mode=TwoWay}" />
                  <TextBlock
                      Text="{Binding ContextWindowValidation}"
                      Style="{DynamicResource ValidationTextStyle}" />
                </StackPanel>

                <Label
                    Grid.Row="3"
                    Grid.Column="0"
                    Content="Temperature:" />
                <StackPanel
                    Grid.Row="3"
                    Grid.Column="1">
                  <syncfusion:DoubleTextBox
                      Value="{Binding Temperature, Mode=TwoWay}"
                      NumberDecimalDigits="2" />
                  <TextBlock
                      Text="{Binding TemperatureValidation}"
                      Style="{DynamicResource ValidationTextStyle}" />
                </StackPanel>

                <Label
                    Grid.Row="4"
                    Grid.Column="0"
                    Content="Max Tokens:" />
                <StackPanel
                    Grid.Row="4"
                    Grid.Column="1">
                  <syncfusion:IntegerTextBox Value="{Binding MaxTokens, Mode=TwoWay}" />
                  <TextBlock
                      Text="{Binding MaxTokensValidation}"
                      Style="{DynamicResource ValidationTextStyle}" />
                </StackPanel>
              </Grid>
            </GroupBox>

            <GroupBox
                Header="Preferences"
                Margin="0,0,0,8">
              <StackPanel>
                <CheckBox
                    Content="Enable Safety Filters"
                    IsChecked="{Binding EnableSafetyFilters, Mode=TwoWay}" />
                <CheckBox
                    Content="Enable Streaming"
                    IsChecked="{Binding EnableStreaming, Mode=TwoWay}" />
              </StackPanel>
            </GroupBox>

            <GroupBox
                Header="Connection Status"
                Margin="0,0,0,8">
              <StackPanel>
                <TextBlock
                    Text="{Binding XaiConnectionStatus}"
                    Foreground="{Binding XaiStatusColor}"
                    Margin="0,0,0,8" />
                <Button
                    Content="Test XAI Connection"
                    Command="{Binding TestXaiConnectionCommand}"
                    HorizontalAlignment="Left" />
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </syncfusion:TabItemExt>

      <!-- Advanced Settings -->
      <syncfusion:TabItemExt Header="Advanced">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="8">
            <GroupBox
                Header="Performance Settings"
                Margin="0,0,0,8">
              <StackPanel>
                <CheckBox
                    Content="Enable dynamic column generation"
                    IsChecked="{Binding EnableDynamicColumns, Mode=TwoWay}"
                    Margin="0,0,0,8" />

                <CheckBox
                    Content="Enable data caching"
                    IsChecked="{Binding EnableDataCaching, Mode=TwoWay}"
                    Margin="0,0,0,8" />

                <Label Content="Cache expiration (minutes):" />
                <syncfusion:IntegerTextBox
                    Value="{Binding CacheExpirationMinutes, Mode=TwoWay}"
                    Margin="0,0,0,8" />
              </StackPanel>
            </GroupBox>

            <GroupBox
                Header="Logging Settings"
                Margin="0,0,0,8">
              <StackPanel>
                <Label Content="Log Level:" />
                <ComboBox
                    ItemsSource="{Binding LogLevels}"
                    SelectedItem="{Binding SelectedLogLevel, Mode=TwoWay}"
                    Margin="0,0,0,8" />

                <CheckBox
                    Content="Enable file logging"
                    IsChecked="{Binding EnableFileLogging, Mode=TwoWay}"
                    Margin="0,0,0,8" />

                <Label Content="Log file path:" />
                <TextBox
                    Text="{Binding LogFilePath, Mode=TwoWay}"
                    Margin="0,0,0,8" />
              </StackPanel>
            </GroupBox>

            <GroupBox
                Header="System Information"
                Margin="0,0,0,8">
              <StackPanel>
                <TextBlock
                    Text="{Binding SystemInfo}"
                    TextWrapping="Wrap" />
              </StackPanel>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </syncfusion:TabItemExt>

      <!-- Fiscal Year Settings -->
      <syncfusion:TabItemExt Header="Fiscal Year">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
          <StackPanel Margin="8">
            <GroupBox
                Header="Fiscal Year Configuration"
                Margin="0,0,0,8">
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="200" />
                  <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                  <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>
                <Label
                    Grid.Row="0"
                    Grid.Column="0"
                    Content="Start Month:" />
                <ComboBox
                    Grid.Row="0"
                    Grid.Column="1"
                    ItemsSource="{Binding FiscalYearMonths}"
                    SelectedValuePath="Value"
                    DisplayMemberPath="Name"
                    SelectedValue="{Binding FiscalYearStartMonth, Mode=TwoWay}" />
                <Label
                    Grid.Row="1"
                    Grid.Column="0"
                    Content="Start Day:" />
                <StackPanel
                    Grid.Row="1"
                    Grid.Column="1">
                  <syncfusion:IntegerTextBox Value="{Binding FiscalYearStartDay, Mode=TwoWay}" />
                  <TextBlock
                      Text="{Binding FiscalYearDayValidation}"
                      Style="{DynamicResource ValidationTextStyle}" />
                </StackPanel>
                <Label
                    Grid.Row="2"
                    Grid.Column="0"
                    Content="Current Fiscal Year:" />
                <TextBlock
                    Grid.Row="2"
                    Grid.Column="1"
                    Text="{Binding CurrentFiscalYearDisplay}" />
                <Label
                    Grid.Row="3"
                    Grid.Column="0"
                    Content="Period:" />
                <TextBlock
                    Grid.Row="3"
                    Grid.Column="1"
                    Text="{Binding FiscalYearPeriodDisplay}" />
                <Label
                    Grid.Row="4"
                    Grid.Column="0"
                    Content="Days Remaining:" />
                <TextBlock
                    Grid.Row="4"
                    Grid.Column="1"
                    Text="{Binding DaysRemainingInFiscalYear}" />
                <Button
                    Grid.Row="5"
                    Grid.ColumnSpan="2"
                    Content="Save Fiscal Year Settings"
                    Command="{Binding SaveFiscalYearSettingsCommand}"
                    HorizontalAlignment="Left"
                    Margin="0,8,0,0" />
              </Grid>
            </GroupBox>
          </StackPanel>
        </ScrollViewer>
      </syncfusion:TabItemExt>
    </syncfusion:TabControlExt>

    <!-- Status Bar -->
    <StatusBar
        DockPanel.Dock="Bottom"
        Background="Transparent">
      <StatusBarItem>
        <TextBlock>
          <Run Text="Settings Status: " />
          <Run Text="{Binding SettingsStatus}" />
        </TextBlock>
      </StatusBarItem>
      <StatusBarItem>
        <TextBlock>
          <Run Text="Last Saved: " />
          <Run Text="{Binding LastSaved}" />
        </TextBlock>
      </StatusBarItem>
      <StatusBarItem>
        <notification:SfBusyIndicator
            IsBusy="{Binding IsLoading}"
            Header="{Binding StatusMessage, FallbackValue='Loading...'}"
            AnimationType="Windmill" />
      </StatusBarItem>
    </StatusBar>
  </DockPanel>
</UserControl>
