<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <OutputType>WinExe</OutputType>
    <TargetFramework>net10.0-windows10.0.26100.0</TargetFramework>
    <TargetPlatformMinVersion>10.0.26100.0</TargetPlatformMinVersion>
    <XamlDebuggingInformation>Full</XamlDebuggingInformation>
    <!-- Prefer the framework-dependent XAML compiler (dotnet) to avoid net472 host issues -->
    <UseXamlCompilerExecutable>false</UseXamlCompilerExecutable>
    <!-- Updated to match Windows App SDK requirements -->
    <WindowsSdkPackageVersion>10.0.26100.38</WindowsSdkPackageVersion>
    <WindowsSdkVersion>10.0.26100.0</WindowsSdkVersion>
    <UseWinUI>true</UseWinUI>
    <!-- Self-contained deployment to include all WindowsAppSDK runtime assets -->
    <WindowsAppSDKSelfContained>true</WindowsAppSDKSelfContained>
    <!-- DeploymentManager is ONLY for packaged apps - disable for unpackaged -->
    <WindowsAppSDKDeploymentManagerInitialize>false</WindowsAppSDKDeploymentManagerInitialize>
    <!-- Bootstrap auto-initializer handles unpackaged app initialization -->
    <WindowsAppSDKBootstrapInitialize>true</WindowsAppSDKBootstrapInitialize>
    <WindowsPackageType>None</WindowsPackageType>
    <!-- Enable XAML metadata generation for unpackaged apps -->
    <XamlGenerateCompilerDeclarations>true</XamlGenerateCompilerDeclarations>
    <!-- Generate library layout and XAML type metadata required for unpackaged apps -->
    <GenerateLibraryLayout>true</GenerateLibraryLayout>
    <GenerateXamlMetadata>true</GenerateXamlMetadata>
    <GenerateXamlSourceInfo>true</GenerateXamlSourceInfo>
    <!-- Workaround for known WindowsAppSDK 1.6.x/1.7.x telemetry assembly issue -->
    <DisableRemovePayloadDuplicatesTask>true</DisableRemovePayloadDuplicatesTask>
    <RootNamespace>WileyWidget.WinUI</RootNamespace>
    <ApplicationManifest>app.manifest</ApplicationManifest>
    <Platforms>x64</Platforms>
    <RuntimeIdentifiers>win-x64</RuntimeIdentifiers>

    <UseWPF>false</UseWPF>
    <!-- Non-packaged build configuration (no MSIX) -->
    <EnableMsixTooling>false</EnableMsixTooling>
    <!-- Prevent MSBuild targets from adding MSIX/Appx capabilities to this project -->
    <DisableMsixProjectCapabilityAddedByProject>true</DisableMsixProjectCapabilityAddedByProject>
    <!-- Allow XAML metadata generation even without PRI -->
    <GenerateAppInstallerFile>false</GenerateAppInstallerFile>
    <AppxAutoIncrementPackageRevision>false</AppxAutoIncrementPackageRevision>
    <GenerateTestArtifacts>false</GenerateTestArtifacts>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <LangVersion>latest</LangVersion>
    <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
    <ProduceReferenceAssembly>true</ProduceReferenceAssembly>
    <!-- Manual AssemblyInfo.cs used for custom attributes -->
    <GenerateAssemblyInfo>false</GenerateAssemblyInfo>
    <NoWarn>NU1902;NU1903</NoWarn>
  </PropertyGroup>

  <!-- Ensure the XAML generator doesn't insert Debugger.Break regardless of configuration -->
  <PropertyGroup>
    <DefineConstants>$(DefineConstants);DISABLE_XAML_GENERATED_BREAK_ON_UNHANDLED_EXCEPTION</DefineConstants>
  </PropertyGroup>

  <PropertyGroup>
    <AppxPackage>false</AppxPackage>
    <AppxPackageSigningEnabled>false</AppxPackageSigningEnabled>
    <WindowsPackageType>None</WindowsPackageType>
    <WindowsAppContainer>false</WindowsAppContainer>
    <GenerateAppxPackageOnBuild>false</GenerateAppxPackageOnBuild>
  </PropertyGroup>

  <!-- Disable auto-generated Debugger.Break in XAML-generated code during Debug builds -->
  <PropertyGroup Condition="'$(Configuration)'=='Debug'">
    <DefineConstants>$(DefineConstants);DISABLE_XAML_GENERATED_BREAK_ON_UNHANDLED_EXCEPTION</DefineConstants>
    <!-- Enable richer XAML debug info so diagnostics can create input.json/output.json and full trace -->
    <XamlDebuggingInformation>Full</XamlDebuggingInformation>
    <EnableXamlGeneratorDebugging>true</EnableXamlGeneratorDebugging>
    <!-- For unpackaged runs we still want generated metadata available -->
    <GenerateXamlMetadata>true</GenerateXamlMetadata>
    <!-- New in WinAppSDK / XAML tooling 1.8.x — increases compiler verbosity to Diagnostic -->
    <XamlCompilerVerbosity>Diagnostic</XamlCompilerVerbosity>
  </PropertyGroup>

  <!-- XAML Files: Let SDK auto-handle Application and Page includes -->
  <ItemGroup>
    <Content Include="Assets\**\*">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
    </Content>
  </ItemGroup>

  <ItemGroup>
    <!-- ====================================================================
         Windows App SDK and WinUI
         ====================================================================

         Package versions are managed centrally in Directory.Packages.props
         at the solution root. DO NOT add Version attributes here.

         ⚠️ CRITICAL: Microsoft.WindowsAppSDK is LOCKED at 1.8.3 in CPM
         Versions 1.6.x/1.7.x have fatal telemetry bugs. DO NOT DOWNGRADE.
         ==================================================================== -->
    <PackageReference Include="Microsoft.Windows.SDK.BuildTools" />
    <PackageReference Include="Microsoft.Windows.CsWinRT" />
    <PackageReference Include="Microsoft.Web.WebView2" />
    <PackageReference Include="Microsoft.WindowsAppSDK" />
    <PackageReference Include="Microsoft.Windows.SDK.BuildTools.MSIX" />

    <!-- CommunityToolkit for MVVM and UI -->
    <PackageReference Include="CommunityToolkit.Mvvm" />
    <PackageReference Include="CommunityToolkit.WinUI.UI.Controls" />

    <!-- LiveCharts2 for charting (open-source, MIT license) -->
    <PackageReference Include="LiveChartsCore.SkiaSharpView.WinUI" />

    <!-- Data Access -->
    <PackageReference Include="Microsoft.EntityFrameworkCore" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Sqlite" />
    <PackageReference Include="Microsoft.Data.SqlClient" />

    <!-- Configuration and Hosting -->
    <PackageReference Include="Microsoft.Extensions.Configuration.EnvironmentVariables" />
    <PackageReference Include="Microsoft.Extensions.Configuration.UserSecrets" />
    <PackageReference Include="Microsoft.Extensions.Configuration.Json" />
    <PackageReference Include="Microsoft.Extensions.Caching.Memory" />
    <PackageReference Include="Microsoft.Extensions.Hosting" />
    <PackageReference Include="Microsoft.Extensions.DependencyInjection" />
    <PackageReference Include="Microsoft.Extensions.Http" />
    <PackageReference Include="Microsoft.Extensions.Logging" />
    <PackageReference Include="Microsoft.Extensions.Logging.Console" />
    <PackageReference Include="Microsoft.Extensions.Options" />

    <!-- Diagnostics and Health Checks -->
    <PackageReference Include="Microsoft.Extensions.Diagnostics.HealthChecks" />
    <PackageReference Include="Microsoft.Extensions.Diagnostics.HealthChecks.ResourceUtilization" />
    <PackageReference Include="Microsoft.Extensions.Diagnostics.HealthChecks.Common" />

    <!-- Logging -->
    <PackageReference Include="Serilog" />
    <PackageReference Include="Serilog.Extensions.Logging" />
    <PackageReference Include="Serilog.Enrichers.Environment" />
    <PackageReference Include="Serilog.Enrichers.Process" />
    <PackageReference Include="Serilog.Enrichers.Thread" />
    <PackageReference Include="Serilog.Settings.Configuration" />
    <PackageReference Include="Serilog.Sinks.Async" />
    <PackageReference Include="Serilog.Sinks.File" />

    <!-- Resilience -->
    <PackageReference Include="Polly" />
    <PackageReference Include="Polly.Extensions.Http" />
    <PackageReference Include="Microsoft.Extensions.Http.Resilience" />

    <!-- Validation -->
    <PackageReference Include="FluentValidation" />

    <!-- Environment Variables -->
    <PackageReference Include="DotNetEnv" />

    <!-- QuickBooks SDK -->
    <PackageReference Include="IppOAuth2PlatformSdk" />
    <PackageReference Include="IppDotNetSdkForQuickBooksApiV3" />

    <Manifest Include="$(ApplicationManifest)" />
  </ItemGroup>

  <!-- Shared Project References -->
  <ItemGroup>
    <ProjectReference Include="..\WileyWidget.Models\WileyWidget.Models.csproj" />
    <ProjectReference Include="..\WileyWidget.Services\WileyWidget.Services.csproj" />
    <ProjectReference Include="..\WileyWidget.Services.Abstractions\WileyWidget.Services.Abstractions.csproj" />
    <ProjectReference Include="..\WileyWidget.Business\WileyWidget.Business.csproj" />
    <ProjectReference Include="..\WileyWidget.Data\WileyWidget.Data.csproj" />
    <ProjectReference Include="..\WileyWidget.Abstractions\WileyWidget.Abstractions.csproj" />
    <!-- Removed reference to WileyWidget.Services.Uno to avoid duplicate SettingsService type conflict -->
  </ItemGroup>

  <!-- Unpackaged Mode Support (for debugging without packaging) -->
  <PropertyGroup Condition="'$(DisableMsixProjectCapabilityAddedByProject)'!='true' and '$(EnableMsixTooling)'=='true'">
    <AppxPackage>true</AppxPackage>
    <AppxPackageSigningEnabled>false</AppxPackageSigningEnabled>
  </PropertyGroup>

  <!-- dotnet-watch exclusions: avoid noisy restarts caused by log/bin/obj changes -->
  <ItemGroup>
    <Watch Remove="logs\**" />
    <Watch Remove="bin\**" />
    <Watch Remove="obj\**" />
    <Watch Remove=".vs\**" />
    <Watch Remove="**\*.user" />
    <Watch Remove="**\*.suo" />
  </ItemGroup>

  <!-- XAML tooling: provide a stable JSON output path for external validators
       Many custom tools (xaml-strict-validator, analyzer scripts) expect
       a JSON payload describing resolved XAML types. This property gives
       those tasks a deterministic location to write/read `xaml.json`. -->
  <PropertyGroup>
    <XamlJsonOutputPath>$(OutDir)xaml.json</XamlJsonOutputPath>
    <XamlGenerateCompilerErrorForResourceReference>True</XamlGenerateCompilerErrorForResourceReference>
  </PropertyGroup>

  <!-- Optional: run the repository's strict XAML validator. Disabled by default; set
       RunXamlValidator=true to enable during local investigation. Validator runs after
       `CompileXaml` so it can inspect finalized XAML sources. Output is written to
       $(OutDir)xaml-validator.log and $(OutDir)xaml.json. -->
  <Target Name="RunXamlValidator" AfterTargets="MarkupCompilePass2;Build" Condition="'$(RunXamlValidator)' == 'true'">
    <Message Importance="High" Text="Running xaml-strict-validator.py (RunXamlValidator=true)" />
    <Exec
      Command="python &quot;$(MSBuildProjectDirectory)\..\..\scripts\tools\xaml-strict-validator.py&quot; &quot;$(MSBuildProjectDirectory)\**\*.xaml&quot; --fix &gt; &quot;$(OutDir)xaml-validator.log&quot; 2&gt;&amp;1"
      ContinueOnError="true" />
    <Copy SourceFiles="$(OutDir)xaml-validator.log" DestinationFolder="$(OutDir)" ContinueOnError="true" />
  </Target>

  <!-- Exclude legacy/duplicate XAML files that live outside the src/ folder
       Some legacy XAML files under the repository `Views\` folder are
       accidentally picked up by SDK wildcard scanning and cause duplicate
       partial-class / namespace collisions with the in-src copies. Remove
       them from compilation so only the `src/` copies are used. -->
  <ItemGroup>
    <Compile Remove="..\..\Views\**\*.xaml" />
  </ItemGroup>

  <!-- Provide a backward-compatible MSBuild entry point used by repo scripts/tools. -->
  <Target Name="CompileXaml" DependsOnTargets="MarkupCompilePass1;XamlPreCompile;MarkupCompilePass2">
    <Message Importance="High" Text="CompileXaml: delegated to MarkupCompilePass1/XamlPreCompile/MarkupCompilePass2" />
  </Target>

</Project>