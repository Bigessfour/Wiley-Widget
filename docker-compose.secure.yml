# Docker Compose configuration with secrets management
# This file demonstrates how to handle sensitive configuration securely

version: "3.8"

services:
  wiley-widget-secure:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.csx-tests
    container_name: wiley-widget-secure
    volumes:
      - ./scripts:/workspaces/Wiley_Widget/scripts:ro
      - ./src:/workspaces/Wiley_Widget/src:ro
      - ./logs:/workspaces/Wiley_Widget/logs:rw
      - wiley-widget-nuget-cache:/tmp/csharp-mcp-packages
    environment:
      - WW_REPO_ROOT=/workspaces/Wiley_Widget
      - WW_LOGS_DIR=/workspaces/Wiley_Widget/logs
      - CSX_ALLOWED_PATH=/workspaces/Wiley_Widget
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
    # Docker secrets for sensitive data
    secrets:
      - github_token
      - database_password
      - api_keys
    working_dir: /workspaces/Wiley_Widget
    command: tail -f /dev/null
    networks:
      - wiley-widget-secure-net
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    restart: unless-stopped
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD-SHELL", "dotnet script --version && echo 'Secure container healthy'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# Define secrets
secrets:
  github_token:
    file: ./secrets/github_token
  database_password:
    file: ./secrets/database_password
  api_keys:
    file: ./secrets/api_keys

volumes:
  wiley-widget-nuget-cache:
    driver: local

networks:
  wiley-widget-secure-net:
    driver: bridge
    internal: true # Isolated network for security
