# Dockerfile for running RegionViewRegistry xUnit tests in isolation
# Based on .NET 9.0 SDK with WPF support

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build

# Install required dependencies for WPF testing
RUN apt-get update && apt-get install -y \
    libx11-6 \
    libx11-xcb1 \
    libxcb1 \
    libxrender1 \
    libxrandr2 \
    libxi6 \
    libxext6 \
    libxfixes3 \
    libxcursor1 \
    libxcomposite1 \
    libxdamage1 \
    libfontconfig1 \
    libcairo2 \
    libcups2 \
    libdbus-1-3 \
    libexpat1 \
    libffi8 \
    libgcc1 \
    libglib2.0-0 \
    libgpg-error0 \
    libice6 \
    libsm6 \
    libpcre3 \
    libstdc++6 \
    libuuid1 \
    libx11-xcb1 \
    libxau6 \
    libxcb1 \
    libxdmcp6 \
    zlib1g \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /src

# Copy solution and project files for dependency resolution
COPY ["WileyWidget.sln", "./"]
COPY ["WileyWidget.csproj", "./"]
COPY ["WileyWidget.Tests/WileyWidget.Tests.csproj", "WileyWidget.Tests/"]
COPY ["WileyWidget.Models/WileyWidget.Models.csproj", "WileyWidget.Models/"]
COPY ["WileyWidget.Business/WileyWidget.Business.csproj", "WileyWidget.Business/"]
COPY ["Directory.Build.props", "./"]
COPY ["Directory.Build.targets", "./"]
COPY ["Directory.Packages.props", "./"]

# Restore dependencies
RUN dotnet restore "WileyWidget.Tests/WileyWidget.Tests.csproj" \
    --runtime linux-x64 \
    --verbosity normal

# Copy the entire test project source
COPY ["WileyWidget.Tests/", "WileyWidget.Tests/"]
COPY ["WileyWidget.Models/", "WileyWidget.Models/"]
COPY ["WileyWidget.Business/", "WileyWidget.Business/"]

# Copy required source files (minimal set for test compilation)
COPY ["src/", "src/"]

# Build the test project
RUN dotnet build "WileyWidget.Tests/WileyWidget.Tests.csproj" \
    --configuration Release \
    --no-restore \
    --verbosity normal

# Run specific RegionViewRegistry tests
FROM build AS test
WORKDIR /src/WileyWidget.Tests

# Set environment variables for headless testing
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1
ENV DISPLAY=:99

# Run only RegionViewRegistry tests with detailed output
ENTRYPOINT ["dotnet", "test", \
    "WileyWidget.Tests.csproj", \
    "--configuration", "Release", \
    "--no-build", \
    "--no-restore", \
    "--logger", "console;verbosity=detailed", \
    "--filter", "FullyQualifiedName~RegionViewRegistryTests", \
    "--results-directory", "/testresults", \
    "--collect", "XPlat Code Coverage"]

# Optional: Create a stage for running tests with volume mounting
FROM build AS test-volume
WORKDIR /src

# This allows mounting the test project from host for iterative development
# Usage: docker run -v $(pwd)/WileyWidget.Tests:/src/WileyWidget.Tests test-volume
ENTRYPOINT ["dotnet", "test", \
    "WileyWidget.Tests/WileyWidget.Tests.csproj", \
    "--configuration", "Release", \
    "--logger", "console;verbosity=detailed", \
    "--filter", "FullyQualifiedName~RegionViewRegistryTests", \
    "--results-directory", "/testresults"]
