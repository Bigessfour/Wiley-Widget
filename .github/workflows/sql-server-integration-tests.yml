name: SQL Server Integration Tests

permissions:
  contents: read

on:
  workflow_dispatch: {}
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  sql-integration-tests:
    # NOTE: job-level 'if' cannot safely reference secrets (actionlint will flag it)
    # We'll guard runtime behavior inside steps (set SKIP_SQL_TESTS via GITHUB_ENV)
    name: SQL Server (SQL Express mode) integration tests
    runs-on: windows-latest
    timeout-minutes: 60
    env:
      DOTNET_CLI_TELEMETRY_OPTOUT: '1'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Validate credentials / decide to run
        shell: pwsh
        run: |
          if (-not $env:MSSQL_SA_PASSWORD -and -not $env:TEST_SQL_CONNECTIONSTRING) {
            Write-Warning 'No MSSQL_SA_PASSWORD secret or TEST_SQL_CONNECTIONSTRING provided — skipping SQL Server integration tests.'
            # Mark skip flag for later steps and exit successfully so the job doesn't fail
            Add-Content -Path $Env:GITHUB_ENV -Value "SKIP_SQL_TESTS=true"
            exit 0
          }

      - name: Cache + optional retry helper (dotnet-cache-retry)
        uses: ./.github/actions/dotnet-cache-retry
        with:
          lockfile-globs: '**/packages.lock.json'
          key-prefix: sql-integration-nuget

      - name: Start SQL Server container (mcr.microsoft.com/mssql/server:2019-latest)
        if: env.SKIP_SQL_TESTS != 'true'
        shell: pwsh
        env:
          SA_PASS: ${{ secrets.MSSQL_SA_PASSWORD }}
        run: |
          if (-not $env:SA_PASS) { Write-Host 'Using TEST_SQL_CONNECTIONSTRING directly; skipping container start'; exit 0 }

          Write-Host 'Starting SQL Server container (2019-latest) for integration tests'
          docker pull mcr.microsoft.com/mssql/server:2019-latest
          docker run --name sqlsrv_integration_test -e 'ACCEPT_EULA=Y' -e "MSSQL_SA_PASSWORD=$env:SA_PASS" -p 1433:1433 -d mcr.microsoft.com/mssql/server:2019-latest

          # Wait for readiness by running sqlcmd INSIDE the container. This is much more reliable
          # than scanning logs when log verbosity is noisy. We attempt a connection repeatedly
          # (up to ~5 minutes) and fall back to log scanning if sqlcmd isn't present.
          $ready = $false
          for ($i=0; $i -lt 60; $i++) {
            try {
              # Try executing sqlcmd inside the container. The mssql-server image includes sqlcmd
              # at /opt/mssql-tools/bin/sqlcmd when tools are available.
              docker exec -i sqlsrv_integration_test /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P $env:SA_PASS -Q "SET NOCOUNT ON; SELECT 1" > $null 2>&1
              if ($LASTEXITCODE -eq 0) { $ready = $true; break }
            } catch {
              # If sqlcmd isn't available in the container we fall back to the old log-based approach.
            }

            # Fallback: scan logs for the known readiness message
            $logs = (docker logs sqlsrv_integration_test 2>&1) -join "\n"
            if ($logs -match 'SQL Server is now ready for client connections') { $ready = $true; break }
            Start-Sleep -Seconds 5
          }

          if (-not $ready) {
            Write-Error 'SQL Server container did not become ready in time. Docker logs:'
            docker logs sqlsrv_integration_test | Write-Output
            exit 1
          }

      - name: Build solution
        if: env.SKIP_SQL_TESTS != 'true'
        uses: ./.github/actions/dotnet-cache-retry
        with:
          run-command: |
            dotnet clean WileyWidget.sln --verbosity minimal;
            dotnet restore WileyWidget.sln --verbosity minimal;
            dotnet build WileyWidget.sln --configuration Release --no-restore --verbosity minimal
          attempts: '3'

      - name: Prepare SQL connection string for tests
        if: env.SKIP_SQL_TESTS != 'true'
        shell: pwsh
        env:
          TEST_SQL_CONNECTIONSTRING: ${{ secrets.TEST_SQL_CONNECTIONSTRING }}
          TEST_SQL_AUTOCONSTRUCT: ${{ secrets.MSSQL_SA_PASSWORD }}
        run: |
          # prefer an explicit connection string provided via secret
          if ($env:TEST_SQL_CONNECTIONSTRING) {
            $conn = $env:TEST_SQL_CONNECTIONSTRING
          } elseif ($env:TEST_SQL_AUTOCONSTRUCT) {
            $pwd = $env:TEST_SQL_AUTOCONSTRUCT
            $conn = "Server=127.0.0.1,1433;Initial Catalog=WileyWidgetIntegrationTest;User Id=sa;Password=$pwd;TrustServerCertificate=True;"
            Write-Host 'Using auto-constructed TEST_SQL_CONNECTIONSTRING from MSSQL_SA_PASSWORD secret.'
          } else {
            Write-Warning 'No TEST_SQL_CONNECTIONSTRING or MSSQL_SA_PASSWORD — skipping tests'
            exit 78
          }

          Write-Host "Using connection string: [hidden] (server portion: $($conn.Split(';')[0]))"
          "TEST_SQL_CONNECTIONSTRING=$conn" | Out-File -FilePath $Env:GITHUB_ENV -Append -Encoding utf8

      - name: Run SQL integration tests (Category=Database.SqlExpress)
        if: env.SKIP_SQL_TESTS != 'true'
        uses: ./.github/actions/dotnet-cache-retry
        with:
          run-command: |
            dotnet test WileyWidget.IntegrationTests/WileyWidget.IntegrationTests.csproj --configuration Release --filter "Category=Database.SqlExpress" --verbosity minimal
          attempts: '3'

      - name: Stop and cleanup SQL Server container
        if: always()
        shell: pwsh
        env:
          SA_PASS: ${{ secrets.MSSQL_SA_PASSWORD }}
        run: |
          if (docker ps -a --format "{{.Names}}" | Select-String -Pattern "sqlsrv_integration_test") {
            Write-Host 'Stopping and removing SQL Server container'
            docker rm -f sqlsrv_integration_test || Write-Host 'Container cleanup failed (already removed or not running)'
          } else {
            Write-Host 'No container to remove'
          }
