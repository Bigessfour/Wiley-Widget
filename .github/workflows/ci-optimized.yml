name: CI/CD Pipeline (Trunk Integrated)

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "README.md"
      - "CHANGELOG.md"
      - .github/ISSUE_TEMPLATE/**
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

env:
  DOTNET_VERSION: 9.0.x
  NODE_VERSION: "22.x"

jobs:
  # Phase 1: Health Validation & Setup
  health-check:
    name: "Health Validation"
    runs-on: ubuntu-latest
    outputs:
      should_skip: ${{ steps.skip_check.outputs.should_skip }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for documentation-only changes
        id: skip_check
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # Check if only docs changed
            CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }})
            if echo "$CHANGED_FILES" | grep -qE '\.(md|txt|yml|yaml)$' && ! echo "$CHANGED_FILES" | grep -qE '\.(cs|csx|py|ps1|json)$'; then
              echo "should_skip=true" >> $GITHUB_OUTPUT
              echo "üìö Documentation-only changes detected - skipping full pipeline"
            else
              echo "should_skip=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "should_skip=false" >> $GITHUB_OUTPUT
          fi

  # Phase 2: Build & Test Matrix
  build-and-test:
    name: "Build & Test (${{ matrix.os }})"
    needs: health-check
    if: needs.health-check.outputs.should_skip != 'true'
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        include:
          - os: ubuntu-latest
            dotnet-sdk: "9.0.x"
          - os: windows-latest
            dotnet-sdk: "9.0.x"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET ${{ matrix.dotnet-sdk }}
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-sdk }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            echo "Running restore with EnableWindowsTargeting=true for non-Windows runner"
            dotnet restore WileyWidget.sln /p:EnableWindowsTargeting=true
          else
            dotnet restore WileyWidget.sln
          fi

      - name: Build solution
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            echo "Building on non-Windows runner with EnableWindowsTargeting=true"
            dotnet build WileyWidget.sln --configuration Release --no-restore --verbosity minimal /p:EnableWindowsTargeting=true
          else
            dotnet build WileyWidget.sln --configuration Release --no-restore --verbosity minimal
          fi

      - name: Run unit tests
        run: |
          dotnet test WileyWidget.sln \
            --configuration Release \
            --no-build \
            --verbosity normal \
            --logger "trx;LogFileName=test-results.trx" \
            --logger "console;verbosity=detailed" \
            --results-directory TestResults \
            --collect:"XPlat Code Coverage" \
            --settings tests/.runsettings

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: TestResults/

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        if: matrix.os == 'ubuntu-latest'
        with:
          file: ./TestResults/*/coverage.cobertura.xml
          flags: unittests
          name: codecov-umbrella

  # Phase 3: Quality Assurance (Trunk)
  quality-assurance:
    name: Quality Assurance
    needs: [health-check, build-and-test]
    if: needs.health-check.outputs.should_skip != 'true' && !failure()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup Trunk
        uses: trunk-io/trunk-action/setup@v1
        with:
          version: 1.25.0

      - name: Run Trunk check (CI mode)
        run: trunk check --ci --upload --series=ci-${{ github.run_number }} --filter=gitleaks,trufflehog,osv-scanner

      - name: Upload Trunk results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: trunk-results
          path: .trunk/

  # Phase 4: CSX Integration Tests
  csx-tests:
    name: "CSX Integration Tests"
    needs: [health-check, build-and-test]
    if: needs.health-check.outputs.should_skip != 'true' && !failure()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build CSX Docker image
        run: docker build -t wiley-widget/csx-mcp:ci -f docker/Dockerfile.csx-tests .

      - name: Create test directories
        run: |
          mkdir -p logs
          mkdir -p test-logs

      - name: Run CSX tests
        run: |
          # Run critical CSX tests
          docker run --rm \
            -v $(pwd):/app \
            -v $(pwd)/logs:/logs \
            -v $(pwd)/test-logs:/test-logs \
            -e WW_REPO_ROOT=/app \
            -e WW_LOGS_DIR=/logs \
            -w /app \
            wiley-widget/csx-mcp:ci \
            scripts/examples/csharp/30-enterprise-validation-test.csx || exit 1

          docker run --rm \
            -v $(pwd):/app \
            -v $(pwd)/logs:/logs \
            -v $(pwd)/test-logs:/test-logs \
            -e WW_REPO_ROOT=/app \
            -e WW_LOGS_DIR=/logs \
            -w /app \
            wiley-widget/csx-mcp:ci \
            scripts/examples/csharp/31-navigation-async-test.csx || exit 1

      - name: Upload CSX test logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: csx-test-logs
          path: |
            test-logs/
            logs/

  # Phase 5: Python Validation
  python-validation:
    name: "Python Validation"
    needs: health-check
    if: needs.health-check.outputs.should_skip != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run startup validator
        run: python tests/test_startup_validator.py

      - name: Run CSX file tests
        run: python test_csx_files.py

  # Phase 6: Security Scan
  security-scan:
    name: "Security Scan"
    needs: health-check
    if: needs.health-check.outputs.should_skip != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  # Phase 7: Deployment Readiness
  deploy-readiness:
    name: "Deployment Readiness"
    needs: [build-and-test, quality-assurance, csx-tests, python-validation, security-scan]
    if: needs.health-check.outputs.should_skip != 'true' && !failure()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Publish application
        run: |
          # Prefer Uno project (post-migration); fall back to WinUI project if present
          if [ -f src/WileyWidget.Uno/WileyWidget.Uno.csproj ]; then
            echo "Publishing WileyWidget.Uno"
            dotnet publish src/WileyWidget.Uno/WileyWidget.Uno.csproj \
              --configuration Release \
              --runtime win-x64 \
              --self-contained true \
              --output ./publish/win-x64
          elif [ -f src/WileyWidget.WinUI/WileyWidget.WinUI.csproj ]; then
            echo "Publishing WileyWidget.WinUI"
            dotnet publish src/WileyWidget.WinUI/WileyWidget.WinUI.csproj \
              --configuration Release \
              --runtime win-x64 \
              --self-contained true \
              --output ./publish/win-x64
          else
            echo "No publishable project found (expected WileyWidget.Uno or WileyWidget.WinUI)";
            ls -la src || true
            exit 1
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wiley-widget-win-x64
          path: ./publish/win-x64/

      - name: Generate manifest
        run: |
          python scripts/tools/generate_repo_urls.py -o ai-fetchable-manifest.json

      - name: Upload manifest
        uses: actions/upload-artifact@v4
        with:
          name: ai-manifest
          path: ai-fetchable-manifest.json

  # Phase 8: Success Monitoring
  success-monitoring:
    name: "Success Monitoring"
    needs: deploy-readiness
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js for analytics
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install analytics dependencies
        run: npm ci

      - name: Upload analytics data
        run: |
          # Custom analytics upload logic here
          echo "Pipeline completed with status: ${{ job.status }}"
          # Add your analytics/metrics collection here

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Pipeline failed - check artifacts for detailed logs"
          echo "üìä Test results and coverage reports available in artifacts"
          echo "üîç Trunk quality results available in trunk-results artifact"
