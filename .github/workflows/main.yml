name: Grok Code Review

on:
  pull_request: 
    branches: [main, develop]
    paths:
      - src/**/*.cs
      - tests/**/*.cs
      - .github/workflows/**

permissions:
  contents: read
  pull-requests:  write

jobs:
  grok-review:
    name:  Grok-powered PR Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name:  Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for proper diff

      - name: Get PR diff
        id: diff
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event. pull_request.head.sha }}

          DIFF=$(git diff $BASE_SHA..$HEAD_SHA -- \
            'src/**/*. cs' 'tests/**/*.cs' \
            --unified=3 \
            --diff-filter=ACMTU 2>/dev/null | head -20000)

          echo "$DIFF" > /tmp/pr.diff

          LINES_CHANGED=$(echo "$DIFF" | grep -c '^[+-]' || echo 0)
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
          echo "diff_size=$(wc -c < /tmp/pr.diff)" >> $GITHUB_OUTPUT

      - name: Skip if no significant changes
        if: steps.diff.outputs.lines_changed < 10
        run: |
          echo "No significant C# changes detected (only ${{ steps.diff.outputs.lines_changed }} lines); skipping Grok review"
          exit 0

      - name: Check for API key
        id: check_key
        run: |
          if [ -z "${{ secrets.XAI_API_KEY }}" ]; then
            echo "has_key=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è XAI_API_KEY not found in secrets"
          else
            echo "has_key=true" >> $GITHUB_OUTPUT
            echo "‚úì XAI_API_KEY found"
          fi

      - name:  Notify if API key missing
        if: steps.check_key.outputs.has_key == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context. issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ö†Ô∏è **Grok review skipped**: `XAI_API_KEY` secret not configured in repository settings.\n\nTo enable Grok reviews, add your xAI API key at: Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí New repository secret'
            });

      - name: Prepare review prompt
        if: steps.check_key.outputs.has_key == 'true'
        id: prompt
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github. event.pull_request.body }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          DIFF=$(cat /tmp/pr.diff)

          if [ ${#DIFF} -gt 15000 ]; then
            DIFF=$(echo "$DIFF" | head -c 15000)
            DIFF="$DIFF\n\n... (diff truncated due to size)"
          fi

          # Full static prompt - tailored for Wiley-Widget (Syncfusion WinForms)
          PROMPT=$(cat << 'EOF'
You are a senior code reviewer for the Wiley-Widget project: a . NET 10 Windows Forms municipal dashboard using Syncfusion controls (v30+), SfSkinManager as the single source of truth for theming (Office2019Colorful default), and strict MCP filesystem rules.

Review ONLY the changed code in the provided diff. Focus on:
- Theme consistency: NO manual Color.FromArgb, BrushInfo, or per-control styling.  All colors/theme must come from SfSkinManager or IThemeService.
- Syncfusion API usage: Correct properties, events, and docking (SetDockLabel, ThemeName inheritance).
- Testability: ViewModels should expose interfaces for mocking; avoid parameterless ctor issues in Moq.
- WinForms best practices: Proper disposal, no blocking calls, STA-friendly.
- Security/secrets: No hard-coded keys or paths. 
- Performance: Avoid heavy ops in UI thread.
- General: Clean, modern C# (.NET 10 features encouraged).

Be concise but specific. Use markdown. Start with overall verdict (LGTM / Needs work), then bullet points.  End with approval status.
EOF
)

          # Escape for JSON
          ESCAPED_PROMPT=$(echo "$PROMPT" | jq -Rs .)
          ESCAPED_DIFF=$(echo "$DIFF" | jq -Rs .)
          ESCAPED_TITLE=$(echo "$PR_TITLE" | jq -Rs .)

          cat << EOF > /tmp/grok_request.json
{
  "model": "grok-beta",
  "messages": [
    {
      "role": "system",
      "content": $ESCAPED_PROMPT
    },
    {
      "role":  "user",
      "content":  "PR Title: $PR_TITLE\nAuthor:  @$PR_AUTHOR\n\nDiff:\n$ESCAPED_DIFF"
    }
  ],
  "temperature":  0.5,
  "max_tokens": 2048
}
EOF

          echo "prompt_prepared=true" >> $GITHUB_OUTPUT

      - name:  Call Grok API
        if: steps.check_key.outputs.has_key == 'true'
        id: grok
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $XAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @/tmp/grok_request.json)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_CODE/d')

          echo "HTTP status: $HTTP_CODE"
          echo "$BODY" > /tmp/grok_response.json

          if [ "$HTTP_CODE" != "200" ]; then
            ERROR_MSG=$(echo "$BODY" | jq -r '.error.message // "Unknown API error"')
            echo "grok_error=true" >> $GITHUB_OUTPUT
            echo "grok_error_msg=$ERROR_MSG" >> $GITHUB_OUTPUT
            echo ":: error:: Grok API error: $ERROR_MSG"
            exit 1
          fi

          REVIEW=$(echo "$BODY" | jq -r '.choices[0].message.content // "No review content returned"')
          echo "$REVIEW" > /tmp/grok_review.txt
          echo "grok_success=true" >> $GITHUB_OUTPUT

      - name: Post review as PR comment
        if:  steps.grok.outputs.grok_success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/grok_review.txt', 'utf8').trim();
            const comment = `## ü§ñ Grok Code Review

${review}

---
*Generated by Grok (xAI) ‚Ä¢ Model: grok-beta ‚Ä¢ Workflow: \`grok-code-review.yml\`*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Handle API errors
        if: failure() && steps.grok.outputs.grok_error == 'true'
        uses: actions/github-script@v7
        with: 
          script: |
            const errMsg = '${{ steps.grok.outputs.grok_error_msg || 'Unknown error during Grok review' }}';
            await github.rest.issues. createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ö†Ô∏è **Grok Review Failed**

**Error**: ${errMsg}

**Troubleshooting**:
- Verify \`XAI_API_KEY\` is valid and not expired
- Check xAI API status and rate limits
- Review workflow logs for detailed error information

[View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})`
            });
