name: Syncfusion Theming Compliance

on:
  pull_request:
    paths:
      - src/WileyWidget.WinForms/**/*.cs
      - scripts/check-syncfusion-theming.py
      - .github/workflows/syncfusion-theming.yml
  push:
    branches: [main]
    paths:
      - src/WileyWidget.WinForms/**/*.cs
      - scripts/check-syncfusion-theming.py
      - .github/workflows/syncfusion-theming.yml

permissions:
  contents: read
  checks: write

jobs:
  check-theming:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11
      - name: Run Syncfusion theming compliance check
        run: |
          chmod +x scripts/check-syncfusion-theming.py
          scripts/check-syncfusion-theming.py

  # Headless MCP validation: starts MCP server and validates form themes via MCP APIs
  mcp-form-validation:
    runs-on: windows-latest
    timeout-minutes: 15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore NuGet packages for solution
        shell: powershell
        run: dotnet restore WileyWidget.sln --verbosity minimal

      - name: Restore NuGet packages for MCP Server
        shell: powershell
        run: dotnet restore tools/WileyWidgetMcpServer/WileyWidgetMcpServer.csproj --verbosity minimal

      - name: Build MCP Server
        shell: powershell
        run: dotnet build tools/WileyWidgetMcpServer/WileyWidgetMcpServer.csproj --configuration Release --no-restore --verbosity minimal

      - name: Run MCP Form Theme Validation
        shell: pwsh
        timeout-minutes: 10
        run: |
          # Start MCP server in background
          $mcpJob = Start-Job -Name "mcp-server" -ScriptBlock {
            Set-Location "$using:PWD"
            dotnet run --project tools/WileyWidgetMcpServer/WileyWidgetMcpServer.csproj --configuration Release --no-build --urls http://localhost:5000 2>&1
          }

          # Wait for server to start
          Write-Host "Waiting for MCP server to start..."
          Start-Sleep -Seconds 3

          $maxRetries = 10
          $retries = 0
          while ($retries -lt $maxRetries) {
            try {
              $response = Invoke-WebRequest -Uri http://localhost:5000/health -Method GET -TimeoutSec 2 -ErrorAction Stop
              if ($response.StatusCode -eq 200) {
                Write-Host "MCP server is healthy"
                break
              }
            } catch {
              $retries++
              if ($retries -lt $maxRetries) {
                Start-Sleep -Seconds 1
              } else {
                Write-Error "MCP server failed to start after $maxRetries attempts"
                Stop-Job -Job $mcpJob -Force
                Remove-Job -Job $mcpJob
                exit 1
              }
            }
          }

          # Run MCP form validation
          Write-Host "Running MCP form theme validation..."
          try {
            $validationResult = Invoke-WebRequest -Uri http://localhost:5000/api/validate-themes `
              -Method POST `
              -ContentType "application/json" `
              -Body '{"expectedTheme": "Office2019Colorful"}' `
              -ErrorAction Stop

            Write-Host "Validation response: $($validationResult.StatusCode)"
            Write-Host $validationResult.Content

            if ($validationResult.StatusCode -ne 200) {
              Write-Error "Form theme validation failed with status $($validationResult.StatusCode)"
              throw "Form theme validation failed"
            }
          } catch {
            Write-Error "Failed to call MCP validation endpoint: $_"
            throw $_
          } finally {
            # Stop MCP server
            Write-Host "Stopping MCP server..."
            try {
              Stop-Job -Job $mcpJob -ErrorAction SilentlyContinue
              Remove-Job -Job $mcpJob -ErrorAction SilentlyContinue
            } catch {
              Write-Host "Note: MCP server cleanup had issues (non-fatal): $_"
            }
          }
