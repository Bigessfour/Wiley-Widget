name: Build & WinForms Integration Check

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]
  workflow_dispatch: {}

permissions:
  contents: read
  checks: write

concurrency:
  group: build-winforms-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    name: Build & WinForms Startup Test (${{ matrix.config.name }})
    runs-on: windows-2022
    timeout-minutes: 35
    strategy:
      fail-fast: false
      matrix:
        config:
          - name: default
            dashboardAutoLoad: "true"
            disableDocking: "false"
            disableRibbon: "false"
          - name: no-docking
            dashboardAutoLoad: "true"
            disableDocking: "true"
            disableRibbon: "false"
          - name: no-ribbon
            dashboardAutoLoad: "true"
            disableDocking: "false"
            disableRibbon: "true"
          - name: no-dashboard
            dashboardAutoLoad: "false"
            disableDocking: "false"
            disableRibbon: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
          key: nuget-packages-${{ runner.os }}-${{ hashFiles('**/*.csproj', '**/*.props', '**/*.targets') }}
          restore-keys: nuget-packages-${{ runner.os }}-

      - name: Diagnostic - checkout, git and ThemeService checks
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Continue'
          Write-Host "Git branch: $(git rev-parse --abbrev-ref HEAD)"
          Write-Host "Git commit: $(git rev-parse --short HEAD)"
          git remote -v > ci-git-remote.txt
          git status --porcelain -uall > ci-git-status.txt
          git log -n 5 --pretty=oneline > ci-git-log.txt
          git show --name-only HEAD > ci-git-show.txt
          Write-Host "Repository root: $(git rev-parse --show-toplevel)"
          Write-Host "Listing WileyWidget.WinForms Services folder (git ls-files):"
          git ls-files "src/WileyWidget.WinForms/Services" > ci-services-files.txt
          if (!(Test-Path ci-services-files.txt) -or ((Get-Content ci-services-files.txt) -eq '')) {
            Write-Host "git ls-files returned nothing, falling back to directory listing"
            Get-ChildItem -Path src\\WileyWidget.WinForms\\Services -File -ErrorAction SilentlyContinue | ForEach-Object { $_.Name } | Out-File ci-services-files.txt
          }

          if (Test-Path src\\WileyWidget.WinForms\\Services\\ThemeService.cs) {
            Write-Host 'ThemeService.cs FOUND'
            # Save head and tail of file for diagnostics
            Get-Content -Path src\\WileyWidget.WinForms\\Services\\ThemeService.cs -TotalCount 200 | Out-File theme-content-head.txt
            Get-Content -Path src\\WileyWidget.WinForms\\Services\\ThemeService.cs -Tail 200 | Out-File theme-content-tail.txt
            Get-Content -Path src\\WileyWidget.WinForms\\Services\\ThemeService.cs -TotalCount 400 | Out-File theme-content.txt
          } else {
            Write-Host 'ThemeService.cs MISSING'
            'ThemeService.cs MISSING' | Out-File theme-content.txt
          }

          Select-String -Path src\\WileyWidget.WinForms\\WileyWidget.WinForms.csproj -Pattern '<Compile' | Out-File csproj-compile.txt -ErrorAction SilentlyContinue
          dotnet --info > dotnet-info.txt
          dotnet --list-sdks > sdks.txt

      - name: Restore solution
        run: dotnet restore WileyWidget.sln --verbosity minimal

      - name: Build solution (capture log)
        shell: pwsh
        run: |
          dotnet build WileyWidget.sln --configuration Release --no-restore --verbosity minimal *>&1 | Tee-Object -FilePath build.log
          if ($LASTEXITCODE -ne 0) { Write-Error "Build failed; see build.log" }

      - name: Syncfusion 32.2.3 Architecture Compliance
        shell: pwsh
        run: |
          # Baselines represent known existing violations at time of check introduction (2026-02-28).
          # Build FAILS if violation count EXCEEDS the baseline (regression detected).
          # Build PASSES (with warnings) if violations stay at or below baseline.
          # Reduce baselines as violations are fixed.
          $factoryBaseline = 10
          $themeBaseline   = 20
          $failed = $false

          # 1 — Version pin: every Syncfusion package entry must be exactly 32.2.3 (hard fail)
          $drift = Select-String -Path 'Directory.Packages.props' -Pattern 'Include="Syncfusion\.' |
                   Where-Object { $_.Line -notmatch 'Version="32\.2\.3"' }
          if ($drift) {
            Write-Error "❌ Syncfusion version drift detected (expected 32.2.3 — update baseline or revert package change):"
            $drift | ForEach-Object { Write-Host "  LINE $($_.LineNumber): $($_.Line.Trim())" }
            $failed = $true
          } else {
            Write-Host "✅ Version pin: all Syncfusion packages = 32.2.3"
          }

          # 2 — Factory enforcement: no direct Syncfusion control instantiation outside factory/designer files
          $controlPattern = 'new\s+(SfDataGrid|SfListView|SfTreeGrid|SfButton|SfComboBox|SfGroupView|SfDateTimeEdit|SfNumericTextBox|SfDatePicker|SfTimePicker|SfCalendar|SfMaskedEdit|SfBadge)\s*[({]'
          $directNew = git grep -n -E $controlPattern -- 'src/WileyWidget.WinForms' 2>$null |
                       Where-Object { $_ -notmatch 'SyncfusionControlFactory\.cs|ControlFactory\.cs|\.Designer\.cs' }
          $factoryCount = ($directNew | Measure-Object).Count
          if ($factoryCount -gt $factoryBaseline) {
            Write-Error "❌ Factory violations INCREASED from baseline $factoryBaseline → $factoryCount. New direct instantiations must use SyncfusionControlFactory:"
            $directNew | ForEach-Object { Write-Host "  $_" }
            $failed = $true
          } elseif ($factoryCount -gt 0) {
            Write-Warning "⚠️  Factory enforcement: $factoryCount existing violation(s) (baseline=$factoryBaseline, no regression). Fix these to reduce the baseline."
            $directNew | ForEach-Object { Write-Host "  $_" }
          } else {
            Write-Host "✅ Factory enforcement: no direct Syncfusion control instantiation detected"
          }

          # 3 — Theme authority: no manual BackColor/ForeColor (semantic Color.Red/Green/Orange excepted)
          $colorHits = git grep -n -E '\.(BackColor|ForeColor)\s*=' -- 'src/WileyWidget.WinForms' 2>$null |
                       Where-Object { $_ -notmatch 'Color\.(Red|Green|Orange|Transparent)' } |
                       Where-Object { $_ -notmatch '//\s*OK:' }
          $themeCount = ($colorHits | Measure-Object).Count
          if ($themeCount -gt $themeBaseline) {
            Write-Error "❌ Theme violations INCREASED from baseline $themeBaseline → $themeCount. New manual color assignments bypass SfSkinManager:"
            $colorHits | ForEach-Object { Write-Host "  $_" }
            $failed = $true
          } elseif ($themeCount -gt 0) {
            Write-Warning "⚠️  Theme authority: $themeCount existing violation(s) (baseline=$themeBaseline, no regression). Fix these to reduce the baseline."
            $colorHits | ForEach-Object { Write-Host "  $_" }
          } else {
            Write-Host "✅ Theme authority: no unauthorized BackColor/ForeColor assignments"
          }

          Write-Host ""
          Write-Host "── Syncfusion Compliance Summary ──────────────────"
          Write-Host "  Version pin:        $(if (-not $drift) { '✅ PASS' } else { '❌ FAIL' })"
          Write-Host "  Factory violations: $factoryCount / $factoryBaseline baseline $(if ($factoryCount -gt $factoryBaseline) { '❌ REGRESSION' } elseif ($factoryCount -gt 0) { '⚠️  existing debt' } else { '✅ CLEAN' })"
          Write-Host "  Theme violations:   $themeCount / $themeBaseline baseline $(if ($themeCount -gt $themeBaseline) { '❌ REGRESSION' } elseif ($themeCount -gt 0) { '⚠️  existing debt' } else { '✅ CLEAN' })"
          Write-Host "────────────────────────────────────────────────────"

          if ($failed) { exit 1 }

      - name: Discover WinForms startup test
        shell: pwsh
        run: |
          dotnet test tests/WileyWidget.WinForms.Tests/WileyWidget.WinForms.Tests.csproj `
            --configuration Release `
            --no-build `
            --list-tests `
            --filter "FullyQualifiedName~MainFormStartupIntegrationTests" `
            -v minimal *>&1 | Tee-Object -FilePath test-discovery.log

      - name: Run WinForms startup test (capture log)
        continue-on-error: true
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path artifacts | Out-Null
          dotnet test tests/WileyWidget.WinForms.Tests/WileyWidget.WinForms.Tests.csproj `
            --configuration Release `
            --no-build `
            --filter "FullyQualifiedName=WileyWidget.WinForms.Tests.Startup.MainFormStartupIntegrationTests.FullStartup_NormalConfig_SucceedsWithoutExceptions" `
            --logger "console;verbosity=detailed" `
            --logger "trx;LogFileName=startup-test.trx" `
            --results-directory ${{ github.workspace }}\TestResults *>&1 | Tee-Object -FilePath test.log
          Set-Content -Path test-exitcode.txt -Value $LASTEXITCODE
        env:
          WILEYWIDGET_TEST_DASHBOARD_AUTOLOAD: ${{ matrix.config.dashboardAutoLoad }}
          WILEYWIDGET_TEST_DISABLE_DOCKING: ${{ matrix.config.disableDocking }}
          WILEYWIDGET_TEST_DISABLE_RIBBON: ${{ matrix.config.disableRibbon }}
          WILEYWIDGET_TEST_ARTIFACTS_DIR: ${{ github.workspace }}\artifacts
          WILEYWIDGET_TEST_SCREENSHOT_ON_FAILURE: "true"

      - name: Diagnostic - list test results and logs
        if: always()
        shell: pwsh
        run: |
          Get-ChildItem -Path ${{ github.workspace }} -Recurse -Filter *.trx -File | Select-Object FullName > trx-files.txt
          Get-ChildItem -Path ${{ github.workspace }} -Recurse -Filter *.log -File | Select-Object FullName > log-files.txt

      - name: Publish test results
        if: always()
        uses: dorny/test-reporter@v2
        with:
          name: WinForms Startup Test
          path: "**/TestResults/**/*.trx"
          reporter: dotnet-trx
          fail-on-error: false
          fail-on-empty: false

      - name: Upload artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts-${{ matrix.config.name }}
          path: "**/TestResults/**"
          retention-days: 7

      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failure-artifacts-${{ matrix.config.name }}
          path: |
            **/TestResults/**
            **/*.log
            **/*-screenshot.png
          retention-days: 7

      - name: Upload CI diagnostic artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-diagnostics-${{ matrix.config.name }}
          path: |
            build.log
            test.log
            test-discovery.log
            test-exitcode.txt
            trx-files.txt
            log-files.txt
            artifacts/control-tree.txt
            artifacts/*.png
            ci-*.txt
            theme-content*.txt
            sdks.txt
            dotnet-info.txt
            src/WileyWidget.WinForms/Services/ThemeService.cs
            src/WileyWidget.WinForms/WileyWidget.WinForms.csproj
          retention-days: 7

  ribbon-stress:
    name: Ribbon Stress Script (net10)
    runs-on: windows-2022
    timeout-minutes: 25

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore solution
        run: dotnet restore WileyWidget.sln --verbosity minimal

      - name: Build MCP server project
        id: mcp-build
        continue-on-error: true  # project may not exist yet; skip stress run gracefully
        run: dotnet build tests/syncfusion-winforms-mcp/tools/WileyWidgetMcpServer/WileyWidgetMcpServer.csproj --configuration Release --no-restore --verbosity minimal

      - name: Run strict ribbon stress script
        if: steps.mcp-build.outcome == 'success'
        shell: pwsh
        run: |
          dotnet run --project tests/syncfusion-winforms-mcp/tools/WileyWidgetMcpServer/WileyWidgetMcpServer.csproj --configuration Release --no-build -- --run-script tests/syncfusion-winforms-mcp/tools/WileyWidgetMcpServer/Tests/MainForm_RibbonControlAdv_Navigation.net10.csx *>&1 | Tee-Object -FilePath ribbon-stress.log
          if ($LASTEXITCODE -ne 0) { Write-Error "Ribbon stress script failed. See ribbon-stress.log" }

      - name: Upload ribbon stress artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ribbon-stress-net10
          path: |
            ribbon-stress.log
          retention-days: 7
