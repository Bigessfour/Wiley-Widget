name: CI/CD Dashboard Enhanced (95% Success Target)

# Single-user municipal application workflow
# Optimized for local development speed and debugging ease
# Run locally: dotnet test WileyWidget.sln --configuration Release

on:
  push:
    branches: [main, develop, feature/dashboard-production-ready]
  # PRs use fast-pr-feedback.yml for quick feedback
  # Full build only runs on push to main/develop or manual trigger
  workflow_dispatch: {}

permissions:
  contents: read
  checks: write

jobs:
  # Removed: workflow-lint job - use local trunk check instead
  # For single-user dev: Run 'trunk check' locally before pushing

  ps-script-analyze:
    name: PowerShell scripts - static analysis
    runs-on: windows-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -MinimumVersion 1.22.0

      - name: Analyze PowerShell scripts under ./scripts
        shell: pwsh
        run: |
          $errors = $false
          Get-ChildItem -Path ./scripts -Recurse -Filter "*.ps1" -File | ForEach-Object {
            Write-Host "Analyzing: $($_.FullName)"
            $results = Invoke-ScriptAnalyzer -Path $_.FullName -Severity Error -Recurse -EnableExit
            if ($results) { $results | Format-Table -AutoSize; $errors = $true }
          }
          if ($errors) { Write-Error "Script analysis found issues"; exit 1 }

  build:
    # Bound the runtime to avoid runaway runs and add concurrency to prevent duplicate builds
    runs-on: windows-latest
    timeout-minutes: 60
    concurrency:
      group: build-winforms-${{ github.ref }}
      cancel-in-progress: true

    env:
      COVERAGE_THRESHOLD: 85
      COVERAGE_FAIL_ON_MISSING: "false" # Set 'true' to make missing coverage a hard failure

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.nuget/packages
            ~/.local/share/NuGet
          key: nuget-packages-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-packages-${{ runner.os }}-

      - name: Cache dotnet tools
        uses: actions/cache@v4
        with:
          path: ~/.dotnet/tools
          key: dotnet-tools-${{ runner.os }}-${{ hashFiles('**/Directory.Packages.props') }}
          restore-keys: dotnet-tools-${{ runner.os }}-

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Clear NuGet caches (best-effort)
        shell: pwsh
        run: |
          # Clearing caches sometimes fails if disk locked — ignore failures
          try {
            dotnet nuget locals all --clear
          } catch {
            Write-Host 'clear caches failed - continuing'
          }

      - name: Restore NuGet packages
        shell: powershell
        run: |
          dotnet restore WileyWidget.sln --verbosity minimal
          if ($LASTEXITCODE -ne 0) {
            Write-Error "Restore failed - check NuGet sources"
            exit 1
          }

      - name: Build WinForms Application
        shell: pwsh
        run: dotnet build WileyWidget.sln --configuration Release --no-restore --verbosity minimal

      - name: Test - Unit Tests (with coverage)
        shell: powershell
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          dotnet test tests/WileyWidget.Services.Tests/WileyWidget.Services.Tests.csproj --configuration Release --collect:"XPlat Code Coverage" --logger trx --results-directory ./TestResults/UnitTests
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Test - Dashboard Service Tests (filtered)
        shell: powershell
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          dotnet test tests/WileyWidget.Services.Tests/WileyWidget.Services.Tests.csproj --filter "FullyQualifiedName~Dashboard" --configuration Release --logger trx --collect:"XPlat Code Coverage" --results-directory ./TestResults/Dashboard
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Test - Integration Tests (with coverage)
        shell: powershell
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          # Skip if QuickBooks secrets not available
          if (-not $env:QBO_CLIENT_ID -or -not $env:QBO_CLIENT_SECRET) {
            Write-Host "Skipping integration tests (no QBO secrets configured)"
            exit 0
          }
          dotnet test tests/WileyWidget.Services.Tests/WileyWidget.Services.Tests.csproj --configuration Release --collect:"XPlat Code Coverage" --logger trx --results-directory ./TestResults/Integration
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Collect coverage summary
        if: always()
        shell: powershell
        run: |
          # Install reportgenerator in a non-interactive way and ensure it's available in PATH
          dotnet tool install -g dotnet-reportgenerator-globaltool --version 5.1.23
          if ($LASTEXITCODE -ne 0) { Write-Host 'reportgenerator already installed' }
          $toolsPath = "$env:USERPROFILE\.dotnet\tools"
          $env:PATH = "$toolsPath;$env:PATH"

          Write-Host 'Searching for coverage files under ./TestResults'
          $coverageFiles = Get-ChildItem -Path ./TestResults -Recurse -Filter "coverage.cobertura.xml" -ErrorAction SilentlyContinue | Select-Object -ExpandProperty FullName

          if (!$coverageFiles) {
            Write-Warning "No coverage files found. COVERAGE_FAIL_ON_MISSING=$env:COVERAGE_FAIL_ON_MISSING"
            if ($env:COVERAGE_FAIL_ON_MISSING -eq 'true') { exit 1 } else { Write-Host 'Skipping coverage-failure, continuing' ; exit 0 }
          }

          reportgenerator -reports:$($coverageFiles -join ";") -targetdir:coverage-report -reporttypes:TextSummary -verbosity:Error

          $summary = Get-Content (Join-Path -Path 'coverage-report' -ChildPath 'Summary.txt') -ErrorAction Stop
          Write-Host $summary

          $match = ($summary | Select-String -Pattern "Line: (\d+\.?\d*)%" -AllMatches)
          if (-not $match.Matches.Count) {
            Write-Warning 'Could not extract line coverage from the Summary.txt'
            if ($env:COVERAGE_FAIL_ON_MISSING -eq 'true') { exit 1 } else { exit 0 }
          }

          $line = $match.Matches[0].Groups[1].Value
          if (-not [double]::TryParse($line, [ref]$parsed)) {
            Write-Warning 'Failed to parse coverage percentage'
            exit 0
          }

          $coverage = [double]$parsed
          Write-Host "Total line coverage: $coverage%"
          # Make coverage check conditional: only fail on main branch
          if ($coverage -lt $env:COVERAGE_THRESHOLD) {
            if ('${{ github.ref }}' -eq 'refs/heads/main') {
              Write-Error "Coverage $coverage% is below threshold of $env:COVERAGE_THRESHOLD% on main branch"
              exit 1
            } else {
              Write-Warning "Coverage $coverage% is below threshold of $env:COVERAGE_THRESHOLD% (feature branch: warning only)"
            }
          }

      # WinForms restore included in solution restore above

      - name: Build WinForms Project
        shell: pwsh
        run: dotnet build src/WileyWidget.WinForms/WileyWidget.WinForms.csproj --configuration Release --no-restore --verbosity minimal

      - name: Test - WinForms ChartControl defaults (filtered)
        shell: powershell
        run: |
          dotnet test tests/WileyWidget.WinForms.Tests/WileyWidget.WinForms.Tests.csproj --filter "Category=Chart" --configuration Release --logger trx --results-directory ./TestResults/WinFormsChart
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Test - WinForms MainForm Startup Integration
        shell: powershell
        env:
          WILEYWIDGET_UI_TESTS: "true"  # Matches the env var your test sets
        run: |
          dotnet test tests/WileyWidget.WinForms.Tests/WileyWidget.WinForms.Tests.csproj `
            --filter "FullyQualifiedName~WileyWidget.WinForms.Tests.Startup.MainFormStartupIntegrationTests" `
            --configuration Release `
            --logger trx `
            --results-directory ./TestResults/WinFormsStartup
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Publish Application
        shell: pwsh
        run: dotnet publish src/WileyWidget.WinForms/WileyWidget.WinForms.csproj --configuration Release --output ./publish --no-restore

      - name: Verify startup smoke test (best-effort)
        continue-on-error: true
        run: powershell -NoProfile -ExecutionPolicy Bypass -File .\scripts\verify-startup.ps1 -ExePath ./publish/WileyWidget.WinForms.exe -TimeoutSeconds 20

      - name: Validate Dashboard Deployment Package
        shell: pwsh
        run: |
          if (!(Test-Path "./publish/WileyWidget.WinForms.exe")) {
            Write-Error "Dashboard executable not found in publish directory"
            exit 1
          }
          $size = (Get-Item "./publish/WileyWidget.WinForms.exe").Length / 1MB
          Write-Host "Dashboard executable size: $([math]::Round($size, 2)) MB"
          if ($size -gt 100) {
            Write-Warning "Dashboard executable exceeds 100MB - consider optimization"
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wiley-widget-winforms
          path: ./publish/
          retention-days: 90 # Extended for municipal records

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: ./TestResults/
          retention-days: 7

  ui-e2e:
    # Manual-only: UI E2E tests are interactive and should be executed on demand
    if: ${{ github.event_name == 'workflow_dispatch' }}
    runs-on: [self-hosted, windows]
    needs: build
    timeout-minutes: 120

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Confirm runner suitability
        shell: powershell
        run: |
          # Ensure the runner is self-hosted and interactive — otherwise abort with a clear message
          if (-not ($env:RUNNER_LABELS -match 'self-hosted')) {
            Write-Error 'UI E2E tests require a self-hosted Windows runner with UI access. Re-run with an appropriate runner.'
            exit 1
          }

      - name: Build application
        run: dotnet build WileyWidget.sln --configuration Release --no-restore

      - name: Run WinForms UI E2E (interactive)
        run: dotnet test tests/WileyWidget.WinForms.E2ETests/WileyWidget.WinForms.E2ETests.csproj --configuration Release
        # Leave out --no-build for safety: ensure tests are built for this runner
