name: Build WinForms (.NET 9)

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.vscode/**'
  pull_request:
    branches: [ main, develop ]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Ensure .trunk exists and create setup-ci symlink (non-Windows)
      if: runner.os != 'Windows'
      shell: bash
      run: |
        set -euo pipefail

        # Ensure parent dir exists
        mkdir -p .trunk

        # TRUNK_PATH should be set to the Trunk CLI installation directory
        if [ -z "${TRUNK_PATH:-}" ]; then
          echo "ERROR: TRUNK_PATH is not set. Expected path to Trunk CLI installation directory."
          exit 1
        fi

        SRC="$TRUNK_PATH/setup-ci"
        DEST=".trunk/setup-ci"

        if [ ! -e "$SRC" ]; then
          echo "ERROR: expected trunk source does not exist: $SRC"
          ls -la "$TRUNK_PATH" || true
          exit 1
        fi

        # Create an idempotent symlink (replace existing link/target)
        ln -sfn "$SRC" "$DEST"
        echo "Created symlink: $DEST -> $SRC"

    - name: Ensure .trunk exists and create setup-ci symlink (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'

        New-Item -ItemType Directory -Path .trunk -Force | Out-Null

        # TRUNK_PATH should be set to the Trunk CLI installation directory
        if (-not $env:TRUNK_PATH) {
          Write-Error 'ERROR: TRUNK_PATH is not set. Expected path to Trunk CLI installation directory.'
          exit 1
        }

        $src = Join-Path $env:TRUNK_PATH 'setup-ci'
        $dest = Join-Path (Get-Location) '.trunk\setup-ci'

        if (-not (Test-Path $src)) {
          Write-Error "ERROR: expected trunk source does not exist: $src"
          Get-ChildItem -Path $env:TRUNK_PATH -Force | Write-Output
          exit 1
        }

        if (Test-Path $dest) { Remove-Item -Path $dest -Force -Recurse }

        try {
          New-Item -ItemType SymbolicLink -Path $dest -Target $src | Out-Null
          Write-Host "Created symlink: $dest -> $src"
        } catch {
          Write-Warning "Failed to create symlink due to insufficient permissions or unsupported filesystem. Falling back to copying files: $_"
          Copy-Item -Path $src -Destination $dest -Recurse -Force
          Write-Host "Copied $src to $dest"
        }

    - name: Setup .NET 9
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'
        dotnet-quality: 'ga'

    - name: Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.nuget/packages
          %USERPROFILE%\.nuget\packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json', '**/Directory.Packages.props') }}
        restore-keys: |
          ${{ runner.os }}-nuget-

    - name: Restore dependencies
      run: dotnet restore WileyWidget.sln

    - name: Build Solution
      run: dotnet build WileyWidget.sln --configuration Release --no-restore

    - name: Run Unit Tests
      run: dotnet test WileyWidget.Services.UnitTests/WileyWidget.Services.UnitTests.csproj --configuration Release --no-build --verbosity normal

    # TODO: Re-enable when WinForms integration tests are implemented
    # - name: Run Integration Tests
    #   run: dotnet test WileyWidget.IntegrationTests/WileyWidget.IntegrationTests.csproj --configuration Release --no-build --verbosity normal

    - name: Publish Application
      run: dotnet publish WileyWidget.WinForms/WileyWidget.WinForms.csproj --configuration Release --output ./publish

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: wiley-widget-winforms-${{ github.sha }}
        path: ./publish/
        retention-days: 30
