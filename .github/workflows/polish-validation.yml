name: Polish Validation (UI/Data/Theme/MSSQL)

on:
  pull_request:
    branches: [main, develop]
    paths:
      - src/**/*.cs
      - scripts/**
      - .github/workflows/polish-validation.yml
  push:
    branches: [main, develop]
    paths:
      - src/**/*.cs
      - scripts/**

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: polish-${{ github.ref }}
  cancel-in-progress: true

jobs:
  polish-validation:
    name: Polish Phase Validation (UI/Data/Theme/MSSQL)
    runs-on: windows-latest
    timeout-minutes: 50

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET 10
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore & Build
        shell: pwsh
        run: |
          Write-Host "ğŸ”¨ Restoring and building..." -ForegroundColor Cyan
          dotnet restore WileyWidget.sln --verbosity minimal
          dotnet build WileyWidget.sln --no-restore --configuration Release --verbosity minimal
          if ($LASTEXITCODE -ne 0) { exit 1 }

      - name: Run UI/Theme tests (filtered)
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "ğŸ¨ Running UI/Theme tests..." -ForegroundColor Cyan
          dotnet test tests/WileyWidget.WinForms.Tests/WileyWidget.WinForms.Tests.csproj `
            --filter "Category=UI OR Category=Theme" `
            --no-build --configuration Release `
            --verbosity normal `
            --logger "trx;LogFileName=ui-theme-tests.trx" `
            --results-directory ./TestResults/UITheme
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… UI/Theme tests passed" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸  UI/Theme tests had failures" -ForegroundColor Yellow
          }

      - name: Run Data/Integration tests (filtered)
        shell: pwsh
        continue-on-error: true
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          Write-Host "ğŸ“Š Running Data/Integration tests..." -ForegroundColor Cyan
          dotnet test tests/ `
            --filter "Category=Data OR Category=Integration OR Category=Database" `
            --no-build --configuration Release `
            --verbosity normal `
            --logger "trx;LogFileName=data-tests.trx" `
            --results-directory ./TestResults/DataIntegration
          
          if ($LASTEXITCODE -eq 0) {
            Write-Host "âœ… Data/Integration tests passed" -ForegroundColor Green
          } else {
            Write-Host "âš ï¸  Data/Integration tests had failures" -ForegroundColor Yellow
          }

      - name: Run Syncfusion theming compliance check
        shell: bash
        continue-on-error: true
        run: |
          echo "ğŸ¨ Checking Syncfusion theme compliance..."
          if [ -f scripts/check-syncfusion-theming.py ]; then
            chmod +x scripts/check-syncfusion-theming.py
            python scripts/check-syncfusion-theming.py
            if [ $? -eq 0 ]; then
              echo "âœ… Theme compliance: PASSED"
            else
              echo "âš ï¸  Theme compliance: Had issues (see above)"
            fi
          else
            echo "âš ï¸  Theme check script not found, skipping"
          fi

      - name: MSSQL Connection Validation (PowerShell smoke test)
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "ğŸ”Œ Testing MSSQL connection setup..." -ForegroundColor Cyan
          
          # This is a placeholder for actual MSSQL validation
          # In a real scenario, you would:
          # 1. Set up a test SQL Server instance (LocalDB or Docker)
          # 2. Run the import scripts (scripts/import-budget-data.ps1, etc.)
          # 3. Query for FY2026 budget data to validate
          # 4. Clean up test data
          
          Write-Host "ğŸ“‹ MSSQL setup scripts available:" -ForegroundColor Cyan
          if (Test-Path ./scripts/setup-mssql-mcp.ps1) {
            Write-Host "  âœ… ./scripts/setup-mssql-mcp.ps1 (Setup guide)" -ForegroundColor Green
          }
          if (Test-Path ./scripts/import-budget-data.ps1) {
            Write-Host "  âœ… ./scripts/import-budget-data.ps1 (Budget import)" -ForegroundColor Green
          }
          
          Write-Host "ğŸ’¡ Tip: Run import scripts locally against test DB to validate FY2026 budget data" -ForegroundColor Yellow

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: polish-test-results-${{ github.run_id }}
          path: ./TestResults
          retention-days: 7

      - name: Publish test results summary
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: ./TestResults/**/*.trx
          check_name: Polish Validation Results
          comment_mode: always

      - name: Final validation report
        shell: pwsh
        run: |
          Write-Host "" -ForegroundColor White
          Write-Host "ğŸ“‹ POLISH VALIDATION SUMMARY" -ForegroundColor Cyan
          Write-Host "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" -ForegroundColor Cyan
          Write-Host "âœ… Build: Success" -ForegroundColor Green
          Write-Host "ğŸ¨ UI/Theme Tests: See artifacts" -ForegroundColor Cyan
          Write-Host "ğŸ“Š Data/Integration Tests: See artifacts" -ForegroundColor Cyan
          Write-Host "ğŸ¨ Theme Compliance: Validated above" -ForegroundColor Cyan
          Write-Host "ğŸ”Œ MSSQL Setup: Scripts available (validate locally)" -ForegroundColor Yellow
          Write-Host "" -ForegroundColor White
          Write-Host "ğŸ“¦ Artifacts uploaded:" -ForegroundColor Green
          Write-Host "  â€¢ Test results (TestResults/)" -ForegroundColor White
          Write-Host "" -ForegroundColor White
          Write-Host "Next: Run manual validation for MSSQL import" -ForegroundColor Yellow
          Write-Host "  ./scripts/import-budget-data.ps1 -Database WileyWidget" -ForegroundColor White
