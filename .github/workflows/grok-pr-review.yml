name: Grok Code Review

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**/*.cs'
      - 'tests/**/*.cs'
      - '.github/workflows/**'

permissions:
  contents: read
  pull-requests: write

jobs:
  grok-review:
    name: Grok-powered PR Review
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for proper diff

      - name: Get PR diff
        id: diff
        run: |
          # Get the base commit and current commit
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Generate unified diff
          DIFF=$(git diff $BASE_SHA..$HEAD_SHA -- \
            'src/**/*.cs' 'tests/**/*.cs' \
            --unified=3 \
            --diff-filter=ACMTU 2>/dev/null | head -20000)
          
          # Store diff in a temp file (handles large diffs)
          echo "$DIFF" > /tmp/pr.diff
          
          # Count lines changed
          LINES_CHANGED=$(echo "$DIFF" | grep -c '^[+-]' || echo 0)
          echo "lines_changed=$LINES_CHANGED" >> $GITHUB_OUTPUT
          echo "diff_size=$(wc -c < /tmp/pr.diff)" >> $GITHUB_OUTPUT

      - name: Skip if no significant changes
        if: steps.diff.outputs.lines_changed < 10
        run: echo "No significant C# changes detected; skipping Grok review"

      - name: Prepare review prompt
        id: prompt
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          
          # Read diff from file
          DIFF=$(cat /tmp/pr.diff)
          
          # Truncate diff if too large
          if [ ${#DIFF} -gt 15000 ]; then
            DIFF=$(echo "$DIFF" | head -300)
            DIFF="${DIFF}
          ... (diff truncated due to size)"
          fi
          
          # Create review prompt
          PROMPT="You are a senior code reviewer for a Syncfusion WinForms/C# project.
          
STRICT RULES TO ENFORCE:
1. **SfSkinManager Theming**: SfSkinManager is the SINGLE SOURCE OF TRUTH for theming
   - ‚úÖ Allowed: SfSkinManager.SetVisualStyle() calls
   - ‚úÖ Allowed: SfSkinManager.LoadAssembly() for theme initialization
   - ‚úÖ Allowed: Semantic status colors (Color.Red, Color.Green, Color.Orange)
   - ‚ùå FORBIDDEN: Manual BackColor/ForeColor assignments (except form-level docking setup)
   - ‚ùå FORBIDDEN: Custom color properties/dictionaries
   - ‚ùå FORBIDDEN: Competing theme managers

2. **C# Best Practices**:
   - No .Result or .Wait() on Task (must be async/await)
   - Async/await patterns for I/O operations
   - Modern C# idioms (var, records, required members where appropriate)
   - Remove unused imports and variables
   - XML doc comments for public members

3. **Test Coverage**: Check if new code has corresponding tests

4. **Performance**: Highlight potential memory leaks, N+1 queries, or blocking calls

REVIEW FORMAT:
- Start with a brief summary (1-2 sentences)
- List 3-5 KEY findings (use ### for headers)
- For each finding: describe issue, show code snippet, suggest fix
- End with: Recommendation (Approve/Request Changes/Comment)

PR TITLE: $PR_TITLE
PR AUTHOR: $PR_AUTHOR
PR DESCRIPTION:
\`\`\`
$PR_BODY
\`\`\`

CHANGED CODE (unified diff):
\`\`\`diff
$DIFF
\`\`\`

Review this PR focusing on the strict rules above. Be direct and actionable."
          
          # Save to file to avoid escaping issues
          echo "$PROMPT" > /tmp/review_prompt.txt
          echo "prompt_file=/tmp/review_prompt.txt" >> $GITHUB_OUTPUT

      - name: Call Grok API for review
        id: grok
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          # Read prompt
          PROMPT=$(cat /tmp/review_prompt.txt)
          
          # Create JSON payload
          cat > /tmp/grok_request.json << 'EOF'
          {
            "model": "grok-4",
            "messages": [
              {
                "role": "system",
                "content": "You are an expert code reviewer for a Syncfusion WinForms/C# project. Provide thorough, actionable feedback."
              },
              {
                "role": "user",
                "content": ""
              }
            ],
            "stream": false,
            "temperature": 0.3
          }
          EOF
          
          # Escape the prompt for JSON and insert it
          ESCAPED_PROMPT=$(printf '%s\n' "$PROMPT" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')
          python3 << 'PYEOF'
          import json
          with open('/tmp/grok_request.json', 'r') as f:
            payload = json.load(f)
          payload['messages'][1]['content'] = json.loads('''ESCAPED_PROMPT''')
          with open('/tmp/grok_request.json', 'w') as f:
            json.dump(payload, f)
          PYEOF
          
          # Call Grok API
          RESPONSE=$(curl -s -X POST https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $XAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @/tmp/grok_request.json)
          
          # Extract response text
          REVIEW=$(echo "$RESPONSE" | python3 -c 'import json,sys; r=json.load(sys.stdin); print(r.get("choices",[{}])[0].get("message",{}).get("content","Error: No response from Grok"))')
          
          # Save review to file (handles multiline output)
          echo "$REVIEW" > /tmp/grok_review.txt
          
          # Check for API errors
          if echo "$RESPONSE" | grep -q '"error"'; then
            ERROR=$(echo "$RESPONSE" | python3 -c 'import json,sys; r=json.load(sys.stdin); print(r.get("error",{}).get("message","Unknown error"))')
            echo "grok_error=true" >> $GITHUB_OUTPUT
            echo "grok_error_msg=$ERROR" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "grok_review_file=/tmp/grok_review.txt" >> $GITHUB_OUTPUT

      - name: Post review as PR comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/grok_review.txt', 'utf8');
            
            const comment = `## ü§ñ Grok Code Review
            
${review}

---
*This review was generated by Grok (xAI). For concerns, mention @${{ github.event.pull_request.user.login }} or a maintainer.*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Handle review errors
        if: failure() && steps.grok.outputs.grok_error == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ö†Ô∏è **Grok Review Failed**: ${{ steps.grok.outputs.grok_error_msg }}

Please ensure XAI_API_KEY is configured and Grok API is accessible.`
            });
