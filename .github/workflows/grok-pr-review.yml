name: Grok Code Review

on:
  pull_request:
    branches: [main, develop]
    paths:
      - src/**/*.cs
      - tests/**/*.cs

permissions:
  contents: read
  pull-requests: write

jobs:
  grok-review:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"
          git diff "$BASE_SHA..$HEAD_SHA" -- 'src/**/*.cs' 'tests/**/*.cs' | head -20000 > /tmp/pr.diff
          LINES=$(grep -c '^' /tmp/pr.diff || echo 0)
          echo "lines=$LINES" >> "$GITHUB_OUTPUT"

      - name: Skip if no significant changes
        if: ${{ steps.diff.outputs.lines < 10 }}
        run: echo "No significant C# changes; skipping Grok review"

      - name: Check API key
        id: key
        run: |
          if [ -n "${{ secrets.XAI_API_KEY }}" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create request builder script
        if: steps.key.outputs.exists == 'true'
        run: |
          cat > /tmp/build_request.py << 'EOFSCRIPT'
          import json
          
          with open('/tmp/pr.diff', 'r') as f:
              diff = f.read()[:12000]
          
          request = {
              "model": "grok-4-1-fast-reasoning-latest",
              "messages": [
                  {"role": "system", "content": "Senior C# code reviewer for .NET 10 Windows Forms Syncfusion app. Focus: Syncfusion API correctness, SfSkinManager theme consistency, WinForms best practices."},
                  {"role": "user", "content": "Review this PR diff:\n\n" + diff}
              ],
              "temperature": 0.5,
              "max_tokens": 2048
          }
          
          with open('/tmp/req.json', 'w') as f:
              json.dump(request, f)
          EOFSCRIPT
          
          python3 /tmp/build_request.py

      - name: Call Grok API
        if: steps.key.outputs.exists == 'true'
        id: api
        env:
          XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
        run: |
          curl -s https://api.x.ai/v1/chat/completions \
            -H "Authorization: Bearer $XAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d @/tmp/req.json > /tmp/resp.json
          
          python3 << 'EOFPARSE'
          import json
          try:
              with open('/tmp/resp.json') as f:
                  data = json.load(f)
              if 'error' in data:
                  print(f"API Error: {data['error'].get('message', 'unknown')}")
                  exit(1)
              review = data['choices'][0]['message']['content']
              with open('/tmp/review.txt', 'w') as f:
                  f.write(review)
          except Exception as e:
              print(f"Parse error: {e}")
              exit(1)
          EOFPARSE

      - name: Post review
        if: steps.api.outcome == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const review = fs.readFileSync('/tmp/review.txt', 'utf8');
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ¤– Grok Code Review\n\n${review}\n\n---\n*Generated by Grok (xAI)*`
            });

      - name: Post error notice
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âš ï¸ Grok review failed. See workflow logs for details.'
            });
