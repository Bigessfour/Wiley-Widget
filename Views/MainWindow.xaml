<Window x:Class="WileyWidget.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:WileyWidget"
        xmlns:converters="clr-namespace:WileyWidget.Converters"
        xmlns:syncfusion="http://schemas.syncfusion.com/wpf"
        mc:Ignorable="d"
        Title="Wiley Widget" Height="600" Width="1000">
    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis" />
        <converters:BalanceToColorConverter x:Key="BalanceToColorConverter"/>
        <converters:StatusToColorConverter x:Key="StatusToColorConverter"/>
    </Window.Resources>
    <DockPanel>
        <syncfusion:Ribbon DockPanel.Dock="Top" x:Name="MainRibbon">
            <syncfusion:RibbonTab Caption="Home">
                <syncfusion:RibbonBar Header="Clipboard">
                    <syncfusion:RibbonButton Label="Copy" SizeForm="Large" />
                    <syncfusion:RibbonButton Label="Paste" SizeForm="Large" />
                </syncfusion:RibbonBar>
                <syncfusion:RibbonBar Header="View">
                    <syncfusion:RibbonButton Label="Refresh" />
                </syncfusion:RibbonBar>
                <syncfusion:RibbonBar Header="Theme">
                    <StackPanel Orientation="Horizontal">
                        <syncfusion:RibbonButton x:Name="BtnFluentDark" Label="Fluent Dark" Click="OnFluentDark" />
                        <syncfusion:RibbonButton x:Name="BtnFluentLight" Label="Fluent Light" Click="OnFluentLight" />
                    </StackPanel>
                </syncfusion:RibbonBar>
                <syncfusion:RibbonBar Header="Data">
                    <StackPanel Orientation="Horizontal">
                        <syncfusion:RibbonButton Label="Next" ToolTip="Select next widget" Command="{Binding SelectNextCommand}" />
                        <syncfusion:RibbonButton Label="Add" ToolTip="Add a sample widget" Command="{Binding AddWidgetCommand}" />
                    </StackPanel>
                </syncfusion:RibbonBar>
                <syncfusion:RibbonBar Header="Help">
                    <syncfusion:RibbonButton Label="About" Click="OnAbout" />
                </syncfusion:RibbonBar>
            </syncfusion:RibbonTab>
        </syncfusion:Ribbon>

        <DockPanel LastChildFill="True">
            <TabControl>
                <TabItem Header="Widgets">
                    <syncfusion:SfDataGrid ItemsSource="{Binding Widgets}" SelectedItem="{Binding SelectedWidget, Mode=TwoWay}" 
                                         AutoGenerateColumns="False" x:Name="Grid" AllowSorting="True" AllowFiltering="True" 
                                         AllowResizingColumns="True" GridLinesVisibility="Horizontal" RowHeight="28" AlternationCount="2">
                        <syncfusion:SfDataGrid.Columns>
                            <syncfusion:GridTextColumn HeaderText="Id" MappingName="Id" Width="70" />
                            <syncfusion:GridTextColumn HeaderText="Name" MappingName="Name" />
                            <syncfusion:GridTextColumn HeaderText="Category" MappingName="Category" />
                            <syncfusion:GridNumericColumn HeaderText="Price" MappingName="Price" />
                        </syncfusion:SfDataGrid.Columns>
                    </syncfusion:SfDataGrid>
                </TabItem>
                <TabItem Header="Enterprises">
                    <DockPanel>
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="4">
                            <Button Content="Load Enterprises" Command="{Binding LoadEnterprisesCommand}" Margin="0,0,6,0"/>
                            <Button Content="Add Enterprise" Command="{Binding AddEnterpriseCommand}" Margin="0,0,6,0"/>
                            <Button Content="Save" Command="{Binding SaveEnterpriseCommand}" Margin="0,0,6,0"/>
                            <Button Content="Delete" Command="{Binding DeleteEnterpriseCommand}" Margin="0,0,6,0"/>
                            <Button Content="Test Config" Command="{Binding TestConfigurationCommand}" Margin="0,0,6,0" 
                                    Background="#6B7280" Foreground="White" ToolTip="Test xAI API key configuration"/>
                            <Button Content="Crunch with Grok" Command="{Binding CrunchWithGrokCommand}" Margin="0,0,6,0" 
                                    Background="#10B981" Foreground="White" FontWeight="Bold" ToolTip="Analyze enterprises with AI"/>
                        </StackPanel>
                        <syncfusion:SfDataGrid ItemsSource="{Binding Enterprises}" SelectedItem="{Binding SelectedEnterprise, Mode=TwoWay}" 
                                             AutoGenerateColumns="False" AllowSorting="True" AllowFiltering="True" 
                                             AllowResizingColumns="True" GridLinesVisibility="Horizontal" RowHeight="28" AlternationCount="2">
                            <syncfusion:SfDataGrid.Columns>
                                <syncfusion:GridTextColumn HeaderText="Name" MappingName="Name" Width="200" />
                                <syncfusion:GridNumericColumn HeaderText="Rate" MappingName="CurrentRate" Width="100" />
                                <syncfusion:GridNumericColumn HeaderText="Rate Payers" MappingName="CitizenCount" Width="100" />
                                <syncfusion:GridNumericColumn HeaderText="Expenses" MappingName="MonthlyExpenses" Width="120" />
                                <syncfusion:GridNumericColumn HeaderText="Revenue" MappingName="MonthlyRevenue" Width="120" />
                                <syncfusion:GridNumericColumn HeaderText="Balance" MappingName="MonthlyBalance" Width="120" />
                                <syncfusion:GridNumericColumn HeaderText="Deficit" MappingName="Deficit" Width="100">
                                    <syncfusion:GridNumericColumn.ToolTipTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Notes}" TextWrapping="Wrap" MaxWidth="300"/>
                                        </DataTemplate>
                                    </syncfusion:GridNumericColumn.ToolTipTemplate>
                                </syncfusion:GridNumericColumn>
                                <syncfusion:GridTextColumn HeaderText="Notes" MappingName="Notes" Width="200" />
                            </syncfusion:SfDataGrid.Columns>
                        </syncfusion:SfDataGrid>
                    </DockPanel>
                </TabItem>
                <TabItem Header="Budget Summary">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="10">
                            <TextBlock Text="Municipal Budget Dashboard" FontSize="24" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,0,0,20"/>
                            
                            <UniformGrid Columns="2" Rows="2" Margin="0,0,0,20">
                                <Border Style="{StaticResource DashboardCard}">
                                    <StackPanel>
                                        <TextBlock Text="Total Revenue" Style="{StaticResource CardTitle}"/>
                                        <TextBlock Text="{Binding BudgetMetrics.TotalRevenue, StringFormat=C2}" Style="{StaticResource CardValue}"/>
                                    </StackPanel>
                                </Border>
                                <Border Style="{StaticResource DashboardCard}">
                                    <StackPanel>
                                        <TextBlock Text="Total Expenses" Style="{StaticResource CardTitle}"/>
                                        <TextBlock Text="{Binding BudgetMetrics.TotalExpenses, StringFormat=C2}" Style="{StaticResource CardValue}"/>
                                    </StackPanel>
                                </Border>
                                <Border Style="{StaticResource DashboardCard}">
                                    <StackPanel>
                                        <TextBlock Text="Monthly Balance" Style="{StaticResource CardTitle}"/>
                                        <TextBlock Text="{Binding BudgetMetrics.MonthlyBalance, StringFormat=C2}" Style="{StaticResource CardValue}"/>
                                    </StackPanel>
                                </Border>
                                <Border Style="{StaticResource DashboardCard}">
                                    <StackPanel>
                                        <TextBlock Text="Rate Payers Served" Style="{StaticResource CardTitle}"/>
                                        <TextBlock Text="{Binding BudgetMetrics.TotalCitizens}" Style="{StaticResource CardValue}"/>
                                    </StackPanel>
                                </Border>
                            </UniformGrid>

                            <Border Style="{StaticResource DashboardCard}" CornerRadius="10" Margin="0,0,0,20" Padding="20">
                                <StackPanel HorizontalAlignment="Center">
                                    <TextBlock Text="{Binding BudgetMetrics.StatusIcon}" FontSize="48" HorizontalAlignment="Center"/>
                                    <TextBlock Text="{Binding BudgetMetrics.StatusMessage}" FontSize="18" FontWeight="Bold" HorizontalAlignment="Center" Margin="0,10,0,0"/>
                                    <TextBlock Text="{Binding BudgetMetrics.StatusDescription}" FontSize="14" HorizontalAlignment="Center" TextWrapping="Wrap" Margin="0,5,0,0"/>
                                </StackPanel>
                            </Border>

                            <GroupBox Header="Revenue vs Expenses Overview" Margin="0,0,0,20">
                                <syncfusion:SfChart Height="300" Margin="10">
                                    <syncfusion:SfChart.PrimaryAxis>
                                        <syncfusion:CategoryAxis/>
                                    </syncfusion:SfChart.PrimaryAxis>
                                    <syncfusion:SfChart.SecondaryAxis>
                                        <syncfusion:NumericalAxis LabelFormat="C0"/>
                                    </syncfusion:SfChart.SecondaryAxis>
                                    <syncfusion:ColumnSeries ItemsSource="{Binding Enterprises}" XBindingPath="Name" YBindingPath="MonthlyRevenue" Label="Revenue" Interior="#4CAF50"/>
                                    <syncfusion:ColumnSeries ItemsSource="{Binding Enterprises}" XBindingPath="Name" YBindingPath="MonthlyExpenses" Label="Expenses" Interior="#F44336"/>
                                </syncfusion:SfChart>
                            </GroupBox>

                            <GroupBox Header="Enterprise Performance Details" Margin="0,0,0,20">
                                <DataGrid ItemsSource="{Binding Enterprises}" AutoGenerateColumns="False" IsReadOnly="True" Margin="10" Style="{StaticResource ThemeDataGrid}">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="Enterprise" Binding="{Binding Name}" Width="120"/>
                                        <DataGridTextColumn Header="Rate Payers" Binding="{Binding CitizenCount}" Width="80"/>
                                        <DataGridTextColumn Header="Rate ($)" Binding="{Binding CurrentRate, StringFormat=C2}" Width="80"/>
                                        <DataGridTextColumn Header="Revenue ($)" Binding="{Binding MonthlyRevenue, StringFormat=C2}" Width="100"/>
                                        <DataGridTextColumn Header="Expenses ($)" Binding="{Binding MonthlyExpenses, StringFormat=C2}" Width="100"/>
                                        <DataGridTextColumn Header="Balance ($)" Binding="{Binding MonthlyBalance, StringFormat=C2}" Width="100">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="{Binding MonthlyBalance, Converter={StaticResource BalanceToColorConverter}}"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>
                                        <DataGridTextColumn Header="Status" Binding="{Binding BudgetStatus}" Width="80">
                                            <DataGridTextColumn.ElementStyle>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Foreground" Value="{Binding BudgetStatus, Converter={StaticResource StatusToColorConverter}}"/>
                                                    <Setter Property="FontWeight" Value="SemiBold"/>
                                                </Style>
                                            </DataGridTextColumn.ElementStyle>
                                        </DataGridTextColumn>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </GroupBox>

                                                        <GroupBox Header="Budget Insights &amp; Recommendations" Margin="0,0,0,20">
                                <StackPanel Margin="10">
                                    <TextBlock Text="{Binding BudgetInsights.MainInsight}" FontSize="14" TextWrapping="Wrap" Margin="0,0,0,10"/>
                                    <TextBlock Text="Key Recommendations:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                    <ItemsControl ItemsSource="{Binding BudgetInsights.Recommendations}">
                                        <ItemsControl.ItemTemplate>
                                            <DataTemplate>
                                                <Border Style="{StaticResource DashboardCard}" CornerRadius="4" Margin="0,2" Padding="8">
                                                    <TextBlock Text="{Binding}" TextWrapping="Wrap" FontSize="12"/>
                                                </Border>
                                            </DataTemplate>
                                        </ItemsControl.ItemTemplate>
                                    </ItemsControl>
                                    <Border Background="#FFF3CD" BorderBrush="#FFEAA7" BorderThickness="1" CornerRadius="4" Margin="0,10,0,0" Padding="8">
                                        <StackPanel>
                                            <TextBlock Text="{Binding BudgetInsights.Disclaimer}" TextWrapping="Wrap" FontSize="12" Foreground="#856404"/>
                                            <Button Content="Export for CPA Review" HorizontalAlignment="Center" Margin="0,8,0,0" Padding="8,4" Background="#007BFF" Foreground="White" BorderThickness="0" Command="{Binding ExportForCpaCommand}"/>
                                        </StackPanel>
                                    </Border>
                                </StackPanel>
                            </GroupBox>

                            <TextBlock Text="💡 Phase 2: UI Dashboards &amp; Basic Analytics - COMPLETED" Style="{StaticResource StatusTextSuccess}"/>
                            <TextBlock Text="Dashboard provides real-time budget analytics with visual indicators and actionable insights." Style="{StaticResource StatusTextInfo}"/>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
                <TabItem Header="Budget Interactions">
                    <DockPanel>
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="4">
                            <Button Content="Load Interactions" Command="{Binding LoadBudgetInteractionsCommand}" Margin="0,0,6,0"/>
                            <Button Content="Refresh Diagram" Command="{Binding RefreshDiagramCommand}" Margin="0,0,6,0"/>
                            <TextBlock Text="Interactions: " />
                            <TextBlock Text="{Binding BudgetInteractions.Count}" FontWeight="Bold" />
                        </StackPanel>
                        <syncfusion:SfDiagram x:Name="BudgetDiagram" 
                                           Background="White"
                                           Constraints="Default,Undoable,Zoomable">
                            <syncfusion:SfDiagram.Nodes>
                                <syncfusion:NodeCollection />
                            </syncfusion:SfDiagram.Nodes>
                            <syncfusion:SfDiagram.Connectors>
                                <syncfusion:ConnectorCollection />
                            </syncfusion:SfDiagram.Connectors>
                        </syncfusion:SfDiagram>
                    </DockPanel>
                </TabItem>
                <TabItem Header="QuickBooks">
                    <DockPanel>
                        <StackPanel Orientation="Horizontal" DockPanel.Dock="Top" Margin="4">
                            <Button Content="Load Customers" Command="{Binding LoadQuickBooksCustomersAsyncCommand}" Margin="0,0,6,0"/>
                            <Button Content="Load Invoices" Command="{Binding LoadQuickBooksInvoicesAsyncCommand}" Margin="0,0,6,0"/>
                            <Button Content="Sync Enterprises" Command="{Binding SyncEnterprisesToQboCommand}" Margin="0,0,6,0"/>
                            <Button Content="Sync Budget Interactions" Command="{Binding SyncBudgetInteractionsToQboCommand}" Margin="0,0,6,0"/>
                            <TextBlock Text="Busy" Style="{StaticResource BusyText}" Visibility="{Binding QuickBooksBusy, Converter={StaticResource BoolToVis}}"/>
                        </StackPanel>
                        <TabControl>
                            <TabItem Header="Customers">
                                <syncfusion:SfDataGrid ItemsSource="{Binding QuickBooksCustomers}" AutoGenerateColumns="True" />
                            </TabItem>
                            <TabItem Header="Invoices">
                                <syncfusion:SfDataGrid ItemsSource="{Binding QuickBooksInvoices}" AutoGenerateColumns="True" />
                            </TabItem>
                            <TabItem Header="QBO Classes">
                                <syncfusion:SfDataGrid ItemsSource="{Binding QboClasses}" AutoGenerateColumns="True" />
                            </TabItem>
                            <TabItem Header="QBO Accounts">
                                <syncfusion:SfDataGrid ItemsSource="{Binding QboAccounts}" AutoGenerateColumns="True" />
                            </TabItem>
                        </TabControl>
                    </DockPanel>
                </TabItem>
                <TabItem Header="Settings">
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <StackPanel Margin="20">
                            <TextBlock Text="Application Settings" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>
                            
                            <!-- Theme Settings -->
                            <GroupBox Header="Appearance" Margin="0,0,0,20">
                                <StackPanel Margin="10">
                                    <TextBlock Text="Theme:" Margin="0,0,0,8"/>
                                    <ComboBox x:Name="ThemeComboBox" SelectedItem="{Binding SelectedTheme, Mode=TwoWay}" Margin="0,0,0,10">
                                        <ComboBoxItem Content="Fluent Dark"/>
                                        <ComboBoxItem Content="Fluent Light"/>
                                    </ComboBox>
                                    <Button Content="Apply Theme" Click="OnApplyTheme" Margin="0,0,0,10"/>
                                </StackPanel>
                            </GroupBox>

                            <!-- xAI API Configuration -->
                            <GroupBox Header="xAI API Configuration" Margin="0,0,0,20">
                                <StackPanel Margin="10">
                                    <TextBlock Text="Configure your xAI API key for AI-powered budget analysis:" 
                                             TextWrapping="Wrap" Margin="0,0,0,15"/>
                                    
                                    <!-- API Key Input -->
                                    <TextBlock Text="API Key:" FontWeight="SemiBold" Margin="0,0,0,5"/>
                                    <PasswordBox x:Name="ApiKeyBox" Margin="0,0,0,5" 
                                               ToolTip="Your xAI API key (kept secure and never logged)"/>
                                    
                                    <!-- API Key Status -->
                                    <TextBlock x:Name="ApiKeyStatusText" Text="❌ No API key configured" 
                                             Margin="0,0,0,15" FontWeight="SemiBold"/>
                                    
                                    <!-- Model Selection -->
                                    <TextBlock Text="AI Model:" FontWeight="SemiBold" Margin="0,10,0,5"/>
                                    <ComboBox x:Name="ModelComboBox" Margin="0,0,0,10">
                                        <ComboBoxItem Content="grok-4-0709" IsSelected="True"/>
                                        <ComboBoxItem Content="grok-4"/>
                                    </ComboBox>
                                    
                                    <!-- Advanced Settings -->
                                    <Expander Header="Advanced Settings" Margin="0,10,0,0">
                                        <StackPanel Margin="10">
                                            <TextBlock Text="Timeout (seconds):" Margin="0,0,0,5"/>
                                            <TextBox x:Name="TimeoutTextBox" Text="30" Margin="0,0,0,10"/>
                                            
                                            <TextBlock Text="Cache TTL (minutes):" Margin="0,0,0,5"/>
                                            <TextBox x:Name="CacheTtlTextBox" Text="30" Margin="0,0,0,10"/>
                                            
                                            <TextBlock Text="Daily Budget ($):" Margin="0,0,0,5"/>
                                            <TextBox x:Name="DailyBudgetTextBox" Text="10.00" Margin="0,0,0,10"/>
                                            
                                            <TextBlock Text="Monthly Budget ($):" Margin="0,0,0,5"/>
                                            <TextBox x:Name="MonthlyBudgetTextBox" Text="300.00" Margin="0,0,0,10"/>
                                        </StackPanel>
                                    </Expander>
                                    
                                    <!-- Action Buttons -->
                                    <StackPanel Orientation="Horizontal" Margin="0,20,0,0">
                                        <Button Content="Test API Key" Click="OnTestApiKey" 
                                                Background="#10B981" Foreground="White" 
                                                Margin="0,0,10,0" Padding="20,10"/>
                                        <Button Content="Save Settings" Click="OnSaveSettings" 
                                                Background="#3B82F6" Foreground="White" 
                                                Margin="0,0,10,0" Padding="20,10"/>
                                        <Button Content="Load Settings" Click="OnLoadSettings" 
                                                Background="#6B7280" Foreground="White" 
                                                Margin="0,0,10,0" Padding="20,10"/>
                                        <Button Content="Remove API Key" Click="OnRemoveApiKey" 
                                                Background="#EF4444" Foreground="White" 
                                                Margin="0,0,10,0" Padding="20,10"/>
                                        <Button Content="API Key Info" Click="OnShowApiKeyInfo" 
                                                Background="#F59E0B" Foreground="White" 
                                                Padding="20,10"/>
                                    </StackPanel>
                                    
                                    <!-- Status Display -->
                                    <Border x:Name="StatusBorder" BorderBrush="#E5E7EB" BorderThickness="1" 
                                           Margin="0,20,0,0" Padding="10" CornerRadius="5">
                                        <TextBlock x:Name="StatusTextBlock" 
                                                 Text="Ready to configure xAI API key. Click 'Load Settings' to see current configuration."
                                                 TextWrapping="Wrap"/>
                                    </Border>
                                </StackPanel>
                            </GroupBox>

                            <!-- Quick Start Guide -->
                            <GroupBox Header="Quick Start Guide" Margin="0,0,0,20">
                                <StackPanel Margin="10">
                                    <TextBlock Text="New to xAI API keys?" FontWeight="SemiBold" Margin="0,0,0,10"/>
                                    <TextBlock Text="1. Visit https://x.ai and create an account" Margin="0,0,0,5"/>
                                    <TextBlock Text="2. Go to API Keys section in your profile" Margin="0,0,0,5"/>
                                    <TextBlock Text="3. Generate a new API key" Margin="0,0,0,5"/>
                                    <TextBlock Text="4. Copy the key and paste it above" Margin="0,0,0,5"/>
                                    <TextBlock Text="5. Click 'Test API Key' to verify" Margin="0,0,0,15"/>
                                    <Button Content="Open xAI API Key Guide" Click="OnOpenApiGuide" 
                                           Background="#8B5CF6" Foreground="White" Padding="15,8"/>
                                </StackPanel>
                            </GroupBox>
                        </StackPanel>
                    </ScrollViewer>
                </TabItem>
            </TabControl>
            <StatusBar DockPanel.Dock="Bottom">
                <StatusBarItem>
                    <TextBlock>
                        <Run Text="Items: "/><Run Text="{Binding Widgets.Count, Mode=OneWay}" />
                    </TextBlock>
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock>
                        <Run Text="Selected: "/><Run Text="{Binding SelectedWidget.Name}" />
                    </TextBlock>
                </StatusBarItem>
                <StatusBarItem>
                    <TextBlock>
                        <Run Text="Price: "/><Run Text="{Binding SelectedWidget.Price}" />
                    </TextBlock>
                </StatusBarItem>
            </StatusBar>
        </DockPanel>
    </DockPanel>
</Window>