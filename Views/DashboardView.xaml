<UserControl
    x:Class="WileyWidget.Views.DashboardView"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:viewmodels="using:WileyWidget.ViewModels"
    xmlns:converters="using:WileyWidget.Converters"
    mc:Ignorable="d"
    d:DataContext="{d:DesignInstance Type=viewmodels:QuickBooksDashboardViewModel}">

    <UserControl.Resources>
        <!-- Converters -->
        <converters:ColorToBrushConverter x:Key="ColorToBrushConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:BoolToVisibilityInverseConverter x:Key="BoolToVisibilityInverseConverter"/>
        <converters:PositiveNegativeColorConverter x:Key="PositiveNegativeColorConverter"/>

        <!-- Card Style -->
        <Style x:Key="DashboardCardStyle" TargetType="Border">
            <Setter Property="Background" Value="{ThemeResource CardBackgroundFillColorDefaultBrush}" />
            <Setter Property="BorderBrush" Value="{ThemeResource CardStrokeColorDefaultBrush}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="CornerRadius" Value="8" />
            <Setter Property="Padding" Value="24" />
        </Style>

        <!-- KPI Card Style -->
        <Style x:Key="KPICardStyle" TargetType="Border" BasedOn="{StaticResource DashboardCardStyle}">
            <Setter Property="Padding" Value="20" />
            <Setter Property="MinHeight" Value="140" />
        </Style>

        <!-- KPI Label Style -->
        <Style x:Key="KPILabelStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="12" />
            <Setter Property="Foreground" Value="{ThemeResource TextFillColorSecondaryBrush}" />
            <Setter Property="Margin" Value="0,0,0,8" />
            <Setter Property="FontWeight" Value="SemiBold" />
        </Style>

        <!-- KPI Value Style -->
        <Style x:Key="KPIValueStyle" TargetType="TextBlock">
            <Setter Property="FontSize" Value="32" />
            <Setter Property="FontWeight" Value="Bold" />
        </Style>
    </UserControl.Resources>

    <Grid Background="{ThemeResource LayerFillColorDefaultBrush}">
        <ScrollViewer VerticalScrollBarVisibility="Auto">
            <Grid Padding="32" MaxWidth="1400">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" /> <!-- Header -->
                    <RowDefinition Height="Auto" /> <!-- Connection Banner -->
                    <RowDefinition Height="Auto" /> <!-- Company Info -->
                    <RowDefinition Height="Auto" /> <!-- KPI Cards -->
                    <RowDefinition Height="Auto" /> <!-- Sync Buttons -->
                </Grid.RowDefinitions>

                <!-- Header -->
                <TextBlock Grid.Row="0"
                           Text="QuickBooks Dashboard"
                           FontSize="32"
                           FontWeight="Bold"
                           Margin="0,0,0,24"/>

                <!-- Connection Status Banner -->
                <Border Grid.Row="1" 
                        Margin="0,0,0,24"
                        Style="{StaticResource DashboardCardStyle}"
                        Background="{x:Bind ViewModel.ConnectionStatusColor, Mode=OneWay, Converter={StaticResource ColorToBrushConverter}}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto" />
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <FontIcon Grid.Column="0" 
                                  Glyph="&#xE909;" 
                                  FontSize="24"
                                  Margin="0,0,16,0"
                                  Foreground="White" />

                        <StackPanel Grid.Column="1" VerticalAlignment="Center">
                            <TextBlock Text="{x:Bind ViewModel.ConnectionStatusText, Mode=OneWay}"
                                       FontSize="16"
                                       FontWeight="SemiBold"
                                       Foreground="White" />
                            <TextBlock Text="{x:Bind ViewModel.CompanyName, Mode=OneWay}"
                                       FontSize="12"
                                       Foreground="White"
                                       Opacity="0.9"
                                       Margin="0,4,0,0"
                                       Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}" />
                        </StackPanel>

                        <Button Grid.Column="2"
                                Content="Connect to QuickBooks"
                                Command="{x:Bind ViewModel.ConnectCommand}"
                                Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityInverseConverter}}"
                                Style="{StaticResource AccentButtonStyle}"
                                Foreground="White"
                                Background="#FFFFFF20"
                                BorderThickness="0"/>
                    </Grid>
                </Border>

                <!-- Company Information Card -->
                <Border Grid.Row="2" 
                        Margin="0,0,0,24"
                        Style="{StaticResource DashboardCardStyle}"
                        Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="{x:Bind ViewModel.CompanyName, Mode=OneWay}"
                                       FontSize="24"
                                       FontWeight="Bold" />
                            <TextBlock FontSize="14"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       Margin="0,4,0,0">
                                <Run Text="Fiscal Year "/>
                                <Run Text="{x:Bind ViewModel.FiscalYear, Mode=OneWay}"/>
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Margin="32,0,0,0" VerticalAlignment="Center">
                            <TextBlock Text="Last Sync"
                                       FontSize="12"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       FontWeight="SemiBold"/>
                            <TextBlock Text="{x:Bind ViewModel.LastSyncTime, Mode=OneWay}"
                                       FontSize="14"
                                       Margin="0,4,0,0" />
                        </StackPanel>
                    </Grid>
                </Border>

                <!-- Financial KPI Cards -->
                <Grid Grid.Row="3" 
                      Margin="0,0,0,24"
                      Visibility="{x:Bind ViewModel.HasData, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="16" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="16" />
                        <ColumnDefinition Width="*" />
                        <ColumnDefinition Width="16" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Revenue YTD Card -->
                    <Border x:Name="RevenueCard" Grid.Column="0" Style="{StaticResource KPICardStyle}">
                        <Border.RenderTransform>
                            <CompositeTransform />
                        </Border.RenderTransform>
                        <StackPanel>
                            <TextBlock Text="REVENUE YTD" Style="{StaticResource KPILabelStyle}" />
                            <TextBlock Text="{x:Bind ViewModel.RevenueYTDFormatted, Mode=OneWay}"
                                       Style="{StaticResource KPIValueStyle}"
                                       Foreground="#28A745" />
                            <FontIcon Glyph="&#xE8A1;" 
                                      FontSize="16"
                                      Foreground="#28A745"
                                      Margin="0,8,0,0" />
                        </StackPanel>
                    </Border>

                    <!-- Net Income YTD Card -->
                    <Border x:Name="NetIncomeCard" Grid.Column="2" Style="{StaticResource KPICardStyle}">
                        <Border.RenderTransform>
                            <CompositeTransform />
                        </Border.RenderTransform>
                        <StackPanel>
                            <TextBlock Text="NET INCOME YTD" Style="{StaticResource KPILabelStyle}" />
                            <TextBlock Text="{x:Bind ViewModel.NetIncomeYTDFormatted, Mode=OneWay}"
                                       Style="{StaticResource KPIValueStyle}"
                                       Foreground="{x:Bind ViewModel.NetIncomeYTD, Mode=OneWay, Converter={StaticResource PositiveNegativeColorConverter}}" />
                            <FontIcon Glyph="&#xE8B5;" 
                                      FontSize="16"
                                      Margin="0,8,0,0" />
                        </StackPanel>
                    </Border>

                    <!-- A/R Balance Card -->
                    <Border x:Name="ARCard" Grid.Column="4" Style="{StaticResource KPICardStyle}">
                        <Border.RenderTransform>
                            <CompositeTransform />
                        </Border.RenderTransform>
                        <StackPanel>
                            <TextBlock Text="A/R BALANCE" Style="{StaticResource KPILabelStyle}" />
                            <TextBlock Text="{x:Bind ViewModel.AccountsReceivableFormatted, Mode=OneWay}"
                                       Style="{StaticResource KPIValueStyle}"
                                       Foreground="#007BFF" />
                            <FontIcon Glyph="&#xE7C5;" 
                                      FontSize="16"
                                      Foreground="#007BFF"
                                      Margin="0,8,0,0" />
                        </StackPanel>
                    </Border>

                    <!-- A/P Balance Card -->
                    <Border x:Name="APCard" Grid.Column="6" Style="{StaticResource KPICardStyle}">
                        <Border.RenderTransform>
                            <CompositeTransform />
                        </Border.RenderTransform>
                        <StackPanel>
                            <TextBlock Text="A/P BALANCE" Style="{StaticResource KPILabelStyle}" />
                            <TextBlock Text="{x:Bind ViewModel.AccountsPayableFormatted, Mode=OneWay}"
                                       Style="{StaticResource KPIValueStyle}"
                                       Foreground="#DC3545" />
                            <FontIcon Glyph="&#xE8F0;" 
                                      FontSize="16"
                                      Foreground="#DC3545"
                                      Margin="0,8,0,0" />
                        </StackPanel>
                    </Border>
                </Grid>

                <!-- Financial Data Grid -->
                <Border Grid.Row="3"
                        Margin="0,0,0,24"
                        Style="{StaticResource DashboardCardStyle}"
                        Visibility="{x:Bind ViewModel.HasData, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <syncfusion:SfDataGrid x:Name="FinancialDataGrid"
                                           ItemsSource="{x:Bind ViewModel.FinancialMetrics, Mode=OneWay}"
                                           AutoGenerateColumns="False"
                                           AllowSorting="True"
                                           AllowFiltering="True"
                                           AllowGrouping="True"
                                           SelectionMode="Single"
                                           GridLinesVisibility="Horizontal"
                                           HeaderRowHeight="50"
                                           RowHeight="45">
                        <syncfusion:SfDataGrid.Columns>
                            <syncfusion:GridTextColumn HeaderText="Category" MappingName="Category" Width="120" />
                            <syncfusion:GridTextColumn HeaderText="Metric" MappingName="Metric" Width="150" />
                            <syncfusion:GridNumericColumn HeaderText="Value" MappingName="Value" Width="120" DisplayBinding="{Binding FormattedValue}" />
                            <syncfusion:GridTemplateColumn HeaderText="Indicator" Width="80">
                                <syncfusion:GridTemplateColumn.CellTemplate>
                                    <DataTemplate>
                                        <FontIcon Glyph="{Binding Icon}" 
                                                  Foreground="{Binding Color, Converter={StaticResource ColorToBrushConverter}}" 
                                                  FontSize="16" />
                                    </DataTemplate>
                                </syncfusion:GridTemplateColumn.CellTemplate>
                            </syncfusion:GridTemplateColumn>
                        </syncfusion:SfDataGrid.Columns>
                    </syncfusion:SfDataGrid>
                </Border>

                <!-- Sync Buttons -->
                <Border Grid.Row="4"
                        Style="{StaticResource DashboardCardStyle}"
                        Visibility="{x:Bind ViewModel.IsConnected, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="16" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <!-- Sync Now Button -->
                        <Button Grid.Column="0"
                                Command="{x:Bind ViewModel.SyncNowCommand}"
                                HorizontalAlignment="Stretch"
                                Height="56"
                                FontSize="16"
                                FontWeight="SemiBold"
                                Style="{StaticResource AccentButtonStyle}">
                            <StackPanel Orientation="Horizontal" Spacing="12">
                                <FontIcon Glyph="&#xE895;" FontSize="20" />
                                <TextBlock Text="Sync Now" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>

                        <!-- Cancel Button (visible during sync) -->
                        <Button Grid.Column="2"
                                Content="Cancel"
                                Command="{x:Bind ViewModel.CancelCommand}"
                                Visibility="{x:Bind ViewModel.IsSyncing, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                Height="56"
                                MinWidth="120"
                                FontSize="16">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE711;" FontSize="16" />
                                <TextBlock Text="Cancel" VerticalAlignment="Center" />
                            </StackPanel>
                        </Button>
                    </Grid>
                </Border>

                <!-- Loading Overlay -->
                <Border Grid.Row="0" Grid.RowSpan="5"
                        Background="{ThemeResource LayerFillColorDefaultBrush}"
                        Opacity="0.95"
                        Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="16">
                        <ProgressRing IsActive="True" Width="60" Height="60" />
                        <TextBlock Text="Loading financial data..." 
                                   FontSize="16"
                                   HorizontalAlignment="Center"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}" />
                    </StackPanel>
                </Border>

                <!-- Empty State -->
                <Border Grid.Row="0" Grid.RowSpan="5"
                        Visibility="{x:Bind ViewModel.ShowEmptyState, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24" MaxWidth="500">
                        <FontIcon Glyph="&#xE74C;" FontSize="80" Foreground="{ThemeResource TextFillColorTertiaryBrush}" />
                        <TextBlock Text="No QuickBooks Data"
                                   FontSize="24"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="Connect to QuickBooks to view your financial dashboard and key metrics"
                                   FontSize="14"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   HorizontalAlignment="Center"
                                   TextAlignment="Center"
                                   TextWrapping="Wrap" />
                        <Button Content="Connect to QuickBooks"
                                Command="{x:Bind ViewModel.ConnectCommand}"
                                Style="{StaticResource AccentButtonStyle}"
                                HorizontalAlignment="Center"
                                Padding="24,12" />
                    </StackPanel>
                </Border>

                <!-- Error State -->
                <Border Grid.Row="0" Grid.RowSpan="5"
                        Background="{ThemeResource LayerFillColorDefaultBrush}"
                        Visibility="{x:Bind ViewModel.HasError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                    <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="24" MaxWidth="600">
                        <FontIcon Glyph="&#xE783;" FontSize="80" Foreground="#DC3545" />
                        <TextBlock Text="Error Loading Dashboard"
                                   FontSize="24"
                                   FontWeight="SemiBold"
                                   HorizontalAlignment="Center" />
                        <TextBlock Text="{x:Bind ViewModel.ErrorMessage, Mode=OneWay}"
                                   FontSize="14"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   TextWrapping="Wrap"
                                   HorizontalAlignment="Center"
                                   TextAlignment="Center" />
                        <Button Command="{x:Bind ViewModel.RetryCommand}"
                                Style="{StaticResource AccentButtonStyle}"
                                HorizontalAlignment="Center"
                                Padding="24,12">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE72C;" FontSize="16" />
                                <TextBlock Text="Retry" />
                            </StackPanel>
                        </Button>
                    </StackPanel>
                </Border>
            </Grid>
        </ScrollViewer>
    </Grid>
</UserControl>
