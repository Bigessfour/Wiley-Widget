version: "3.8"

services:
  wiley-widget-dev:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.csx-tests
    container_name: wiley-widget-csx-dev
    volumes:
      # Bind mounts for live development (read-only where possible)
      - ./scripts:/workspaces/Wiley_Widget/scripts:ro
      - ./src:/workspaces/Wiley_Widget/src:ro
      - ./logs:/workspaces/Wiley_Widget/logs:rw
      - ./test-logs:/workspaces/Wiley_Widget/test-logs:rw
      # Named volume for NuGet cache persistence
      - wiley-widget-nuget-cache:/tmp/csharp-mcp-packages
    environment:
      - WW_REPO_ROOT=/workspaces/Wiley_Widget
      - WW_LOGS_DIR=/workspaces/Wiley_Widget/logs
      - CSX_ALLOWED_PATH=/workspaces/Wiley_Widget
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
    working_dir: /workspaces/Wiley_Widget
    command: tail -f /dev/null # Keep container running
    networks:
      - wiley-widget-net
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"
    # Security enhancements
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    # Logging configuration with rotation
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    # Restart policy
    restart: unless-stopped
    # Stop timeout for graceful shutdown
    stop_grace_period: 30s
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "dotnet script --version && echo 'Container healthy'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Add a dedicated test runner service
  csx-test-runner:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.csx-tests
    container_name: wiley-widget-test-runner
    volumes:
      - ./scripts/examples/csharp:/app/tests:ro
      - ./logs:/app/logs:rw
      - ./test-logs:/app/test-logs:rw
      - wiley-widget-nuget-cache:/tmp/csharp-mcp-packages
    environment:
      - WW_REPO_ROOT=/app
      - WW_LOGS_DIR=/app/logs
      - CSX_ALLOWED_PATH=/app
    working_dir: /app/tests
    networks:
      - wiley-widget-net
    profiles:
      - testing
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
        reservations:
          memory: 128M
          cpus: "0.1"
    # Security enhancements
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    # Logging configuration with rotation
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    # Restart policy for testing
    restart: "no"
    # Stop timeout for graceful shutdown
    stop_grace_period: 15s
    # Health check for test runner
    healthcheck:
      test: ["CMD-SHELL", "dotnet script --version && echo 'Test runner healthy'"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s

volumes:
  wiley-widget-nuget-cache:
    driver: local

networks:
  wiley-widget-net:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: wiley-widget-bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    internal: false # Allow external access if needed for development
