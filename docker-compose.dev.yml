services:
  wiley-widget-dev:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.csx-tests
    container_name: wiley-widget-csx-dev
    volumes:
      # Bind mounts for live development (read-only where possible)
      - ./scripts:/workspaces/Wiley-Widget/scripts:ro
      - ./src:/workspaces/Wiley-Widget/src:ro
      - ./logs:/workspaces/Wiley-Widget/logs:rw
      - ./test-logs:/workspaces/Wiley-Widget/test-logs:rw
      # Named volume for NuGet cache persistence
      - wiley-widget-nuget-cache:/tmp/csharp-mcp-packages
    environment:
      - WW_REPO_ROOT=/workspaces/Wiley-Widget
      - WW_LOGS_DIR=/workspaces/Wiley-Widget/logs
      - CSX_ALLOWED_PATH=/workspaces/Wiley-Widget
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
    working_dir: /workspaces/Wiley-Widget
    command: tail -f /dev/null # Keep container running
    networks:
      - wiley-widget-net
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"
    # Security enhancements
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    # Logging configuration with rotation
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    # Restart policy
    restart: unless-stopped
    # Stop timeout for graceful shutdown
    stop_grace_period: 30s
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "dotnet script --version && echo 'Container healthy'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional: Add a dedicated test runner service
  csx-test-runner:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.csx-tests
    container_name: wiley-widget-test-runner
    volumes:
      - ./scripts/examples/csharp:/app/tests:ro
      - ./logs:/app/logs:rw
      - ./test-logs:/app/test-logs:rw
      - wiley-widget-nuget-cache:/tmp/csharp-mcp-packages
    environment:
      - WW_REPO_ROOT=/app
      - WW_LOGS_DIR=/app/logs
      - CSX_ALLOWED_PATH=/app
    working_dir: /app/tests
    networks:
      - wiley-widget-net
    profiles:
      - testing
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
        reservations:
          memory: 128M
          cpus: "0.1"
    # Security enhancements
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    # Logging configuration with rotation
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    # Restart policy for testing
    restart: "no"
    # Stop timeout for graceful shutdown
    stop_grace_period: 15s
    # Health check for test runner
    healthcheck:
      test: ["CMD-SHELL", "dotnet script --version && echo 'Test runner healthy'"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s

  # Unit Test Runner Service (Uno-compatible, Linux containers)
  unit-test-runner:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.tests
    container_name: wiley-widget-unit-tests
    volumes:
      - .:/src:rw
      - ./TestResults:/src/TestResults:rw
      # Optional: mount host NuGet packages to avoid permission issues and reuse cache
      # On Windows PowerShell, Docker Compose expands ${USERPROFILE}; uncomment to use your local cache:
      # - ${USERPROFILE}/.nuget/packages:/root/.nuget/packages:rw
      - wiley-widget-nuget-cache:/tmp/nuget
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
      - DOTNET_EnableWindowsTargeting=true
    working_dir: /src
    networks:
      - wiley-widget-net
    profiles:
      - testing
    # Resource limits for testing
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
          cpus: "0.5"
    # Security enhancements
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false # Need write access for test results
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    # Logging
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: "3"
    # No restart for test runs
    restart: no
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "dotnet --version && echo 'Test runner healthy'"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s

  # Uno Platform Build & Test Service (Linux containers)
  uno-build-tester:
    image: mcr.microsoft.com/dotnet/sdk:9.0
    container_name: wiley-widget-uno-builder
    volumes:
      - .:/workspace:rw
      - ./TestResults:/workspace/TestResults:rw
      - wiley-widget-nuget-cache:/root/.nuget/packages
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
      - DOTNET_EnableWindowsTargeting=true
    working_dir: /workspace
    command: >
      bash -c "
        echo '=== Uno Platform Build & Test ===' &&
        dotnet restore WileyWidget.sln /p:EnableWindowsTargeting=true &&
        echo 'Building Uno project...' &&
        dotnet build src/WileyWidget.Uno/WileyWidget.Uno.csproj --configuration Release --verbosity minimal /p:EnableWindowsTargeting=true &&
        echo 'Running Uno tests...' &&
        dotnet test WileyWidget.sln --filter 'WileyWidget.Uno' --configuration Release --verbosity normal --logger trx --results-directory TestResults --collect:'XPlat Code Coverage' &&
        echo 'Uno build and tests completed'
      "
    networks:
      - wiley-widget-net
    profiles:
      - uno-testing
    # Higher resource limits for builds
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 1G
          cpus: "1.0"
    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    # Logging
    logging:
      driver: json-file
      options:
        max-size: 20m
        max-file: "5"
    restart: no
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "dotnet --version && echo 'Uno builder healthy'"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s

  # WinUI Validation Service (Windows containers - requires Windows host)
  winui-validator:
    build:
      context: .
      dockerfile: ./docker/Dockerfile.winui-tests # To be created
    container_name: wiley-widget-winui-validator
    volumes:
      - .:C:\\workspace:rw
      - wiley-widget-nuget-cache:C:\\nuget-cache:rw
    environment:
      - DOTNET_CLI_TELEMETRY_OPTOUT=1
      - DOTNET_NOLOGO=1
    working_dir: C:\\workspace
    command: >
      powershell -Command "
        Write-Host '=== WinUI Validation ===';
        dotnet restore WileyWidget.sln;
        Write-Host 'Building WinUI project...';
        dotnet build src/WileyWidget.WinUI/WileyWidget.WinUI.csproj --configuration Release --verbosity minimal;
        Write-Host 'Running WinUI tests...';
        dotnet test WileyWidget.sln --filter 'WileyWidget.WinUI' --configuration Release --verbosity normal --logger trx --results-directory TestResults --collect:'XPlat Code Coverage';
        Write-Host 'WinUI validation completed'
      "
    networks:
      - wiley-widget-net
    profiles:
      - winui-testing
    # Platform specification for Windows containers
    platform: windows
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2.0"
        reservations:
          memory: 1G
          cpus: "1.0"
    # Security (limited on Windows)
    read_only: false
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    # Logging
    logging:
      driver: json-file
      options:
        max-size: 20m
        max-file: 5
    restart: no
    # Health check
    healthcheck:
      test: ["CMD", "dotnet", "--version"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s

  # Python Validation Service
  python-validator:
    image: python:3.10-slim
    container_name: wiley-widget-python-validator
    volumes:
      - .:/workspace:ro
      - ./logs:/workspace/logs:rw
    working_dir: /workspace
    command: >
      bash -c "
        echo '=== Python Validation ===' &&
        pip install --upgrade pip &&
        pip install -r requirements.txt &&
        echo 'Running startup validator...' &&
        python tests/test_startup_validator.py &&
        echo 'Running CSX file tests...' &&
        python test_csx_files.py &&
        echo 'Python validation completed'
      "
    networks:
      - wiley-widget-net
    profiles:
      - python-validation
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
          cpus: "0.25"
    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m
    # Logging
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
    restart: no
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "python --version && echo 'Python validator healthy'"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s

  # Quality Assurance Service (Trunk CLI)
  quality-assurance:
    image: trunkio/trunk:latest
    container_name: wiley-widget-qa
    volumes:
      - .:/workspace:ro
      - ./logs:/workspace/logs:rw
    working_dir: /workspace
    command: >
      bash -c "
        echo '=== Quality Assurance ===' &&
        trunk check --ci --upload --series=local-docker --filter=gitleaks,trufflehog,osv-scanner,dotnet-format,psscriptanalyzer &&
        echo 'Quality checks completed'
      "
    networks:
      - wiley-widget-net
    profiles:
      - qa
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
          cpus: "0.5"
    # Security
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    # Logging
    logging:
      driver: json-file
      options:
        max-size: 10m
        max-file: 3
    restart: no
    # Health check
    healthcheck:
      test: ["CMD-SHELL", "trunk --version && echo 'QA service healthy'"]
      interval: 60s
      timeout: 10s
      retries: 2
      start_period: 30s

  otelcol:
    image: otel/opentelemetry-collector-contrib:0.71.0
    container_name: wiley-widget-otelcol
    volumes:
      - ./docker/otel-config.yaml:/etc/otelcol-contrib/config.yaml:ro
    ports:
      - "4317:4317"
      - "4318:4318"
      - "8888:8888"
    networks:
      - wiley-widget-net
    restart: no
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8888/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  jaeger:
    image: jaegertracing/all-in-one:1.41
    container_name: wiley-widget-jaeger
    ports:
      - "16686:16686" # Jaeger UI
      - "14268:14268" # Jaeger HTTP collector (thrift over HTTP)
      - "14250:14250" # Jaeger gRPC (optional)
    networks:
      - wiley-widget-net
    restart: no

volumes:
  wiley-widget-nuget-cache:
    driver: local

networks:
  wiley-widget-net:
    driver: bridge
    internal: false # Allow external access if needed for development
