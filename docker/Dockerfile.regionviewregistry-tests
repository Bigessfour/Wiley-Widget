# Dockerfile for running RegionViewRegistry xUnit tests in isolation
# Based on .NET 9.0 SDK with WPF support

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build

# Install required dependencies for WPF testing
RUN apt-get update && apt-get install -y \
    libx11-6=2:1.8.4-2+deb12u2 \
    libx11-xcb1=2:1.8.4-2+deb12u2 \
    libxcb1=1.15-1 \
    libxrender1=1:0.9.10-1.1 \
    libxrandr2=2:1.5.2-2+b1 \
    libxi6=2:1.8-1+b1 \
    libxext6=2:1.3.4-1+b1 \
    libxfixes3=1:6.0.0-2 \
    libxcursor1=1:1.2.1-1 \
    libxcomposite1=1:0.4.5-1 \
    libxdamage1=1:1.1.6-1 \
    libfontconfig1=2.14.1-4 \
    libcairo2=1.16.0-7 \
    libcups2=2.4.2-3+deb12u5 \
    libdbus-1-3=1.14.10-1~deb12u1 \
    libexpat1=2.5.0-1 \
    libffi8=3.4.4-1 \
    libgcc1=1:12.2.0-14 \
    libglib2.0-0=2.74.6-2 \
    libgpg-error0=1.46-1 \
    libice6=2:1.0.10-1 \
    libsm6=2:1.2.3-1 \
    libpcre3=2:8.39-15 \
    libstdc++6=12.2.0-14 \
    libuuid1=2.38.1-5+b1 \
    libx11-xcb1=2:1.8.4-2+deb12u2 \
    libxau6=1:1.0.9-1 \
    libxcb1=1.15-1 \
    libxdmcp6=1:1.1.3-1 \
    zlib1g=1:1.2.13.dfsg-1 \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /src

# Copy solution and project files for dependency resolution
COPY ["WileyWidget.sln", "./"]
COPY ["WileyWidget.csproj", "./"]
COPY ["WileyWidget.Tests/WileyWidget.Tests.csproj", "WileyWidget.Tests/"]
COPY ["WileyWidget.Models/WileyWidget.Models.csproj", "WileyWidget.Models/"]
COPY ["WileyWidget.Business/WileyWidget.Business.csproj", "WileyWidget.Business/"]
COPY ["Directory.Build.props", "./"]
COPY ["Directory.Build.targets", "./"]
COPY ["Directory.Packages.props", "./"]

# Restore dependencies
RUN dotnet restore "WileyWidget.Tests/WileyWidget.Tests.csproj" \
    --runtime linux-x64 \
    --verbosity normal

# Copy the entire test project source
COPY ["WileyWidget.Tests/", "WileyWidget.Tests/"]
COPY ["WileyWidget.Models/", "WileyWidget.Models/"]
COPY ["WileyWidget.Business/", "WileyWidget.Business/"]

# Copy required source files (minimal set for test compilation)
COPY ["src/", "src/"]

# Build the test project
RUN dotnet build "WileyWidget.Tests/WileyWidget.Tests.csproj" \
    --configuration Release \
    --no-restore \
    --verbosity normal

# Run specific RegionViewRegistry tests
FROM build AS test
WORKDIR /src/WileyWidget.Tests

# Set environment variables for headless testing
ENV DOTNET_SYSTEM_GLOBALIZATION_INVARIANT=1
ENV DISPLAY=:99

# Run only RegionViewRegistry tests with detailed output
ENTRYPOINT ["dotnet", "test", \
    "WileyWidget.Tests.csproj", \
    "--configuration", "Release", \
    "--no-build", \
    "--no-restore", \
    "--logger", "console;verbosity=detailed", \
    "--filter", "FullyQualifiedName~RegionViewRegistryTests", \
    "--results-directory", "/testresults", \
    "--collect", "XPlat Code Coverage"]

# Optional: Create a stage for running tests with volume mounting
FROM build AS test-volume
WORKDIR /src

# This allows mounting the test project from host for iterative development
# Usage: docker run -v $(pwd)/WileyWidget.Tests:/src/WileyWidget.Tests test-volume
ENTRYPOINT ["dotnet", "test", \
    "WileyWidget.Tests/WileyWidget.Tests.csproj", \
    "--configuration", "Release", \
    "--logger", "console;verbosity=detailed", \
    "--filter", "FullyQualifiedName~RegionViewRegistryTests", \
    "--results-directory", "/testresults"]
