# docker/Dockerfile.csx-tests
FROM mcr.microsoft.com/dotnet/sdk:9.0 AS base

# === Environment ===
ARG DOTNET_CLI_TELEMETRY_OPTOUT=1
ARG DOTNET_NOLOGO=1
ENV DOTNET_CLI_TELEMETRY_OPTOUT=${DOTNET_CLI_TELEMETRY_OPTOUT}
ENV DOTNET_NOLOGO=${DOTNET_NOLOGO}
ENV PATH="$PATH:/root/.dotnet/tools"

WORKDIR /app

# === Install Docker CLI for Docker-from-Docker support ===
RUN apt-get update && apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg \
    lsb-release \
    && curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null \
    && apt-get update \
    && apt-get install -y docker-ce-cli \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# === Install dotnet-script (cached layer) ===
RUN dotnet tool install -g dotnet-script \
    && dotnet nuget locals all --clear \
    && chmod -R a+rx /root/.dotnet/tools

# === Pre-cache common NuGet packages for CSX tests ===
# Set the NuGet package cache directory for optimal caching
ENV NUGET_PACKAGES=/tmp/csharp-mcp-packages

# Create temporary project to restore common packages used in CSX tests
RUN dotnet new console -n TempCacheProject && \
    cd TempCacheProject && \
    # Add Microsoft.Extensions packages commonly used in WileyWidget CSX tests \
    dotnet add package Microsoft.Extensions.DependencyInjection --version 9.0.10 && \
    dotnet add package Microsoft.Extensions.Configuration --version 9.0.10 && \
    dotnet add package Microsoft.Extensions.Hosting --version 9.0.10 && \
    dotnet add package Microsoft.Extensions.Logging --version 9.0.10 && \
    dotnet add package Microsoft.Extensions.Logging.Abstractions --version 9.0.10 && \
    # Add Entity Framework Core packages for DbContext tests \
    dotnet add package Microsoft.EntityFrameworkCore --version 9.0.10 && \
    dotnet add package Microsoft.EntityFrameworkCore.SqlServer --version 9.0.10 && \
    dotnet add package Microsoft.EntityFrameworkCore.InMemory --version 9.0.10 && \
    # Add Prism and DryIoc packages for DI registration tests \
    dotnet add package Prism.Container.DryIoc --version 9.0.107 && \
    dotnet add package Prism.Core --version 9.0.537 && \
    dotnet add package Prism.DryIoc --version 9.0.537 && \
    dotnet add package DryIoc --version 5.4.3 && \
    # Add testing frameworks \
    dotnet add package Xunit --version 2.4.2 && \
    dotnet add package Moq --version 4.20.72 && \
    dotnet add package FluentAssertions --version 6.12.0 && \
    # Add logging and serialization packages \
    dotnet add package Serilog --version 4.2.0 && \
    dotnet add package Serilog.Sinks.Console --version 6.0.0 && \
    dotnet add package Newtonsoft.Json --version 13.0.3 && \
    dotnet add package System.Text.Json --version 9.0.10 && \
    # Add system packages for regex and process management \
    dotnet add package System.Text.RegularExpressions --version 4.3.1 && \
    dotnet add package System.Diagnostics.Process --version 4.3.0 && \
    # Restore all packages to cache them \
    dotnet restore && \
    # Clean up temporary project but keep cached packages \
    cd .. && rm -rf TempCacheProject

# Verify cache directory exists and has packages
RUN ls -la /tmp/csharp-mcp-packages && echo "NuGet cache populated successfully"

# === Runtime Stage ===
FROM base AS runtime

# Create non-root user for better security
RUN groupadd -r csxuser && useradd -r -g csxuser csxuser \
    && mkdir -p /home/csxuser/.dotnet/tools \
    && cp -r /root/.dotnet /home/csxuser/ \
    && chown -R csxuser:csxuser /home/csxuser \
    && chown -R csxuser:csxuser /tmp/csharp-mcp-packages

# Switch to non-root user
USER csxuser
WORKDIR /home/csxuser

ENV PATH="$PATH:/home/csxuser/.dotnet/tools"

# Copy nothing â€” use volume mounts
VOLUME ["/app", "/src"]

# Health check - verify dotnet-script is available and functional
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD dotnet script --version && echo "dotnet-script is healthy" || exit 1

# Flexible entrypoint
ENTRYPOINT ["/home/csxuser/.dotnet/tools/dotnet-script"]
CMD ["--help"]
