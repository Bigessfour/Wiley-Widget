# SigNoz Self-Hosted Setup for Wiley Widget
# Free, open-source observability platform
# https://signoz.io/docs/install/docker/

services:
  # ClickHouse for storing telemetry data
  clickhouse:
    image: clickhouse/clickhouse-server:23.7-alpine
    container_name: signoz-clickhouse
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1.0"
        reservations:
          memory: 512M
    environment:
      - CLICKHOUSE_DB=signoz
      - CLICKHOUSE_USER=signoz
      - CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT=1
      - CLICKHOUSE_PASSWORD=signoz
    ports:
      - "9000:9000"
      - "8123:8123"
    volumes:
      - clickhouse-data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD", "clickhouse-client", "--query", "SELECT 1"]
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

  # OpenTelemetry Collector
  otel-collector:
    image: signoz/signoz-otel-collector:0.88.11
    container_name: signoz-otel-collector
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: 0.5
        reservations:
          memory: 256M
    ports:
      - "4317:4317" # OTLP gRPC receiver
      - "4318:4318" # OTLP HTTP receiver
      - "8888:8888" # Prometheus metrics
      - "8889:8889" # Prometheus metrics
    volumes:
      - ./config/otel-collector-config.yaml:/etc/otel-collector-config.yaml:ro
    command:
      - --config=/etc/otel-collector-config.yaml
    depends_on:
      clickhouse:
        condition: service_healthy
    environment:
      - OTEL_RESOURCE_ATTRIBUTES=service.name=signoz-otel-collector,service.version=0.88.7

  # SigNoz Query Service
  query-service:
    image: signoz/query-service:0.39.0
    container_name: signoz-query-service
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"
        reservations:
          memory: 256M
    ports:
      - "8080:8080"
    volumes:
      - query-service-data:/var/lib/signoz
    environment:
      - ClickHouseUrl=tcp://clickhouse:9000?username=default&password=
      - STORAGE=clickhouse
      - GODEBUG=netdns=go
      - TELEMETRY_ENABLED=true
      - DEPLOYMENT_TYPE=docker-standalone-amd
    depends_on:
      clickhouse:
        condition: service_healthy
    healthcheck:
      test:
        - CMD-SHELL
        - "wget --no-verbose --tries=1 --spider http://localhost:8080/api/v1/version || exit 1"
      interval: 30s
      timeout: 10s
      retries: 3

  # SigNoz Frontend
  frontend:
    image: signoz/frontend:0.39.0
    container_name: signoz-frontend
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
        reservations:
          memory: 128M
    ports:
      - "3301:3301"
    environment:
      - FRONTEND_API_ENDPOINT=http://query-service:8080
    depends_on:
      query-service:
        condition: service_healthy
    healthcheck:
      test:
        - CMD-SHELL
        - "wget --no-verbose --tries=1 --spider http://localhost:3301 || exit 1"
      interval: 30s
      timeout: 10s
      retries: 3

  # SigNoz Alertmanager - DISABLED (image not available)
  # alertmanager:
  #   image: signoz/alertmanager:0.39.0
  #   container_name: signoz-alertmanager
  #   restart: unless-stopped
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 256M
  #         cpus: "0.25"
  #       reservations:
  #         memory: 128M
  #   ports:
  #     - "9093:9093"
  #   volumes:
  #     - alertmanager-data:/data
  #   command:
  #     - --queryService.url=http://query-service:8080
  #     - --storage.path=/data
  #   depends_on:
  #     query-service:
  #       condition: service_healthy

volumes:
  clickhouse-data:
    driver: local
  query-service-data:
    driver: local
  alertmanager-data:
    driver: local

networks:
  default:
    name: signoz
    driver: bridge
