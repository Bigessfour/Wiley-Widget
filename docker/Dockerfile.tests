# Dockerfile for Test Runner
# Runs xUnit tests with code coverage in Docker

FROM mcr.microsoft.com/dotnet/sdk:9.0
WORKDIR /src

# Install coverage tools
RUN dotnet tool install --global dotnet-coverage
ENV PATH="${PATH}:/root/.dotnet/tools"

# Copy solution and restore
COPY WileyWidget.sln .
COPY Directory.Build.props .
COPY Directory.Build.targets .
COPY Directory.Packages.props .
COPY global.json .
COPY NuGet.config .

# Copy all source and test projects
COPY src/ src/
COPY test/ test/

# Restore all projects
RUN dotnet restore WileyWidget.sln

# Create a non-root user for security
RUN useradd -m testuser
USER testuser

# Health check to ensure the container is operational
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD dotnet --version || exit 1

# Default command runs all tests with coverage
CMD ["dotnet", "test", "WileyWidget.sln", \
     "--collect:XPlat Code Coverage", \
     "--results-directory:/src/coverage", \
     "--logger:trx", \
     "--logger:console;verbosity=detailed"]
