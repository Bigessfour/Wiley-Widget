version: "3.9"

services:
  # ──────────────────────────────────────────────────────────────
  # 1. SQL Server 2022 (EF Core backend)
  # ──────────────────────────────────────────────────────────────
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: WILEY_DB
    environment:
      SA_PASSWORD: "WileyWidget!2025" # Override with secrets in production
      ACCEPT_EULA: "Y"
      MSSQL_PID: "Express"
    ports:
      - "127.0.0.1:1433:1433" # Bind to localhost only for security
    healthcheck:
      test:
        [
          "CMD",
          "/opt/mssql-tools18/bin/sqlcmd",
          "-U",
          "sa",
          "-P",
          "WileyWidget!2025",
          "-Q",
          "SELECT 1",
          "-b",
          "-o",
          "/dev/null",
        ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s
    volumes:
      - db-data:/var/opt/mssql
    networks:
      - wiley-net
    # Resource limits for development
    deploy:
      resources:
        limits:
          memory: 2g
          cpus: "1.0"
        reservations:
          memory: 1g
          cpus: "0.5"
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

  # ──────────────────────────────────────────────────────────────
  # 2. Wiley Widget WinUI App (dev server)
  # ──────────────────────────────────────────────────────────────
  app:
    build:
      context: .
      dockerfile: src/WileyWidget.WinUI/Dockerfile
    container_name: WILEY_APP
    depends_on:
      db:
        condition: service_healthy
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ConnectionStrings__DefaultConnection=Server=db;Database=WileyWidget;User Id=sa;Password=WileyWidget!2025;TrustServerCertificate=true;
      - DOTNET_USE_POLLING_FILE_WATCHER=true
    ports:
      - "127.0.0.1:5000:8080" # HTTP (bind to localhost)
    volumes:
      - .:/src
      - ~/.nuget/packages:/root/.nuget/packages:ro
    command: >
      sh -c "
        dotnet restore WileyWidget.sln &&
        dotnet run --project src/WileyWidget.WinUI/WileyWidget.WinUI.csproj --no-restore
      "
    networks:
      - wiley-net
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "0.5"
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: unless-stopped

  # ──────────────────────────────────────────────────────────────
  # 3. Test Runner (unit + integration)
  # ──────────────────────────────────────────────────────────────
  test:
    build:
      context: .
      dockerfile: docker/Dockerfile.tests
    container_name: WILEY_TEST
    depends_on:
      db:
        condition: service_healthy
    environment:
      - ConnectionStrings__DefaultConnection=Server=db;Database=WileyWidget;User Id=sa;Password=WileyWidget!2025;TrustServerCertificate=true;
      - DOTNET_ENVIRONMENT=Test
    volumes:
      - .:/src
      - ./coverage:/src/coverage:rw
    command: >
      sh -c "
        dotnet test WileyWidget.sln \
          --collect:\"XPlat Code Coverage\" \
          --results-directory:/src/coverage \
          --filter \"Category!=UI\" \
          --logger \"trx;LogFileName=/src/coverage/results.trx\" \
          --logger \"console;verbosity=detailed\" ||
        (echo 'TESTS FAILED' && exit 1)
      "
    networks:
      - wiley-net
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "0.5"
    # Logging configuration
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    restart: "no" # Don't auto-restart tests

  # ──────────────────────────────────────────────────────────────
  # 4. UI Smoke Test (Playwright + WinAppDriver)
  # ──────────────────────────────────────────────────────────────
  ui-test:
    image: mcr.microsoft.com/playwright:v1.48.0-focal
    container_name: WILEY_UI_TEST
    depends_on:
      - app
    volumes:
      - .:/src:ro
      - ./test-results:/src/test-results:rw
    working_dir: /src
    command: >
      sh -c "
        npx playwright test --project=winui --reporter=html
      "
    networks:
      - wiley-net

# ──────────────────────────────────────────────────────────────
# Volumes & Networks
# ──────────────────────────────────────────────────────────────
volumes:
  db-data:
    driver: local

networks:
  wiley-net:
    driver: bridge
